<?php 
//                ___   _   _   ___  _     ___  _ _
//               / __| / \ | | |   \| |   |   \| / /
//               \__ \/ _ \| |_| |) | | _ | |) |  <
//               |___/_/ \_|___|___/|_||_||___/|_\_\
//
// --- finans/kassekladde.php --- ver 4.1.1 --- 2026-01-19 ---
// LICENSE
//
// This program is free software. You can redistribute it and / or
// modify it under the terms of the GNU General Public License (GPL)
// which is published by The Free Software Foundation; either in version 2
// of this license or later version of your choice.
// However, respect the following:
//
// It is forbidden to use this program in competition with Saldi.DK ApS
// or other proprietor of the program without prior written agreement.
//
// The program is published with the hope that it will be beneficial,
// but WITHOUT ANY KIND OF CLAIM OR WARRANTY.
// See GNU General Public License for more details.
//
// Copyright (c) 2003-2026 Saldi.dk ApS
// ----------------------------------------------------------------------

// 20120809 søg 20120809 V. openpostopslag viser både kreditorer og debitorer hvis de har samme kontonr - rettet 
// 20120806 søg 20120806
// 20121110 søg 20121110
// 20130221 søg 20130221
// 20130404 addslashes erstattet af db_escape_string
// 20130731 db_escape_string fjernet 2 steder da den bruges senere på samme streng og fordoblede "'" ved hver gem.
// 20131101 Fravalg for tjek af forskellige datoer.Søg: $forskellige_datoer
// 20131216	Flyttet javascript og ned til de øvrige scripts og fjernet fejltastet "f"
// 20140624 Flyttet opslag efter im betalings_id skal vises over $_POST så den også er med når kladden åbnes. Søg 20140624
// 20140624 Indsat $gl_transdate[$x] Søg 20140624
// 20140601 Tilføjet intern_bilag - Søg intern_bilag.
// 20140709 Et cfirede kontonumre blev set som genvejstast og gav fejl.Søg "!is_numeric"   
// 20140718 Indsat db_escape_string i beskrivelse for 'tilbagefør' Søg 20140718 
// 20141106	Clips vises ikke før der er et kladde id 20141106
// 20150105 db_escape_string på kladdenote 20150105
// 20150105 Fejltjek på bilagsnummer v. kopier til ny 20150105-2
// 20150120 Saldo vises ved kontopslag i funktion finansopslag. 
// 20150521 Indsat begrænsning på antal bilag der kan tilføjes #20150521
// 20151210 Indført brug af piletaster ctrl-pil - søg formnavi
// 20151210	Kontrol for dubletposteringer. Søg dublet & $dub
// 20170321 Forbedring af søgning ved opslag således at finans, debitor & kreditorkonto lister de konto hvor teksten indgår.
// 20170418 Tilføjet '&& !$faktura[$x]' så der kan laves opslag på falturanr samt ($submit!='Opslag' &&) så der kan laves opslag uden feltindhold. 20170418
// 20170419 Det autogenererede bilagsnr blev stående hvis nederste linje blev slettet.
// 20171129 Bilagsnummer manglede ved import når der var oprette kladdelinjer Søg 20171129
// 20180618 Tilføjet "Vend fortegn" ved 'kopier til ny' Søg $vend_fortegn
// 20181118	Definition af variabler.
// 20190116 MSC - Rettet topdesign til for kopir kassekladde.
// 20190131 MSC - Rettet topmenu design til.
// 20190201 MSC - Rettet isset fejl
// 20190105 MSC - Rettet topmenu design til og rettet isset fejl
// 20190206 MSC - Rettet isset fejl
// 20190213 MSC - Rettet isset fejl
// 20190312 MSC - Rettet isset fejl
// 20190503 PHR	- Corrected error in name lookup as Company names with Danish Chars were not found. 20190503
// 20190605 PHR - Error in call to jquery-1.10.2.min.js. Thanks to Rune Grysbæk, RGProducts 
// 20190625 PHR	- +x after annex no. added twice the number wanted. 20190625
// 20190830 PHR - function 'kopier til ny'. d_type & k_type was not switched when using 'Vend fortegn'. 
// 20191124 PHR - function 'kopier til ny'. d_type & k_type was, by mistake, multiplied by 1.
// 20210211 PHR - Some cleanup
// 20210628 LOE - Did some text translations.
// 20210720 LOE - Did translations on title tags and alert texts
// 20210721 LOE - Did translations on $submit buttons
// 20210920 PHR - Autogenerated line was not removed when above lines balanced
// 20221018 PHR - Changed name='submit' to a more meaningfull name and set $submit to whatever is submitted.
// 20230302 CA  - PHP8 short cut to delete lines in daily journals
// 20230322 CA  - Showing a control accout balance is now depending on the actual financial transactions
// 20230627 PHR - Improvement of text display for financial accounts
// 20230707 LOE - Added modifications for handling kassekladde attachments
// 20230710	LOE - Some updates
// 20230720 CA  - Corrected error so balance adding from primo amount when showing control account balance
// 20230724 LOE - Some modifications + 20230727
// 20230806 LOE - Enables attachment's buttons to be visible when kasselade_id already exists
// 20230822 MSC - Copied and pasted new design code into this file
// 20231023 PHR - Added 'saldo' from bank	statement
// 20240112 LOE - Worked on drag and drop functionality for for pdf file/(now moved to documents file).
// 20240115 LOE - CSS for the drag & drop func. moved to a separate file
// 20240329 PHR - Alert when clicking clip, if not saved
// 20240331 PHR - Prevent deletion of line if document attached
// 20240401 PHR - Removed reset of '$kontrolsaldo' Why was it there?
// 20240419	PHR - Corrected error in currency (valuta) 
// 20240523	PHR - changed [$i] to [0] 
// 20240529 PHR - changed 'if ($saldo[$y])' to 'if (abs($saldo[$y]) > 0)' as 0.00 was used as saldo
// 20240725 PHR - Replaced 'DKK' with $baseCurrency.
// 20240804	PHR - Removed (float) from belob
// 20240807 PHR	- Minor correction.
// 20250204 PBLM - Fixed a bug where the wrong variable were used when using the lookup functions
// 20250528 Sawaneh -  Added position-based sorting to kassekladde entries
// 20251022 LOE - Updated some variables to use the  function if_isset() to minimize errors
// 20251024 LOE - Static Headers, footer and pagination applied.
ob_start(); //Starter output buffering

@session_start();
$s_id = session_id();
$title = "Kassekladde"; 
$modulnr = 2;
$css = "../css/standard.css";
$afd = $amount = $ansat = $ansat_id = $belob = $beskrivelse = $betal_id = $bilag = $dato = $d_type = $debet = array();
$faktura = $forfaldsdate = $forfaldsdato = $id = $k_type = $kontonr = $kredit = $lobenr = $momsfri = $projekt = $valuta = array();

$antal_ex = NULL;
$belob_ligslut = $belob_ligstart = $beskrivelse_ligslut = NULL;
$beskrivelse_ligstart = $bogfort = NULL;
$dato_ligslut = $dato_ligstart = $debet_ligslut = $debet_ligstart = $d_type_ligslut = $d_type_ligstart = NULL;
$faktura_ligstart = $faktura_ligslut = $find = $fokus = NULL;
$intern_bilag = NULL;
$k_type_ligslut = $k_type_ligstart = NULL;
$kredit_ligslut = $kredit_ligstart = $kladde_id = $kladdenote = $kontrolkonto = $regnstart = NULL;
$lukket = $linjebg = $opslag_id = NULL;
$restlig = NULL;
$simuler = $sletrest = $sletstart = $sletslut = $submit = NULL;
$vis_afd = $vis_ansat = $vis_bet_liste = $vis_forfald = $vis_projekt = $vis_valuta = NULL;
$control_bal_fetched = FALSE;
$control_bal_last = $control_next_date = $control_record_daet = $titletxt = NULL;
$fejl = $kontrolsaldo = $kontrolsum = $x = $y = 0;


if (!isset($kontrolmoms))
	$kontrolmoms = NULL;
if (!isset($dub_bilag))
	$dub_bilag = NULL;
if (!isset($a))
	$a = NULL;
if (!isset($b))
	$b = NULL;
if (!isset($c))
	$c = NULL;


include("../includes/connect.php");
include("../includes/online.php");
include("../includes/std_func.php");
include("../includes/forfaldsdag.php");
include("../includes/topline_settings.php");
include("../includes/row-hover-style.js.php");

include("../includes/grid.php");

print '<script src="../javascript/jquery-3.6.4.min.js"></script>';
print '<link rel="stylesheet" type="text/css" href="../css/datepickerDa.css">';
print "<script LANGUAGE=\"JavaScript\" SRC=\"../javascript/moment.min.js\"></script>";
print "<script LANGUAGE=\"JavaScript\" SRC=\"../javascript/daterangepicker.min.js\" defer></script>";
print '<link rel="stylesheet" type="text/css" href="../css/daterangepicker.css" />';




$langId = !empty($sprog_id) ? intval($sprog_id) : 1;
print '<script>
window.saldiLanguage = ' . $langId . ';
window.saldiTranslations = {
    selectAccount: "' . findtekst('586', $langId) . ' ' . findtekst('592', $langId) . '",
    selectDebtor: "' . findtekst('586', $langId) . ' Debitor",
    selectCreditor: "' . findtekst('586', $langId) . ' Kreditor",
    selectDepartment: "' . findtekst('586', $langId) . ' ' . findtekst('274', $langId) . '",
    selectEmployee: "' . findtekst('586', $langId) . ' Medarbejder",
    selectCurrency: "' . findtekst('586', $langId) . ' ' . findtekst('776', $langId) . '",
    selectAmount: "' . findtekst('586', $langId) . ' ' . findtekst('934', $langId) . '",
    openItems: "Åbne Poster",
    close: "' . findtekst('2172', $langId) . '",
    search: "' . findtekst('913', $langId) . '...",
    searchAccount: "' . findtekst('913', $langId) . ' ' . strtolower(findtekst('43', $langId)) . ' / ' . strtolower(findtekst('914', $langId)) . '...",
    searchInvoice: "' . findtekst('913', $langId) . ' ' . strtolower(findtekst('643', $langId)) . ' / ' . strtolower(findtekst('138', $langId)) . '...",
    noResults: "Ingen resultater",
    code: "Kode",
    description: "' . findtekst('914', $langId) . '",
    initials: "' . findtekst('647', $langId) . '",
    name: "' . findtekst('138', $langId) . '",
    companyName: "' . findtekst('28', $langId) . '",
    accountNo: "' . findtekst('43', $langId) . '",
    invoiceNo: "' . findtekst('643', $langId) . '",
    date: "' . findtekst('635', $langId) . '",
    amount: "' . findtekst('934', $langId) . '",
    vat: "' . findtekst('770', $langId) . '",
    shortcut: "' . findtekst('1191', $langId) . '",
    balance: "Saldo",
    showing: "Viser",
    of: "af",
    previous: "' . findtekst('2598', $langId) . '",
    next: "' . findtekst('1200', $langId) . '",
    today: "' . findtekst('2773', $langId) . '",
    week: "' . findtekst('2669', $langId) . '"
};
</script>';
print '<script src="../javascript/datepickerDa.js"></script>';
print "<script LANGUAGE='javascript' TYPE='text/javascript' SRC='../javascript/confirmclose.js'></script>";
print "<script LANGUAGE='JavaScript' TYPE='text/javascript' SRC='../javascript/overlib.js'></script>";
print '<link rel="stylesheet" type="text/css" href="../css/accountAutocomplete.css">';
print '<script src="../javascript/accountAutocomplete.js" defer></script>';
print "<script>
	function fokuser(that, fgcolor, bgcolor){
		that.style.color = fgcolor;
		that.style.backgroundColor = bgcolor;
		document.forms[0].fokus.value=that.name; 
	}
		function defokuser(that, fgcolor, bgcolor){
		that.style.color = fgcolor;
		that.style.backgroundColor = bgcolor; 
	}
</script>";
print '<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>';
include("kassekladde_includes/moveButton.php");
include("kassekladde_includes/moveButtonStyle.php");
########################

// Handle AJAX duplicate line request
if (
    $_SERVER['REQUEST_METHOD'] === 'POST'
    && isset($_POST['action'])
    && $_POST['action'] === 'duplicate_line'
) {
   include("kassekladde_includes/duplicate_line.php");
}


#######################
$page_display = true;
if (!isset($tidspkt))
	$tidspkt = 0;
if (!isset($row['tidspkt']))
	$row['tidspkt'] = null;

$visipop = if_isset($_GET['visipop']);
$udskriv = if_isset($_GET['udskriv']);
if ($tjek = if_isset($_GET['tjek'])) {
	$tidspkt = microtime();
	list($a, $b) = explode(" ", $tidspkt);
	$qtxt = "select bogfort,tidspkt,hvem from kladdeliste where (bogfort = '-' or bogfort = 'S') and id = $tjek";
	$query = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	$row = db_fetch_array($query);
	if (isset($row['tidspkt'])) {
		list($a, $c) = explode(" ", $row['tidspkt']);
		if (($b - $c < 3600) && ($row['hvem'] != $brugernavn)) {
			$alert1 = findtekst('1577|Kladden er i brug af', $sprog_id); //Kladden er i brug af
			print "<body onLoad=\"javascript:alert('$alert1 $row[hvem]')\">"; #20210720
			if ($popup || $visipop)
				print "<meta http-equiv='refresh' content='0;URL=../includes/luk.php'>";
			else
				print "<meta http-equiv='refresh' content='0;URL=../finans/kladdeliste.php'>";
		} else {
			$page_display = false;
			$a--;
			$tidspkt = $a . " " . $b; #der fratraekkes 1. sec af hensyn til refreshtjek;
			db_modify("update kladdeliste set hvem = '$brugernavn',tidspkt='$tidspkt' where id = '$tjek'", __FILE__ . " linje " . __LINE__);
		}
	}
	if (db_fetch_array(db_select("select id from tmpkassekl where kladde_id='$tjek'", __FILE__ . " linje " . __LINE__)))
		$fejl = 1;
	else
		$fejl = 0;

	if ($r = db_fetch_array(db_select("select * from grupper where ART = 'KASKL' and kode='1' and kodenr='$bruger_id'", __FILE__ . " linje " . __LINE__))) {
		$kksort = $r['box1'];
		$kontrolkonto = $r['box2'];
	} else {
		db_modify("insert into grupper (beskrivelse,art,kode,kodenr) values ('Kassekladde','KASKL','1','$bruger_id')", __FILE__ . " linje " . __LINE__);
	}
}

$ompost             = isset($_GET['ompost'])     ? $_GET['ompost']     : Null;
$move_up            = isset($_GET['move_up'])    ? $_GET['move_up']    : null;
$move_down          = isset($_GET['move_down'])  ? $_GET['move_down']  : null;
$move_bilag         = isset($_GET['move_bilag']) ? $_GET['move_bilag'] : null;
$move_date          = isset($_GET['move_date'])  ? $_GET['move_date']  : null;
$move_pos           = isset($_GET['move_pos'])   ? $_GET['move_pos']   : null;
$kladde_id_from_get = isset($_GET['kladde_id'])  ? $_GET['kladde_id']  : null;

if (($move_up || $move_down) && $move_bilag && $move_date && $move_pos && $kladde_id_from_get) {
    $direction = $move_up ? 'up' : 'down';
    moveEntryByBilag($move_bilag, $move_date, $move_pos, $direction, $kladde_id_from_get);
    header("Location: kassekladde.php?kladde_id=$kladde_id_from_get&tjek=$kladde_id_from_get");
    exit;
}

if ($ompost)
	ompost($ompost);

	

$kladde_id = isset($_POST['kladde_id']) ? $_POST['kladde_id'] : 0;
$antal_ny  = isset($_POST['antal_ny'])  ? $_POST['antal_ny']  : 0;
$h = $antal_ny * 10 + 100;

?>
<script type="text/javascript">
<!--
function simuler(){
window.open("../finans/bogfor.php?kladde_id=<?php echo $kladde_id ?>&funktion=simuler","","width=800,height=600,scrollbars=1,resizable=1")
}
//-->
</script>
<script type="text/javascript">
<!--
function bogfor() {
	window.open("../finans/bogfor.php?kladde_id=<?php echo $kladde_id ?>","","width=800,height=600,scrollbars=1,resizable=1")
}
//-->
</script>

<?php
$r = db_fetch_array(db_select("select box4,box10 from grupper where art = 'DIV' and kodenr = '2'", __FILE__ . " linje " . __LINE__)); #20140624
($r['box4'])  ? $forskellige_datoer = 1 : $forskellige_datoer = 0;
($r['box10']) ? $vis_bet_id = 1         : $vis_bet_id = 0;
if ($_GET) {
	$returside = if_isset($_GET['returside']);
	if (!$returside)           $returside = "../finans/kladdeliste.php'";
	if (isset($_GET['fokus'])) $fokus     = $_GET['fokus'];
	$sort            =       if_isset($_GET['sort']);
	$kksort          =       if_isset($_GET['kksort']); #sortering i kassekladde
	$funktion        =       if_isset($_GET['funktion']);
	$x               = (int) if_isset($_GET['x'], 0);
	$id[$x]          =       if_isset($_GET['id']);
	$lobenr[$x]      =       if_isset($_GET['lobenr']);
	$kladde_id       = (int) if_isset($_GET,0,'kladde_id');
	$bilag[$x]       = (int) if_isset($_GET,0,'bilag');
	$dato[$x]        =       if_isset($_GET,'','dato');
	$beskrivelse[$x] =       if_isset($_GET,'','beskrivelse');
	$d_type[$x]      =       if_isset($_GET,'','d_type');
	$debet[$x]       =       if_isset($_GET,'','debet');
	$k_type[$x]      =       if_isset($_GET,'','k_type');
	$kredit[$x]      =       if_isset($_GET,'','kredit');
	$faktura[$x]     =       if_isset($_GET,'','faktura');
	$belob[$x]       =       if_isset($_GET['belob']);
	$momsfri[$x]     =       if_isset($_GET,'','momsfri');
	$afd[$x]         =       if_isset($_GET,'','afd');
	$projekt[$x]     =       if_isset($_GET,'','projekt');
	$ansat[$x]       =       if_isset($_GET,'','ansat');
	$valuta[$x]      =       if_isset($_GET,'','valuta');
	$find            =       if_isset($_GET,'','find');
	$beskrivelse[$x] =  trim(if_isset($beskrivelse[$x], ''));
	$d_type[$x]      =  trim(if_isset($d_type[$x], ''));
	$debet[$x]       =  trim(if_isset($debet[$x], ''));
	$k_type[$x]      =  trim(if_isset($k_type[$x], ''));
	$kredit[$x]      =  trim(if_isset($kredit[$x], ''));
	$faktura[$x]     =  trim(if_isset($faktura[$x], ''));
	$belob[$x]       =  trim(if_isset($belob[$x], ''));

	if (!isset($forfaldsdato[$x]))
		$forfaldsdato[$x] = '';
	if (!isset($betal_id[$x]))
		$betal_id[$x] = '';

	if ($kksort)
		db_modify("update grupper set box1='$kksort' where ART='KASKL' and kode='1' and kodenr='$bruger_id'", __FILE__ . " linje " . __LINE__);
	if (($sort) && ($funktion)) {
		if (!function_exists($funktion)) include_once("kassekladde_includes/$funktion.php");
		$funktion($find, $sort, $fokus, $x, $id[$x], $kladde_id, $bilag[$x], $dato[$x], $beskrivelse[$x], $d_type[$x], $debet[$x], $k_type[$x], $kredit[$x], $faktura[$x], $belob[$x], $momsfri[$x], $afd[$x], $projekt[$x], $ansat[$x], $valuta[$x], $forfaldsdato[$x], $betal_id[$x], $lobenr[$x]);
	}
	$y = 0;
	$query = db_select("select kontonr from kontoplan where kontotype != 'H' and kontotype != 'Z' and regnskabsaar='$regnaar'", __FILE__ . " linje " . __LINE__);
	while ($row = db_fetch_array($query)) {
		$y++;
		$kontonr[$y] = trim($row['kontonr']);
	}
	if ($kladde_id) {
		$qtxt = "select bogfort from kladdeliste where id = $kladde_id"; #echo __line__." $qtxt<br>";
		$r    = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
		if ($r['bogfort'] == '-' && ($id[$x]) || ($lobenr[$x] || ($x))) {
			if ($id[$x]) {
				$qtxt = "update tmpkassekl set beskrivelse='" . db_escape_string($beskrivelse[$x]) . "',d_type='$d_type[$x]', ";
				$qtxt.= "debet='$debet[$x]', k_type='$k_type[$x]', kredit='$kredit[$x]', faktura='" . db_escape_string($faktura[$x]) . "',";
				$qtxt.= "amount='$belob[$x]', momsfri='$momsfri[$x]', afd='$afd[$x]', projekt='$projekt[$x]', ansat='$ansat[$x]',";
				$qtxt.= "valuta='$valuta[$x]',forfaldsdate='$forfaldsdato[$x]',betal_id='$betal_id[$x]' ";
				$qtxt.= "where id='$id[$x]' and kladde_id='$kladde_id'";
			} elseif ($lobenr[$x]) {
				$qtxt = "update tmpkassekl set bilag='$bilag[$x]',beskrivelse='" . db_escape_string($beskrivelse[$x]) . "',d_type='$d_type[$x]',";
				$qtxt.= "debet='$debet[$x]', k_type='$k_type[$x]', kredit='$kredit[$x]', faktura='" . db_escape_string($faktura[$x]) . "',";
				$qtxt.= "amount='$belob[$x]', momsfri='$momsfri[$x]', afd='$afd[$x]', projekt='$projekt[$x]', ansat='$ansat[$x]',";
				$qtxt.= "valuta='$valuta[$x]',forfaldsdate='$forfaldsdato[$x]',betal_id='$betal_id[$x]' ";
				$qtxt.= "where lobenr='$lobenr[$x]' and kladde_id='$kladde_id'";
			} else {
				$qtxt = "update tmpkassekl set bilag='$bilag[$x]',d_type='$d_type[$x]', debet='$debet[$x]', k_type='$k_type[$x]', ";
				$qtxt.= "kredit='$kredit[$x]', faktura='" . db_escape_string($faktura[$x]) . "', amount='$belob[$x]', momsfri='$momsfri[$x]',";
				$qtxt.= "afd='$afd[$x]', projekt='$projekt[$x]', ansat='$ansat[$x]', valuta='$valuta[$x]',forfaldsdate='$forfaldsdato[$x]',";
				$qtxt.= "betal_id='$betal_id[$x]' where lobenr='$x' and kladde_id='$kladde_id'";
			}
			db_modify($qtxt, __FILE__ . " linje " . __LINE__);
			kontroller($id[$x], $bilag[$x], $dato[$x], $beskrivelse[$x], $d_type[$x], $debet[$x], $k_type[$x], $kredit[$x], $faktura[$x], $belob[$x], $momsfri[$x], $kladde_id, $afd[$x], $projekt[$x], $ansat[$x], $valuta[$x], $forfaldsdato[$x], $betal_id[$x], $x);
		}
		if ($fejl)
			$submit = 'save';
	}
	if ($r = db_fetch_array(db_select("select * from grupper where ART = 'KASKL' and kode='1' and kodenr='$bruger_id'", __FILE__ . " linje " . __LINE__))) {
		$kksort = $r['box1'];
		$kontrolkonto = $r['box2'];
	}
}

if ($_POST) {
	if (isset($_POST['copy2new']) && $_POST['copy2new'])     $submit = 'copy2new';
	elseif (isset($_POST['import']) && $_POST['import'])     $submit = 'import';
	elseif (isset($_POST['lookup']) && $_POST['lookup'])     $submit = 'lookup';
	elseif (isset($_POST['doPost']) && $_POST['doPost'])     $submit = 'doPost';
	elseif (isset($_POST['revert']) && $_POST['revert'])     $submit = 'revert';
	elseif (isset($_POST['offset']) && $_POST['offset'])     $submit = 'offset';
	elseif (isset($_POST['save']) && $_POST['save'])         $submit = 'save';
	elseif (isset($_POST['simulate']) && $_POST['simulate']) $submit = 'simulate';
	elseif (isset($_POST['upload']) && $_POST['upload'])     $submit = 'upload';
	else $submit   = trim(if_isset($_POST['submit'], ''));  
	$tidspkt       = if_isset($_POST['tidspkt']);
	$kladde_id     = if_isset($_POST['kladde_id']);
	$ny_dato       = if_isset($_POST['ny_dato']);
	$vend_fortegn  = if_isset($_POST['vend_fortegn']);
	$kontrolkonto  = trim(if_isset($_POST['kontrolkonto'], ''));
	$bilagsnr      = if_isset($_POST['bilagsnr']);
	$kladdenote    = db_escape_string(trim(if_isset($_POST['kladdenote'], '')));
	$ny_kladdenote = db_escape_string(trim(if_isset($_POST['ny_kladdenote'], '')));
	$antal_ny      = if_isset($_POST['antal_ny']);
	$antal_ex      = if_isset($_POST['antal_ex']);
	$fokus         = if_isset($_POST['fokus']);
//  $momsfri       = if_isset($_POST['momsfri']);
	$id            = if_isset($_POST['id']);
	$gl_transdate  = if_isset($_POST['transdate']);
	if ($kladde_id) {
#		if ($r=db_fetch_array(db_select("select id from kladdeliste where bogfort='S' and id='$kladde_id'",__FILE__ . " linje " . __LINE__))) {
#			 $alerttekst= findtekst('1417|Annullerer simulering for denne kladde', $sprog_id);
#			 alert('a'.$alerttekst);
#		}
		db_modify("delete from tmpkassekl where kladde_id=$kladde_id", __FILE__ . " linje " . __LINE__);
		if (isset($_POST['cancelSimulation']) && $_POST['cancelSimulation']) {
			db_modify("delete from simulering where kladde_id=$kladde_id", __FILE__ . " linje " . __LINE__);
			$qtxt = "update kladdeliste set bogfort = '-', bogforingsdate = NULL, bogfort_af = '' where id = '$kladde_id' and bogfort = 'S'";
			db_modify($qtxt, __FILE__ . " linje " . __LINE__);
		}
	}
	$qtxt = "update grupper set box2='$kontrolkonto' where ART='KASKL' and kode='1' and kodenr='$bruger_id'";
	db_modify($qtxt,__FILE__ . " linje " . __LINE__);
	$qtxt = "select * from grupper where ART = 'bilag' and (box6 ='on' or (box1 !='' and box2 !='' and box3 !=''))";
	($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) ? $vis_bilag = 1 : $vis_bilag = 0;
	(isset($r['box6']) && $r['box6'] == 'on') ? $intern_bilag = 1 : $intern_bilag = 0;
	(db_fetch_array(db_select("select * from grupper where ART = 'AFD'", __FILE__ . " linje " . __LINE__))) ? $vis_afd = 1 : $vis_afd = 0;
	(db_fetch_array(db_select("select * from grupper where ART = 'PRJ'", __FILE__ . " linje " . __LINE__))) ? $vis_projekt = 1 : $vis_projekt = 0;
	(db_fetch_array(db_select("select * from grupper where ART = 'VK'",  __FILE__ . " linje " . __LINE__))) ? $vis_valuta = 1 : $vis_valuta = 0;
	for ($x = 1; $x <= $antal_ny; $x++) {
		$dato[$x] = $beskrivelse[$x] = $d_type[$x] = $debet[$x] = $k_type[$x] = $kredit[$x] = $faktura[$x] = NULL;
		$belob[$x] = $momsfri[$x] = $afd[$x] = $projekt[$x] = $ansat[$x] = $valuta[$x] = $forfaldsdato[$x] = $betal_id[$x] = NULL;

		$y = "bila" . $x;
		$bilag[$x] = trim(if_isset($_POST[$y], ''));
		if (!$bilag[$x])
			$bilag[$x] = '0'; # PHR 02.09.06
		$y = "dato" . $x;
		$dato[$x] = trim(if_isset($_POST[$y], ''));
		if (substr($dato[$x], 4, 1) == '-' && substr($dato[$x], 7, 1) == '-') {
			$dato[$x] = dkdato($dato[$x]);
		}
		$y = "besk" . $x;
		$beskrivelse[$x] = trim(if_isset($_POST[$y], '')); #20130731
		while (strpos($beskrivelse[$x], "  "))
			$beskrivelse[$x] = str_replace("  ", " ", $beskrivelse[$x]);
		#		while (strpos($beskrivelse[$x],"''")) $beskrivelse[$x]=str_replace("''","'",$beskrivelse[$x]); #20130731
		$y = "d_ty" . $x;
		$d_type[$x] = substr(strtoupper(if_isset($_POST[$y], '')), 0, 1);
		$y = "debe" . $x;
		$debet[$x] = trim(if_isset($_POST[$y], ''));
		$y = "k_ty" . $x;
		$k_type[$x] = substr(strtoupper(if_isset($_POST[$y], '')), 0, 1);
		$y = "kred" . $x;
		$kredit[$x] = trim(if_isset($_POST[$y], ''));
		$y = "fakt" . $x;
		$faktura[$x] = trim(if_isset($_POST[$y], '')); #20130731
		$y = "belo" . $x;
		$belob[$x] = if_isset($_POST[$y]);
		$y = "dkka" . $x;
		$dkkamount[$x] = if_isset($_POST[$y]);
		$y = "afd_" . $x;
		$afd[$x] = trim(if_isset($_POST[$y], ''));
		$y = "proj" . $x;
		$projekt[$x] = trim(if_isset($_POST[$y], ''));
		$y = "meda" . $x;
		$ansat[$x] = trim(if_isset($_POST[$y], ''));
		$y = "valu" . $x;
		$valuta[$x] = strtoupper(if_isset($_POST[$y], ''));
		$y = "forf" . $x;
		$forfaldsdato[$x] = trim(if_isset($_POST[$y], ''));
		$y = "b_id" . $x;
		$betal_id[$x] = trim(if_isset($_POST[$y], ''));
		$y = "moms" . $x;
		$momsfri[$x] = if_isset($_POST[$y]);
		if (is_numeric($bilag[$x])) { #20230302 - you can't subtract 1 from a string
			if (
				$submit != 'lookup' && (!$bilag[$x] || $bilag[$x] == $bilag[$x - 1] || $bilag[$x] - 1 == $bilag[$x - 1])
				&& (!$dato[$x] || $dato[$x] == $dato[$x - 1]) && (!$beskrivelse[$x] || $beskrivelse[$x] == $beskrivelse[$x - 1])
				&& !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x] && !$faktura[$x] && !$belob[$x]
			) {
				$bilag[$x] = '-'; #20170418
				$dato[$x] = ''; # 20251217 Clear date when row marked for deletion - fixes empty rows showing date/amount/currency
			} elseif (
				$submit != 'lookup' && (!$bilag[$x] || $bilag[$x] == $bilag[$x - 1]) && (!$dato[$x] || $dato[$x] == $dato[$x - 1])
				&& (!$beskrivelse[$x] || $beskrivelse[$x] == $beskrivelse[$x - 1]) && !$d_type[$x] && !$k_type[$x] && !$debet[$x]
				&& !$kredit[$x] && !$faktura[$x] && !$belob[$x]
			) {
				$bilag[$x] = '-'; #20230302
				$dato[$x] = ''; # 20251217 Clear date when row marked for deletion - fixes empty rows showing date/amount/currency
			}
		} elseif (!$bilag[$x] && !$dato[$x] && !$beskrivelse[$x] && !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x])
			$bilag[$x] = '-';
		elseif ($bilag[$x - 1] == '-' && $dato[$x] == $dato[$x - 2] && !$beskrivelse[$x] && !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x]) {
			$bilag[$x] = '-'; # 20170419
			$dato[$x] = ''; # 20251217 Clear date when row marked for deletion - fixes empty rows showing date/amount/currency
		}
		if (($bilag[$x] == "-*")) $sletrest = 1;
		if ($sletrest) $bilag[$x] = '-';
		if (($bilag[$x] == "=*")) $restlig = 1;
		if ($restlig)  $bilag[$x] = '=';
		if ($bilag[$x] == "=")               $bilag[$x]        = $bilag[$x - 1];
		if ($bilag[$x] == "+")               $bilag[$x]        = $bilag[$x - 1] + 1;
		if (substr($bilag[$x], 0, 1) == "+") $bilag[$x]        = $bilag[$x - 1] + 1;
		# 20251217 OLD CODE - date was copied even for deleted rows causing empty rows to show date/amount/currency
		# if (!$dato[$x] || $dato[$x] == '=')  $dato[$x]         = $dato[$x - 1];
		# 20251217 NEW CODE - Don't copy date for rows marked for deletion (bilag = '-')
		if ($bilag[$x] != '-' && (!$dato[$x] || $dato[$x] == '='))  $dato[$x] = $dato[$x - 1];
		if ($beskrivelse[$x] == "=")         $beskrivelse[$x]  = $beskrivelse[$x - 1];
		if ($d_type[$x] == "=")              $d_type[$x]       = $d_type[$x - 1];
		if ($debet[$x] == "=")               $debet[$x]        = $debet[$x - 1];
		if ($k_type[$x] == "=")              $k_type[$x]       = $k_type[$x - 1];
		if ($kredit[$x] == "=")              $kredit[$x]       = $kredit[$x - 1];
		if ($faktura[$x] == "=")             $faktura[$x]      = $faktura[$x - 1];
		if ($belob[$x] == "=")               $belob[$x]        = $belob[$x - 1];
		if ($afd[$x] == "=")                 $afd[$x]          = $afd[$x - 1];
		if ($ansat[$x] == "=")               $ansat[$x]        = $ansat[$x - 1];
		if ($projekt[$x] == "=")             $projekt[$x]      = $projekt[$x - 1];
		if ($forfaldsdato[$x] == "=")        $forfaldsdato[$x] = $forfaldsdato[$x - 1];
		if ($betal_id[$x] == "=")            $betal_id[$x]     = $betal_id[$x - 1];
		if ((!$dato[$x]) && (($beskrivelse[$x]) || ($debet[$x]) || ($kredit[$x]))) $dato[$x] = date("d-m-Y");
		if ($bilag[$x] != $bilag[$x - 1])    $kontrolsum       = 0;
		if ($debet[$x])                      $kontrolsum       = $kontrolsum + $dkkamount[$x];
		if ($kredit[$x])                     $kontrolsum       = $kontrolsum - $dkkamount[$x];
		$bilagssum[$x] = $kontrolsum;
		# fjerner autogenererede linjer hvis bilaget er i balance
		if (!$kontrolsum && !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x] && $bilag[$x] == $bilag[$x - 1] && $dato[$x] == $dato[$x - 1] && $beskrivelse[$x] == $beskrivelse[$x - 1]) {
			$bilag[$x] = "-";
			$dato[$x] = ''; # 20251217 Clear date when row marked for deletion - fixes empty rows showing date/amount/currency
		}
		if ((!$sletslut) && ($bilag[$x] == "->")) {
			$sletstart = $x;
			$bilag[$x] = "-";
			$dato[$x] = ''; # 20251217 Clear date when row marked for deletion - fixes empty rows showing date/amount/currency
		}
		if ($bilag[$x] == "<-") {
			$bilag[$x] = "-";
			$dato[$x] = ''; # 20251217 Clear date when row marked for deletion - fixes empty rows showing date/amount/currency
			if ((!$sletslut) && ($sletstart))
				$sletslut = $x;
		}
		if (($sletstart) && ($sletslut) && ($sletstart < $sletslut)) {
			for ($y = $sletstart; $y <= $sletslut; $y++) {
				$bilag[$y] = "-";
				db_modify("update tmpkassekl set bilag= '$bilag[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$sletstart = '';
			$sletslut  = '';
		}
		## Bilag		
#		if ($bilag[$x]=='-*') $sletrest=1;
#		if ($sletrest) $bilag[$x]='-';

		if (!isset($bilag_ligslut))
			$bilag_ligslut = NULL;
		if ((!$bilag_ligslut) && ($bilag[$x] == "=>")) {
			$bilag_ligstart = $x;
			$bilag[$x] = $bilag[$x - 1];
		}
		if ($bilag[$x] == "<=") {
			$bilag[$x] == $bilag[$x - 1];
			if ((!$bilag_ligslut) && ($bilag_ligstart))
				$bilag_ligslut = $x;
		}
		if (!isset($bilag_ligslut))
			$bilag_ligslut = NULL;
		if (!isset($bilag_ligstart))
			$bilag_ligstart = NULL;
		if (($bilag_ligstart) && ($bilag_ligslut) && ($bilag_ligstart < $bilag_ligslut)) {
			for ($y = $bilag_ligstart; $y <= $bilag_ligslut; $y++) {
				$bilag[$y] = $bilag[$y - 1];
				db_modify("update tmpkassekl set bilag= '$bilag[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$bilag_ligstart = '';
			$bilag_ligslut  = '';
		}
		# Dato
		if ((!$dato_ligslut) && ($dato[$x] == "=>")) {
			$dato_ligstart = $x;
			$dato[$x] = $dato[$x - 1];
		}
		if ($dato[$x] == "<=") {
			$dato[$x] == $dato[$x - 1];
			if ((!$dato_ligslut) && ($dato_ligstart))
				$dato_ligslut = $x;
		}
		if (($dato_ligstart) && ($dato_ligslut) && ($dato_ligstart < $dato_ligslut)) {
			for ($y = $dato_ligstart; $y <= $dato_ligslut; $y++) {
				$dato[$y] = $dato[$y - 1];
				db_modify("update tmpkassekl set dato= '$dato[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$dato_ligstart = '';
			$dato_ligslut  = '';
		}
		# beskrivelse
		if ((!$beskrivelse_ligslut) && ($beskrivelse[$x] == "=>")) {
			$beskrivelse_ligstart = $x;
			$beskrivelse[$x] = $beskrivelse[$x - 1];
		}
		if ($beskrivelse[$x] == "<=") {
			$beskrivelse[$x] == $beskrivelse[$x - 1];
			if ((!$beskrivelse_ligslut) && ($beskrivelse_ligstart))
				$beskrivelse_ligslut = $x;
		}
		if (($beskrivelse_ligstart) && ($beskrivelse_ligslut) && ($beskrivelse_ligstart < $beskrivelse_ligslut)) {
			for ($y = $beskrivelse_ligstart; $y <= $beskrivelse_ligslut; $y++) {
				$beskrivelse[$y] = $beskrivelse[$y - 1];
				db_modify("update tmpkassekl set beskrivelse= '$beskrivelse[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$beskrivelse_ligstart = '';
			$beskrivelse_ligslut  = '';
		}
		# d_type
		if ((!$d_type_ligslut) && ($d_type[$x] == "=>")) {
			$d_type_ligstart = $x;
			$d_type[$x] = $d_type[$x - 1];
		}
		if ($d_type[$x] == "<=") {
			$d_type[$x] == $d_type[$x - 1];
			if ((!$d_type_ligslut) && ($d_type_ligstart))
				$d_type_ligslut = $x;
		}
		if (($d_type_ligstart) && ($d_type_ligslut) && ($d_type_ligstart < $d_type_ligslut)) {
			for ($y = $d_type_ligstart; $y <= $d_type_ligslut; $y++) {
				$d_type[$y] = $d_type[$y - 1];
				db_modify("update tmpkassekl set d_type= '$d_type[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$d_type_ligstart = '';
			$d_type_ligslut  = '';
		}
		if ($d_type[$x] && $d_type[$x] != 'D' && $d_type[$x] != 'K')
			$d_type[$x] = 'F'; #20110605
# debet
		if ((!$debet_ligslut) && ($debet[$x] == "=>")) {
			$debet_ligstart = $x;
			$debet[$x] = $debet[$x - 1];
		}
		if ($debet[$x] == "<=") {
			$debet[$x] == $debet[$x - 1];
			if ((!$debet_ligslut) && ($debet_ligstart))
				$debet_ligslut = $x;
		}
		if (($debet_ligstart) && ($debet_ligslut) && ($debet_ligstart < $debet_ligslut)) {
			for ($y = $debet_ligstart; $y <= $debet_ligslut; $y++) {
				$debet[$y] = $debet[$y - 1];
				db_modify("update tmpkassekl set debet= '$debet[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$debet_ligstart = '';
			$debet_ligslut = '';
		}
		# k_type
		if ((!$k_type_ligslut) && ($k_type[$x] == "=>")) {
			$k_type_ligstart = $x;
			$k_type[$x] = $k_type[$x - 1];
		}
		if ($k_type[$x] == "<=") {
			$k_type[$x] == $k_type[$x - 1];
			if ((!$k_type_ligslut) && ($k_type_ligstart))
				$k_type_ligslut = $x;
		}
		if (($k_type_ligstart) && ($k_type_ligslut) && ($k_type_ligstart < $k_type_ligslut)) {
			for ($y = $k_type_ligstart; $y <= $k_type_ligslut; $y++) {
				$k_type[$y] = $k_type[$y - 1];
				db_modify("update tmpkassekl set k_type= '$k_type[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$k_type_ligstart = '';
			$k_type_ligslut  = '';
		}
		if ($k_type[$x] && $k_type[$x] != 'D' && $k_type[$x] != 'K')
			$k_type[$x] = 'F'; #20110605
# kredit
		if ((!$kredit_ligslut) && ($kredit[$x] == "=>")) {
			$kredit_ligstart = $x;
			$kredit[$x] = $kredit[$x - 1];
		}
		if ($kredit[$x] == "<=") {
			$kredit[$x] == $kredit[$x - 1];
			if ((!$kredit_ligslut) && ($kredit_ligstart))
				$kredit_ligslut = $x;
		}
		if (($kredit_ligstart) && ($kredit_ligslut) && ($kredit_ligstart < $kredit_ligslut)) {
			for ($y = $kredit_ligstart; $y <= $kredit_ligslut; $y++) {
				$kredit[$y] = $kredit[$y - 1];
				db_modify("update tmpkassekl set kredit= '$kredit[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$kredit_ligstart = '';
			$kredit_ligslut  = '';
		}
		# kredit
		if ((!$kredit_ligslut) && ($kredit[$x] == "=>")) {
			$kredit_ligstart = $x;
			$kredit[$x] = $kredit[$x - 1];
		}
		if ($kredit[$x] == "<=") {
			$kredit[$x] == $kredit[$x - 1];
			if ((!$kredit_ligslut) && ($kredit_ligstart))
				$kredit_ligslut = $x;
		}
		if (($kredit_ligstart) && ($kredit_ligslut) && ($kredit_ligstart < $kredit_ligslut)) {
			for ($y = $kredit_ligstart; $y <= $kredit_ligslut; $y++) {
				$kredit[$y] = $kredit[$y - 1];
				db_modify("update tmpkassekl set kredit= '$kredit[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$kredit_ligstart = '';
			$kredit_ligslut  = '';
		}
		# faktura
		if ((!$faktura_ligslut) && ($faktura[$x] == "=>")) {
			$faktura_ligstart = $x;
			$faktura[$x] = $faktura[$x - 1];
		}
		if ($faktura[$x] == "<=") {
			$faktura[$x] == $faktura[$x - 1];
			if ((!$faktura_ligslut) && ($faktura_ligstart))
				$faktura_ligslut = $x;
		}
		if (($faktura_ligstart) && ($faktura_ligslut) && ($faktura_ligstart < $faktura_ligslut)) {
			for ($y = $faktura_ligstart; $y <= $faktura_ligslut; $y++) {
				$faktura[$y] = $faktura[$y - 1];
				db_modify("update tmpkassekl set faktura= '$faktura[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$faktura_ligstart = '';
			$faktura_ligslut  = '';
		}
		# belob
		if ((!$belob_ligslut) && ($belob[$x] == "=>")) {
			$belob_ligstart = $x;
			$belob[$x] = $belob[$x - 1];
		}
		if ($belob[$x] == "<=") {
			$belob[$x] == $belob[$x - 1];
			if ((!$belob_ligslut) && ($belob_ligstart))
				$belob_ligslut = $x;
		}
		if (($belob_ligstart) && ($belob_ligslut) && ($belob_ligstart < $belob_ligslut)) {
			for ($y = $belob_ligstart; $y <= $belob_ligslut; $y++) {
				$belob[$y] = $belob[$y - 1];
				db_modify("update tmpkassekl set belob= '$belob[$y]' where lobenr='$y' and kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__);
			}
			$belob_ligstart = '';
			$belob_ligslut  = '';
		}
		/*
																			if (strtoupper($debet[$x]) == 'D') $d_type[$x]='D';
																			if (strtoupper($debet[$x]) == 'K') $d_type[$x]='K';
																			if (strtoupper($kredit[$x]) == 'D') $k_type[$x]='D';
																			if (strtoupper($kredit[$x]) == 'K') $k_type[$x]='K';
																	*/
		# Hvis der skrives d eller k i debet eller kredit felt, slås op kreditor eller debitor liste.
		if ($submit == 'save' && ($fokus == "debe$x" && (strtoupper($debet[$x]) == 'D' || strtoupper($debet[$x]) == 'K'))) {
			$qtxt = "select * from kontoplan where genvej='" . strtoupper($debet[$x]) . "' and regnskabsaar='$regnaar'";
			if (!db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$d_type[$x] = strtoupper($debet[$x]);
				$submit = 'lookup';
				$debet[$x] = '';
			}
		} elseif ($submit == 'save' && ($fokus == "kred$x" && (strtoupper($kredit[$x]) == 'D' || strtoupper($kredit[$x]) == 'K'))) {
			$qtxt = "select * from kontoplan where genvej='" . strtoupper($kredit[$x]) . "' and regnskabsaar='$regnaar'";
			if (!db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$k_type[$x] = strtoupper($kredit[$x]);
				$submit = 'lookup';
				$kredit[$x] = '';
			}
		}
		if (!isset($id[$x]))
			$id[$x] = NULL;
		if (!isset($id[$x - 1]))
			$id[$x - 1] = NULL;
		if (
			$x >1 && $id[$x] && !$debet[$x] && !$kredit[$x]
			&& $bilag[$x] == $bilag[$x - 1]
			&& $dato[$x] == $dato[$x - 1]
			&& $beskrivelse[$x] == $beskrivelse[$x - 1]
		) { #20210920
			$bilag[$x] = '-';
		}
		if (!$forskellige_datoer && $bilag[$x] && $bilag[$x] != '-' && $bilag[$x] == $bilag[$x - 1] && $dato[$x] != $dato[$x - 1] && $bilagssum[$x - 1]) {
			$alert3 = findtekst('1581|Forskellige datoer i bilag', $sprog_id); //Forskellige datoer i bilag
			print "<BODY onLoad=\"javascript:alert('$alert3 $bilag[$x]')\">";
		}
		if (strpos($bilag[$x], '+') && $kladde_id) {
			list($bilag[$x], $newLines) = explode('+', $bilag[$x]);
			if ($newLines == '=') {
				indsaet_linjer(
					$kladde_id,
					$bilag[$x],
					$dato[$x],
					$beskrivelse[$x],
					$d_type[$x],
					(int) $debet[$x],
					$k_type[$x],
					(int) $kredit[$x],
					$faktura[$x],
					$belob[$x], // 20240804 (do not float)
					(int) $afd[$x],
					$ansat[$x],
					(int) $projekt[$x],
					$valuta[$x],
					$forfaldsdato[$x],
					(int) $betal_id[$x],
					$momsfri[$x],
					$ansat_id[$x]
				);
			} else {
				$newLines = (int) $newLines;
				for ($nl = 0; $nl < $newLines; $nl++) {
					indsaet_linjer(
						$kladde_id,
						$bilag[$x],
						$dato[$x],
						'',
						'',
						0,
						'',
						0,
						'',
						'',
						(int) $afd[$x],
						$ansat[$x],
						(int) $projekt[$x],
						$valuta[$x],
						'',
						'',
						'',
						$ansat_id[$x]
					);
					if ($nl > 25) {
						alert('Max 25 linjer kan indsættes ad gangen');
						break(1);
					}
				}
			}
		}
		if (($bilag[$x]) && ($bilag[$x] != "-") && ($bilag[$x] != "->") && ($bilag[$x] != "<-") && (!strpos($bilag[$x], '+')) && (substr($bilag[$x], -1) != 'r') && (!is_numeric($bilag[$x]))) { //20160909 undtaget * til brug for bilagsrenum
			$alerttxt = findtekst('1582|Ulovlig værdi i bilagsfelt (Bilag nr', $sprog_id); //Forskellige datoer i bilag
			print "<BODY onLoad=\"javascript:alert('$alerttxt $bilag[$x])')\">";
			$fejl = 1;
		} elseif (($bilag[$x]) && ($bilag[$x] != "-") && ($bilag[$x] != "->") && (substr($bilag[$x], -1) != 'r') && ($bilag[$x] != "<-"))
			$bilag[$x] = $bilag[$x] * 1; //20160909 undtaget * til brug for bilagsrenum
		if ($bilag[$x] == "-") {
			$dato[$x] = $beskrivelse[$x] = $d_type[$x] = $debet[$x] = $k_type[$x] = $kredit[$x] = $faktura[$x] = $belob[$x] = $momsfri[$x] = $afd[$x] =
				$projekt[$x] = $ansat[$x] = $valuta[$x] = $forfaldsdato[$x] = $betal_id[$x] = '';
		}
		if (!isset($id[$x]))
			$id[$x] = '0';
		if (!$id[$x])
			$id[$x] = '0';
		if (!$kladde_id) {
			$tidspkt = microtime();
			$row = db_fetch_array(db_select("select MAX(id) AS id from kladdeliste", __FILE__ . " linje " . __LINE__));
			$kladde_id = $row['id'] + 1;
			$kladdedate = date("Y-m-d");	# OBS I naeste linje indsaettes tidspkt fratrukket 1 sek. Ellers bliver 1. gemning afvist af	"Refresktjek"
			db_modify("insert into kladdeliste (id, kladdenote, kladdedate, bogfort, hvem, oprettet_af, tidspkt) values ('$kladde_id', '$ny_kladdenote', '$kladdedate', '-', '$brugernavn', '$brugernavn', '$tidspkt')", __FILE__ . " linje " . __LINE__);
			$tidspkt = microtime();
		}
		if ($kladde_id) {
			$bilag[$x] = db_escape_string(if_isset($bilag[$x], ''));
			$dato[$x] = db_escape_string(if_isset($dato[$x], ''));
			#cho __line__." dato[$x] $dato[$x]<br>";
			$beskrivelse[$x] = db_escape_string(if_isset($beskrivelse[$x], ''));
			$d_type[$x] = db_escape_string(if_isset($d_type[$x], ''));
			$debet[$x] = db_escape_string(if_isset($debet[$x], ''));
			$k_type[$x] = db_escape_string(if_isset($k_type[$x], ''));
			$kredit[$x] = db_escape_string(if_isset($kredit[$x], ''));
			$faktura[$x] = db_escape_string(if_isset($faktura[$x], ''));
			$belob[$x] = db_escape_string(if_isset($belob[$x], ''));
			$momsfri[$x] = db_escape_string(if_isset($momsfri[$x], ''));
			$afd[$x] = db_escape_string(if_isset($afd[$x], ''));
			$projekt[$x] = db_escape_string(if_isset($projekt[$x], ''));
			$ansat[$x] = db_escape_string(if_isset($ansat[$x], ''));
			$valuta[$x] = db_escape_string(if_isset($valuta[$x], ''));
			$forfaldsdato[$x] = db_escape_string(if_isset($forfaldsdato[$x], ''));
			$qtxt = "insert into tmpkassekl ";
			$qtxt.= "(lobenr,id,bilag,transdate,beskrivelse,d_type,debet,k_type,kredit,faktura,";
			$qtxt.= "amount,momsfri,afd,kladde_id,projekt,ansat,valuta,forfaldsdate,betal_id) ";
			$qtxt.= "values ";
			$qtxt.= "('$x', '$id[$x]', '$bilag[$x]', '$dato[$x]', '$beskrivelse[$x]', '$d_type[$x]', '$debet[$x]', ";
			$qtxt.= "'$k_type[$x]', '$kredit[$x]', '$faktura[$x]', '$belob[$x]', '$momsfri[$x]', '$afd[$x]', ";
			$qtxt.= "'$kladde_id', '$projekt[$x]', '$ansat[$x]', '$valuta[$x]','$forfaldsdato[$x]','$betal_id[$x]')";
			#cho __line__." $qtxt<br>";
			db_modify($qtxt, __FILE__ . " linje " . __LINE__);

if ($x == $antal - 1 && $kladde_id) { // only after last line
    $sum_debet = 0;
    $sum_kredit = 0;

    $res = db_select("SELECT debet, kredit FROM tmpkassekl WHERE bilag = '$bilag[$x]' AND kladde_id = '$kladde_id'", __FILE__ . " linje " . __LINE__);
    while ($row = db_fetch_array($res)) {
        $sum_debet += floatval($row['debet']);
        $sum_kredit += floatval($row['kredit']);
    }

    $diff = round($sum_debet - $sum_kredit, 2);
    if ($diff != 0) {
        $next_lob   = $x + 1;
        $debet_val  = $diff < 0 ? abs($diff) : 0;
        $kredit_val = $diff > 0 ? abs($diff) : 0;

        $qtxt = "INSERT INTO tmpkassekl (lobenr,id,bilag,transdate,beskrivelse,d_type,debet,k_type,kredit,faktura,amount,momsfri,afd,kladde_id,projekt,ansat,valuta,forfaldsdate,betal_id)
                 VALUES ('$next_lob', '0', '$bilag[$x]', '$dato[$x]', 'Auto-balance', '', '$debet_val', '', '$kredit_val', '', '0', '', '', '$kladde_id', '', '', '', '', '')";
        db_modify($qtxt, __FILE__ . " linje " . __LINE__);
    }
}

		}
		if ($fejl)
			$submit = 'save'; #20210721
	}
	#cho __line__." F $fejl<br>";
	if ($fejl)
		$submit = 'save';
	if ($submit == 'copy2new') {
		include_once("kassekladde_includes/copy2new.php");
		copy2new($kladde_id, $bilagsnr, $ny_dato, $vend_fortegn);
	}
	$fokus = $_POST['fokus'];
	if ($kladde_id) {
		$row = db_fetch_array(db_select("select bogfort,tidspkt from kladdeliste where id=$kladde_id", __FILE__ . " linje " . __LINE__));
		if (!$row['bogfort'] && $tidspkt == $row['tidspkt']) { #Refreshtjek"
			$alert = findtekst('1583|Brug af refresh konstateret - handling ignoreret', $sprog_id); //Brug af refresh konstateret - handling ignoreret
			print "<BODY onLoad=\"javascript:alert('$alert')\">";
		} else {
			$page_display = false;
			$qtxt = "update kladdeliste set hvem = '$brugernavn', tidspkt='$tidspkt'";
			if ($ny_kladdenote) {
				$qtxt .= ", kladdenote = '$ny_kladdenote' ";
				$kladdenote = $ny_kladdenote;
			}
			$qtxt .= " where id = '$kladde_id'";
			db_modify($qtxt, __FILE__ . " linje " . __LINE__);
			if (!$kontonr) {
				$x = 0;
				$query = db_select("select kontonr from kontoplan where kontotype != 'H' and kontotype != 'Z' and regnskabsaar=$regnaar", __FILE__ . " linje " . __LINE__);
				while ($row = db_fetch_array($query)) {
					$x++;
					$kontonr[$x] = trim($row["kontonr"]);
				}
				$acc_ant = $x;
			}
			if ($submit == 'lookup')
				$opslag_id = substr($fokus, 4, strlen($fokus) - 4);
			elseif ($kladde_id) {
				$row = db_fetch_array(db_select("select bogfort from kladdeliste where id = $kladde_id", __FILE__ . " linje " . __LINE__));
				if ($row['bogfort'] == '-') {
					for ($x = 0; $x <= $antal_ny; $x++) {
						if (!isset($bilag[$x]))
							$bilag[$x] = NULL;
						if (!isset($dato[$x]))
							$dato[$x] = NULL;
						if (!isset($beskrivelse[$x]))
							$beskrivelse[$x] = NULL;
						if (!isset($d_type[$x]))
							$d_type[$x] = NULL;
						if (!isset($debet[$x]))
							$debet[$x] = NULL;
						if (!isset($k_type[$x]))
							$k_type[$x] = NULL;
						if (!isset($kredit[$x]))
							$kredit[$x] = NULL;
						if (!isset($faktura[$x]))
							$faktura[$x] = NULL;
						if (!isset($belob[$x]))
							$belob[$x] = NULL;
						if (!isset($momsfri[$x]))
							$momsfri[$x] = NULL;
						if (!isset($afd[$x]))
							$afd[$x] = NULL;
						if ((!$fejl) && ($x != $opslag_id) && (($beskrivelse[$x]) || ($debet[$x]) || ($kredit[$x]))) {
							kontroller($id[$x], $bilag[$x], $dato[$x], $beskrivelse[$x], $d_type[$x], $debet[$x], $k_type[$x], $kredit[$x], $faktura[$x], $belob[$x], $momsfri[$x], $kladde_id, $afd[$x], $projekt[$x], $ansat[$x], $valuta[$x], $forfaldsdato[$x], $betal_id[$x], $x);
						} elseif ((!$fejl) && ($x != $opslag_id) && ($bilag[$x] == "-")) {
							kontroller($id[$x], $bilag[$x], $dato[$x], $beskrivelse[$x], $d_type[$x], $debet[$x], $k_type[$x], $kredit[$x], $faktura[$x], $belob[$x], $momsfri[$x], $kladde_id, $afd[$x], $projekt[$x], $ansat[$x], $valuta[$x], $forfaldsdato[$x], $betal_id[$x], $x);
						}
					}
					#cho __line__." $submit $debet[$x] $fokus $x<br>";
					if ($fejl)
						$submit = 'save';
				}
			}
			#******************************
#cho __line__." $submit $debet[$x] $fokus $x<br>";
#			if ($submit === 'lookup' || $submit === 'save' ) {
			if ($submit === 'lookup') {
				if (isset($debet[$opslag_id])) {
					if (strtoupper($debet[$opslag_id]) == "K") $d_type[$opslag_id] = "K";
					elseif (strtoupper($debet[$opslag_id]) == "D") $d_type[$opslag_id] = "D";
				}
				if (isset($kredit[$opslag_id])) {
					if (strtoupper($kredit[$opslag_id]) == "K") $k_type[$opslag_id] = "K";
					elseif (strtoupper($kredit[$opslag_id]) == "D") $k_type[$opslag_id] = "D";
				}
				if (isset($d_type[$opslag_id]) && $d_type[$opslag_id]) $d_type[$opslag_id] = trim(strtoupper($d_type[$opslag_id]));
				if (isset($k_type[$opslag_id]) && $k_type[$opslag_id]) $k_type[$opslag_id] = trim(strtoupper($k_type[$opslag_id]));
				if ((strstr($fokus, "debe")) || (strstr($fokus, "d_ty"))) {
					if ($d_type[$opslag_id] == "K") {
						include('kassekladde_includes/creditorLookup.php');
						creditorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					} elseif ($d_type[$opslag_id] == "D") {
						include('kassekladde_includes/debitorLookup.php');
						debitorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					} else {
						include('kassekladde_includes/financeLookup.php');
						financeLookup($find, 'kontonr', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					}
				}
				if ((strstr($fokus, "kred")) || (strstr($fokus, "k_ty"))) {
					if ($k_type[$opslag_id] == "K") {
						include('kassekladde_includes/creditorLookup.php');
						creditorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					}
					if ($k_type[$opslag_id] == "D") {
						include('kassekladde_includes/debitorLookup.php');
						debitorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					} else {
						include('kassekladde_includes/financeLookup.php');
						financeLookup($find, 'kontonr', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					}
				}
				if ((strstr($fokus, "fakt")) || (strstr($fokus, "belo"))) {
					include("kassekladde_includes/openpost_inc.php");
					openpost($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
				}
				if (strstr($fokus, "afd")) {
					include_once('kassekladde_includes/departmentLookup.php');
					departmentLookup($fokus, $opslag_id, $opslag_id);
				}
				if (strstr($fokus, "meda")) {
					include_once('kassekladde_includes/employeeLookup.php');
					employeeLookup($fokus, $opslag_id, $opslag_id);
				}
				if (strstr($fokus, "proj")) {
					include_once('kassekladde_includes/projectLookup.php');
					projectLookup($fokus, $opslag_id, $opslag_id);
				}
				if (strstr($fokus, "valu")) {
					include_once('kassekladde_includes/currencyLookup.php');
					currencyLookup($fokus, $opslag_id, $opslag_id);
				}
			}
			// if (strstr($submit,"Simul")) {
			if ($submit == 'simulate') { #20210721
				print "<meta http-equiv='refresh' content='0;URL=../finans/bogfor.php?kladde_id=$kladde_id&funktion=simuler'>";
				/*
																								#?>
																								#<body onload="simuler()">
																								#<?php
																								*/
			}
			#if (strstr($submit,"Bogf"))	{
			if ($submit == 'doPost') {
				print "<meta http-equiv='refresh' content='0;URL=../finans/bogfor.php?kladde_id=$kladde_id&funktion=bogfor'>";
			}
			#if (strstr($submit,"Tilbagef")){
			if ($submit == 'revert') {
				tilbagefor($kladde_id);
			}
			if ($submit == 'upload') {
				print "<meta http-equiv='refresh' content='0;URL=../finans/hentordrer.php?kladde_id=$kladde_id'>";
			}
			#if (strstr($submit,"Impor")) {
			if ($submit == 'import') {
				if (!$bilagsnr) { #20171129
					$r = db_fetch_array(db_select("select max(bilag) as bilagsnr from kassekladde where kladde_id='$kladde_id'", __FILE__ . " linje " . __LINE__));
					$bilagsnr = $r['bilagsnr'];
				}
				print "<meta http-equiv='refresh' content='0;URL=../finans/importer.php?kladde_id=$kladde_id&bilagsnr=$bilagsnr'>";
			}
			#if (strstr($submit,"Udlig")) {
			if ($submit == 'offset') {
				print "<meta http-equiv='refresh' content='0;URL=../finans/autoudlign.php?kladde_id=$kladde_id'>";
			}
			if (strstr($submit, "DocuB")) {
				print "<meta http-equiv='refresh' content='0;URL=../finans/docubizzimport.php?kladde_id=$kladde_id'>";
			}
		}
	}
} else { # endif ($_POST)
	$qtxt = "select * from grupper where ART = 'bilag' and (box6 ='on' or (box1 !='' and box2 !='' and box3 !=''))";
	($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) ? $vis_bilag = 1 : $vis_bilag = 0;
	if (!$r & isset($kladde_id))
		$vis_bilag = 1; //20230806 For the attachment clip to be shown if kladde_id already exits
	(isset($r['box6']) && $r['box6'] == 'on') ? $intern_bilag = 1 : $intern_bilag = 0;
	(db_fetch_array(db_select("select * from grupper where ART = 'AFD'", __FILE__ . " linje " . __LINE__))) ? $vis_afd = 1 : $vis_afd = 0;
	(db_fetch_array(db_select("select * from grupper where ART = 'PRJ'", __FILE__ . " linje " . __LINE__))) ? $vis_projekt = 1 : $vis_projekt = 0;
	(db_fetch_array(db_select("select * from grupper where ART = 'VK'", __FILE__ . " linje " . __LINE__))) ? $vis_valuta = 1 : $vis_valuta = 0;
}
$ansat_id = array();
if ($r = db_fetch_array(db_select("select id from adresser where art = 'S'", __FILE__ . " linje " . __LINE__))) {
	$egen_kto_id = $r['id'];
	$z = 0;
	$qtxt = "select id, initialer from ansatte where konto_id = '$egen_kto_id' and lukket != 'on' order by id";
	$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	while ($r = db_fetch_array($q)) {
		$z++;
		$vis_ansat = 1;
		$ansat_id[$z] = 0;
		#cho $r['id'];
		$ansat_id[$z] = $r['id'];
		$ansat_init[$z] = $r['initialer'];
	}
}
if (!$fejl && $kladde_id) {
	opdater($kladde_id);
    initializePositions($kladde_id);
	db_modify("delete from tmpkassekl where kladde_id=$kladde_id", __FILE__ . " linje " . __LINE__);
}
/*
if (strlen($kontrolkonto)==1) {
	$kontrolkonto=strtoupper($kontrolkonto);
	$query = db_select("select * from kontoplan where genvej='$kontrolkonto' and regnskabsaar='$regnaar'",__FILE__ . " linje " . __LINE__);
	if ($row = db_fetch_array($query)) $kontrolkonto=$row['kontonr'];
	else {
		$kontrolkonto=' ';
		setcookie("saldi_ktrkto",$kontrolkonto,time()+0);
	}
}
if (strlen($kontrolkonto)>1) setcookie("saldi_ktrkto",$kontrolkonto,time()+60*60*24*30);
else setcookie("saldi_ktrkto",$kontrolkonto,time()-3600);
ob_end_flush();	//Sender det "bufferede" output afsted...
*/

if ($kladde_id) {
	$query = db_select("select kladdenote, bogfort from kladdeliste where id = $kladde_id", __FILE__ . " linje " . __LINE__);
	$row = db_fetch_array($query);
	$kladdenote = htmlentities(stripslashes($row['kladdenote']), ENT_QUOTES, $charset);
	$bogfort = $row['bogfort'];
}
$x = 0;
($visipop) ? $ny = NULL : $ny = findtekst('39|Ny', $sprog_id); #20210628

if (!$simuler) {

	if ($returside == "kontospec.php") {
		$backUrl = "kontospec.php";
	} else {
		$backUrl = "../finans/kladdeliste.php?exitDraft=$kladde_id";
	}
	if ($returside != "regnskab") {
		$returside = "../finans/kladdeliste.php";
	}


	


	($udskriv) ? $height = '' : $height = 'height="100%"';
	if ($udskriv) {
		print "<div class='print-view'>";
	}
	if ($menu != 'T') {
		#print "<table class='outerTable' width='100%' $height border='0' cellspacing='1' cellpadding='0'><tbody>"; # Tabel 1 -> Hovedramme
	}
	if (!$udskriv) {
		if ($menu == 'T') {
			include_once '../includes/top_header.php';
			include_once '../includes/top_menu.php';

			$tekst = findtekst('154|Dine ændringer er ikke blevet gemt! Tryk OK for at forlade siden uden at gemme.', $sprog_id);
			print "<div id='header'>";
			print "<div class='headerbtnLft headLink'><a href=\"javascript:confirmClose('../finans/kladdeliste.php?exitDraft=$kladde_id','$tekst')\" accesskey=L title='Klik her for at komme tilbage'><i class='fa fa-close fa-lg'></i> &nbsp;" . findtekst('30|Tilbage', $sprog_id) . "</a></div>";
			print "<div class='headerTxt'>$title &nbsp;•&nbsp; $kladde_id</div>";
			print "<div class='headerbtnRght headLink'><a accesskey=N href=\"javascript:confirmClose('../finans/kassekladde.php?exitDraft=$kladde_id','$tekst')\"' title='TEXTHERE'><i class='fa fa-plus-square fa-lg'></i></a></div>";
			print "</div>";
			print "<div class='content-noside'>";

		} elseif ($menu=='S') {
			include_once 'kassekladde_includes/topLineKassekladde.php';
		} else {
			print "<tr><td height='1%' align='center' valign='top' class='top-header'>"; 
			print "<table width='100%' align='center' border='0' cellspacing='2' cellpadding='0'><tbody><tr>"; # Tabel 1.1 -> Toplinje
			if ($popup) print "<td onClick='JavaScript:opener.location.reload();' width='10%' $top_bund>";
			else print "<td $top_bund>";
			$tekst = findtekst('154|Dine ændringer er ikke blevet gemt! Tryk OK for at forlade siden uden at gemme.', $sprog_id);
			if ($popup || $visipop) {
				print "<a href=\"javascript:confirmClose('../includes/luk.php?tabel=kladdeliste&amp;id=$kladde_id&exitDraft=$kladde_id','$tekst')\" accesskey='L'>" . findtekst('30|Tilbage', $sprog_id) . "</a></td>";
			} else {
				print "<a href=\"javascript:confirmClose('../finans/kladdeliste.php?exitDraft=$kladde_id','$tekst')\" accesskey='L'>" . findtekst('30|Tilbage', $sprog_id) . "</a></td>";
			}
			print "<td width='80%' $top_bund> " . findtekst('1072|Kassekladde', $sprog_id) . "  $kladde_id</td>";
			print "<td width='10%' $top_bund align='right'><a href=\"javascript:confirmClose('../finans/kassekladde.php?exitDraft=$kladde_id','$tekst')\" accesskey='N'>$ny</a></td></tr>";
			print "</tbody></table>"; # Tabel 1.1 <- Toplinje
			print "</td></tr>\n";
		}
	}
}

function build_kassekladde_query($kladde_id, $kksort) {
    $query = "
         SELECT 
            k.id,
            k.bilag,
            k.transdate,
            k.beskrivelse,
            k.d_type,
            k.debet,
            k.k_type,
            k.kredit,
            k.faktura,
            k.amount as belob,
            k.momsfri,
            k.afd,
            k.ansat,
            k.projekt,
            k.valuta,
            k.forfaldsdate,
            k.betal_id,
            k.pos,
            k.dokument,
            k.saldo
        FROM kassekladde k
        WHERE k.kladde_id = '$kladde_id' AND {{WHERE}}
        ORDER BY {{SORT}}
    ";
    return $query;
}

// Define columns for the grid
$columns = array(
    // Bilag clip column (if vis_bilag is enabled)
    array(
    'field' => 'clip',
    'headerName' => '',
    'type' => 'text',
    'width' => '0.5',
    'sortable' => false,
    'searchable' => false,
    'hidden' => !$vis_bilag,
    'render' => function($value, $row, $column) use ($kladde_id, $sprog_id) {
        $id = $row['id'];
        $bilag = $row['bilag'];
        $dokument = $row['dokument'];
        
        // Check documents table for attached files
        $qtxt = "select id, filename from documents where source = 'kassekladde' and source_id = '$id' order by id limit 1";
        $docRow = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
        
        $hasDoc = ($dokument || $docRow) ? true : false;
        
        if ($hasDoc) {
            $clip = 'paper.png';
            $titletxt = findtekst(1454, $sprog_id);
            $href = "../includes/documents.php?source=kassekladde&sourceId=$id&kladde_id=$kladde_id&bilag=$bilag&fokus=bila";
        } else {
            $clip = 'clip.png';
            $titletxt = findtekst(1455, $sprog_id);
            $href = "../includes/documents.php?source=kassekladde&sourceId=$id&kladde_id=$kladde_id&bilag=$bilag&fokus=bila&openPool=1";
        }
        
        $dragAttr = $hasDoc ? "draggable='true' ondragstart='clipDragStart(event, $id, \"" . htmlspecialchars($bilag) . "\")'" : "";
        $dropAttr = "";
        $dropClass = $hasDoc ? "clip-has-doc" : "clip-no-doc";
        
        $txt = 'Obs - Du har ikke gemt.\n Hvis du klikker OK mistes de sidste ændringer';
        return "<td class='clip-cell $dropClass' data-source-id='$id' data-bilag='" . htmlspecialchars($bilag) . "' $dropAttr title='$titletxt'>
            <a href=\"javascript:confirmClose('$href','$txt')\" accesskey='L' $dragAttr>
            <img src='../ikoner/$clip' style='width:20px;height:20px;cursor:" . ($hasDoc ? "grab" : "pointer") . ";' class='clip-icon' data-source-id='$id' data-bilag='" . htmlspecialchars($bilag) . "'></a>
        </td>";
    }
),
    
    // Bilag number
    array(
        'field' => 'bilag',
        'headerName' => findtekst('671|Bilag', $sprog_id),
        'type' => 'text',
        'width' => '1',
        'align' => 'right',
        'sortable' => true,
        'searchable' => true,
        'defaultSort' => true,
		"sqlOverride" => "k.bilag",
		"valueGetter" => function ($value, $row, $column) {
			return $value;
		},
		"generateSearch" => function ($column, $term) {
			$field = $column['sqlOverride'] ? $column['sqlOverride'] : $column['field'];
			$term = db_escape_string(trim($term, "'"));
			
			if (empty($term)) {
				return "1=1";
			}
			
			// Cast integer field to text for ILIKE search
			return "$field::text ILIKE '%$term%'";
		},
        'defaultSortDirection' => 'asc'
    ),
    
    // Date
    array(
        'field' => 'transdate',
        'headerName' => findtekst('635|Dato', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
		 'align' => 'center',
        'sortable' => true,
        'searchable' => true,
		"sqlOverride" => "k.transdate",
        'valueGetter' => function($value, $row, $column) {
            return dkdato($value);
        },
	 'generateSearch' => function ($column, $term) {
        return generateSearch($column, $term);
      },
    ),
    
    // Description
    array(
        'field' => 'beskrivelse',
        'headerName' => findtekst('1068|Bilagstekst', $sprog_id),
        'type' => 'text',
        'width' => '3',
        'sortable' => false,
        'searchable' => true
    ),
    
    // D/K Type for Debet
    array(
        'field' => 'd_type',
        'headerName' => 'D/K',
        'type' => 'text',
        'width' => '0.5',
        'align' => 'center',
        'sortable' => false,
        'searchable' => false
    ),
    
    // Debet
    array(
        'field' => 'debet',
        'headerName' => findtekst('1000|Debet', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
        'align' => 'left',
        'sortable' => true,
       'defaultSort' => true,
		"sqlOverride" => "k.debet",
		"valueGetter" => function ($value, $row, $column) {
			return $value;
		},
		"generateSearch" => function ($column, $term) {
			$field = $column['sqlOverride'] ? $column['sqlOverride'] : $column['field'];
			$term = db_escape_string(trim($term, "'"));
			
			if (empty($term)) {
				return "1=1";
			}
			
			// Cast integer field to text for ILIKE search
			return "$field::text ILIKE '%$term%'";
		},
        'defaultSortDirection' => 'asc'
    ),
    
    // D/K Type for Kredit
    array(
        'field' => 'k_type',
        'headerName' => 'D/K',
        'type' => 'text',
        'width' => '0.5',
        'align' => 'center',
        'sortable' => false,
        'searchable' => false
    ),
    
    // Kredit
    array(
        'field' => 'kredit',
        'headerName' => findtekst('1001|Kredit', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
        'align' => 'left',
         'sortable' => true,
        'defaultSort' => true,
		"sqlOverride" => "k.kredit",
		"valueGetter" => function ($value, $row, $column) {
			return $value;
		},
		"generateSearch" => function ($column, $term) {
			$field = $column['sqlOverride'] ? $column['sqlOverride'] : $column['field'];
			$term = db_escape_string(trim($term, "'"));
			
			if (empty($term)) {
				return "1=1";
			}
			
			// Cast integer field to text for ILIKE search
			return "$field::text ILIKE '%$term%'";
		},
        'defaultSortDirection' => 'asc'
    ),
    
    // Faktura
    array(
        'field' => 'faktura',
        'headerName' => findtekst('828|Fakturanr.', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
        'align' => 'right',
        'sortable' => false,
        'searchable' => true
    ),
    
    // Amount/Beløb
    array(
        'field' => 'belob',
        'headerName' => findtekst('934|Beløb', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
        'align' => 'right',
        'sortable' => true,
        'searchable' => true,
        // 'decimalPrecision' => 2,
       'defaultSort' => true,
		"sqlOverride" => "k.amount",
		"valueGetter" => function ($value, $row, $column) {
			return $value;
		},
		"generateSearch" => function ($column, $term) {
			$field = $column['sqlOverride'] ? $column['sqlOverride'] : $column['field'];
			$term = db_escape_string(trim($term, "'"));
			
			if (empty($term)) {
				return "1=1";
			}
			
			// Cast integer field to text for ILIKE search
			return "$field::text ILIKE '%$term%'";
		},
        'defaultSortDirection' => 'asc'
    ),
    
    // Afdeling (if visible)
    array(
        'headerName' => findtekst('2464|Afd.', $sprog_id),
        'type' => 'number',
        'width' => '1',
        'align' => 'right',
			'sortable' => false,
        'searchable' => false,
        'hidden' => !$vis_afd
	
    ),
    
    // Ansat (if visible)
    array(
        'headerName' => findtekst('589|Ansat', $sprog_id),
        'type' => 'text',
        'width' => '1',
        'hidden' => !$vis_ansat,
		 'sortable' => false,
        'searchable' => false
    ),
    
    // Projekt (if visible)
    array(
        'headerName' => 'Proj.',
        'type' => 'number',
        'width' => '1',
        'align' => 'right',
		 'sortable' => false,
        'searchable' => false,
        'hidden' => !$vis_projekt
		
    ),
    
    // Valuta (if visible)
    array(
        'headerName' => findtekst('1069|Valuta', $sprog_id),
        'type' => 'text',
        'width' => '1',
        'hidden' => !$vis_valuta,
		 'sortable' => false,
        'searchable' => false
        
    ),
    
    // Forfald (if there are debitor/kreditor entries)
    array(
        'field' => 'forfaldsdate',
        'headerName' => findtekst('1070|Forfald', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
        'sortable' => true,
        'searchable' => true,
        "sqlOverride" => "k.forfaldsdate",
        'valueGetter' => function($value, $row, $column) {
            return dkdato($value);
        },
		'generateSearch' => function ($column, $term) {
			return generateSearch($column, $term);
		},
    ),
    
    // Betalings-ID (if visible)
    array(
        'field' => 'betal_id',
        'headerName' => findtekst('2534|Betalings-ID', $sprog_id),
        'type' => 'text',
        'width' => '1.5',
         'sortable' => false,
        'searchable' => false,
        'hidden' => !($vis_forfald && $vis_bet_id)
    ),
    
    // Momsfri
    array(
        'field' => 'momsfri',
        'headerName' => findtekst('2589|u/m', $sprog_id),
        'type' => 'text',
        'width' => '0.5',
        'align' => 'center',
        'sortable' => false,
        'searchable' => false,
        'render' => function($value, $row, $column) {
            return "<td align='center'>" . (strstr($value, 'on') ? 'V' : '') . "</td>";
        }
    ),
    
    // Position
    array(
        'field' => 'pos',
        'headerName' => 'Position',
        'type' => 'text',
        'width' => '1',
        'align' => 'center',
         'sortable' => false,
        'searchable' => false
    )
);
##########
function generateSearch(array $column, string $term): string
{
    $field = !empty($column['sqlOverride']) ? $column['sqlOverride'] : $column['field'];
    $term  = trim($term);

    if ($term === '') {
        return "1=1";
    }

    // single date
    if (preg_match('/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/', $term, $matches)) {
        $sqlDate = db_escape_string(
            $matches[3] . '-' .
            str_pad($matches[2], 2, '0', STR_PAD_LEFT) . '-' .
            str_pad($matches[1], 2, '0', STR_PAD_LEFT)
        );
        return "$field = '$sqlDate'";
    }

    // date range
    if (strpos($term, ':') !== false) {
        [$date1, $date2] = array_map('trim', explode(':', $term, 2));

        if ($date1 === '' || $date2 === '') {
            return "1=1";
        }

        if (preg_match('/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/', $date1, $m1)) {
            $date1 = $m1[3] . '-' . str_pad($m1[2], 2, '0', STR_PAD_LEFT) . '-' . str_pad($m1[1], 2, '0', STR_PAD_LEFT);
        }

        if (preg_match('/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/', $date2, $m2)) {
            $date2 = $m2[3] . '-' . str_pad($m2[2], 2, '0', STR_PAD_LEFT) . '-' . str_pad($m2[1], 2, '0', STR_PAD_LEFT);
        }

        return sprintf(
            "%s >= '%s' AND %s <= '%s'",
            $field,
            db_escape_string($date1),
            $field,
            db_escape_string($date2)
        );
    }

    $term = db_escape_string($term);
    return "$field::text ILIKE '%$term%'";
}

#########
// Add metaColumn for undo button if bogført
$metaColumnFn = null;
if (!$udskriv && $bogfort != 'S') {
    $metaColumnFn = function($row) use ($kladde_id) {
		global $sprog_id;
        $id = $row['id'];
        return "<td title='" . findtekst('1574|Tilbagefør postering', $sprog_id) . "'>
            <a href='../finans/kassekladde.php?kladde_id=$kladde_id&ompost=$id' id='undo'>
            <img alt='undo' src='../ikoner/undo.png' style='border: 0px solid; width: 18px; height: 17px;'></a>
        </td>";
    };
}

$metaColumnHeaders = array();
if (!$udskriv && $bogfort != 'S') {
    $metaColumnHeaders[] = ''; // Empty header for undo button column
}

// Define filters 
$filters = array();

// Build the grid data structure
$grid_data = array(
    'query' => build_kassekladde_query($kladde_id, $kksort),
    'columns' => $columns,
    'filters' => $filters,
    'metaColumn' => $metaColumnFn,           
    'metaColumnHeaders' => $metaColumnHeaders  
);

// Add row styling function if kontrolkonto is set
$rowStyleFn = null;
if ($kontrolkonto) {
    $rowStyleFn = function($row) {
        // Add any special row styling
        return '';
    };
}
###############################
print '<style>
   
    /* Sticky footer for action buttons */
    .kassekladde-footer {
        position: sticky;
        bottom: 0;
        background-color: #f1f1f1;
        z-index: 9;
        padding: 8px 0;
        border-top: 1px solid #ccc;
    }

    /* Print styles */
    @media print {
        /* Hide navigation and non-essential elements - including Saldi framework elements */
        .sidebar,
        .side-menu,
        .left-menu,
        #sidebar,
        #side-menu,
        #left-menu,
        nav,
        .nav,
        .navigation,
        .top-menu,
        #top-menu,
        .top-header,
        .kassekladde-note-tb,
        .table-con,
        .header-row,
        .kassekladde-footer,
        #header,
        .headerbtnLft,
        .headerbtnRght,
        .content-noside > div:first-child,
        form input[type="submit"],
        form input[type="button"],
        .button,
        a[href*="print"],
        #questionmark,
        footer,
        .footer,
        #footer,
        .top_menu,
        #top_menu,
        .side_menu,
        #side_menu,
        .fixedFooter,
        #footer-box,
        /* Saldi framework specific elements */
        .navbar,
        .logobar,
        .menuBar,
        .dropdownMenu,
        .dropDown,
        .dropDownbtn,
        .dropdownContent-Fin,
        .dropdownContent-Kun,
        .dropdownContent-Lev,
        .dropdownContent-Lag,
        .dropdownContent-Sys,
        .dropdownContent-Bru,
        .logo-link,
        .logo-container,
        .logo,
        .logo-name,
        .logoimg,
        .leftmenuholder,
        .leftmenu,
        .leftmenuhead,
        #leftmenuholder {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            min-height: 0 !important;
            max-height: 0 !important;
            overflow: hidden !important;
            width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Reset sticky and fixed positioning */
        .kassekladde-thead {
            position: static !important;
            background-color: transparent !important;
        }
        
        * {
            position: static !important;
            box-sizing: border-box !important;
        }
        
        /* Critical fix for Chrome blank page issue */
        html, body {
            margin: 0 !important;
            padding: 10px !important;
            height: auto !important;
            min-height: 0 !important;
            max-height: none !important;
            overflow: visible !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .content-noside {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: auto !important;
            min-height: 0 !important;
        }
        
        /* Reset Saldi content container margins - .content has margin-top: 70px for fixed nav */
        .content {
            margin: 0 !important;
            margin-top: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: auto !important;
            min-height: 0 !important;
            min-width: 0 !important;
        }
        
        /* Flex container reset */
        .flex-container {
            display: block !important;
            min-width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            justify-content: initial !important;
        }
        
        /* Fix table height issues that cause blank pages */
        table {
            width: 100% !important;
            height: auto !important;
            min-height: 0 !important;
            page-break-inside: auto;
            border-collapse: collapse;
        }
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
            height: auto !important;
        }
        thead {
            display: table-header-group;
        }
        td, th {
            overflow: visible !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            text-overflow: clip !important;
            padding: 4px 8px !important;
            max-width: none !important;
            height: auto !important;
        }
        
        /* Critical fix for outerTable height=100% HTML attribute */
        .outerTable,
        .outerTable tbody,
        .outerTable tr,
        .outerTable td {
            height: auto !important;
            min-height: 0 !important;
        }
        
        /* Reset any div with height: 100% */
        div.vindue,
        .print-view,
        div {
            height: auto !important;
            min-height: 0 !important;
        }
        
        /* Global table reset for print - remove all borders */
        table, tr, td, th {
            border: none !important;
            border-collapse: collapse !important;
        }

        /* Ensure data table is visible and properly styled */
        .dataTable, .dataTableForm, .outerTable, .formnavi, .print-view table {
            display: table !important; /* Restore table display to prevent clipping */
            border-collapse: collapse !important;
            border: none !important;
            height: auto !important;
            min-height: 0 !important;
            width: 100% !important;
            font-size: 7pt !important; /* Further reduced font size to fit all 16 columns */
            table-layout: auto !important; /* Allow browser to balance column widths */
        }
        
        .dataTable td, .dataTableForm td, .outerTable td, .formnavi td, .print-view td,
        .dataTable th, .dataTableForm th, .outerTable th, .formnavi th, .print-view th {
            border: none !important;
            border-bottom: 1px solid #eee !important;
            background-color: transparent !important;
            padding: 2px 1px !important; /* Minimal padding */
            word-wrap: break-word !important;
        }

        /* Target the description/text column specifically to prevent it from being too wide */
        .dataTable td:nth-child(3), .dataTableForm td:nth-child(3) {
            max-width: 200px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .dataTable th, .dataTableForm th, .outerTable th, .formnavi th, .print-view th {
            background-color: #f2f2f2 !important;
            font-weight: bold !important;
            text-align: left !important;
            border-bottom: 2px solid #ccc !important;
            white-space: nowrap !important;
        }

        /* Zebra striping for rows */
        .dataTable tbody tr:nth-child(even), 
        .dataTableForm tbody tr:nth-child(even),
        .formnavi tbody tr:nth-child(even),
        .print-view tbody tr:nth-child(even),
        tr.table-row:nth-child(even) {
            background-color: #f2f2f2 !important;
        }

        /* Restore columns previously hidden */
        .drag-handle, .clip-cell, .clip-icon {
            display: table-cell !important; /* Restore visibility */
            width: auto !important;
            padding: 2px !important;
        }

        /* Remove input borders and backgrounds in print */
        input.inputbox, select.inputbox, input[type="text"], input[type="checkbox"], input[type="button"], input[type="submit"] {
            border: none !important;
            background: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            color: black !important;
            width: 100% !important; /* Allow inputs to fill cell width */
            min-width: 0 !important;
        }
        
        /* Ensure all content is visible */
        .formnavi, .dataTableForm, .kassekladde-scroll-container, .print-view {
            overflow: visible !important;
            height: auto !important;
            min-height: 0 !important;
            display: block !important;
            width: 100% !important;
        }
        
        .kassekladde-scroll-container {
            display: block !important;
        }
        
        /* Hide top menu and navigation bars */
        .logobar,
        .navbar,
        .menuBar,
        .dropdownMenu,
        .logo-bg,
        .logo,
        .logo-container,
        .content-noside > .headLink,
        .top-header-container {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            min-height: 0 !important;
        }
        
        /* Force override of HTML height attributes on tables */
        table[height] {
            height: auto !important;
            min-height: 0 !important;
        }
        
        /* Additional body reset */
        body {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }
        
        /* Switch to landscape orientation to fit all columns */
        @page {
            size: landscape;
            margin: 0.5cm;
        }
    }
		
</style>';
//For grid print, use the customized grid print.
  print "<script>
// No override for window.print to allow native browser print dialog
</script>";

##################

if (!$udskriv) {
$action_url = "../finans/kassekladde.php?kksort=$kksort";
if ($kladde_id) {
    $action_url .= "&kladde_id=$kladde_id";
}
if ($tjek) {
    $action_url .= "&tjek=$tjek";
}
	print "<form name='kassekladde' id='kassekladde' action='$action_url' method='post'>";
print "<input type='hidden' name='kladde_id' value='$kladde_id'>";
print "<input type='hidden' name='kladdenote' value='$kladdenote'>";
print "<tr><td width='100%' valign='top' height='1%' align='center' class='kassekladde-note-tb'>
       <table width='100%' cellpadding='0' cellspacing='0' border='0' align='center' valign='top'>";
print "<tbody>"; # Tabel 1.2 -> bemærkningstekst  
print "<tr style='vertical-align: middle;'>"; # Added vertical-align
print "<td width='14%'></td>";
print "<td align='left' style='white-space: nowrap;'><b><span title='" . findtekst('1559|Her kan skrives en bemærkning til kladden', $sprog_id) . "'>" . findtekst('599|Bemærkning', $sprog_id) . ":</span></b>
<input class='inputbox' type='text' style='width:750px; vertical-align: middle;' name='ny_kladdenote' value='$kladdenote'
onchange='javascript:docChange = true;'></td>";
if ($bogfort == "-") {
	$page_display = false;
    if (!isset($kontrolkonto) && isset($_COOKIE['saldi_ktrkto'])) $kontrolkonto = $_COOKIE['saldi_ktrkto'];
    if ($kontrolkonto == "-") $kontrolkonto = "";
    print "<td style='padding-left: 10px;'></td><td style='vertical-align: middle;'><span title='" . findtekst('1560|Angiv kontonummer til kontrol af kontobevægelser', $sprog_id) . "'><input class='inputbox' type='text' style='text-align:right;width:80px; vertical-align: middle;' name='kontrolkonto' value='$kontrolkonto' placeholder='kontrolkonto' onchange='javascript:docChange = true;'></span></td>";
} else {
    print "<td style='padding-left: 10px;'></td><td width='120px' align='left' style='vertical-align: middle;'><span title='" . findtekst('1561|Klik her for at opdatere', $sprog_id) . "'><input type='submit' class='button gray small' style='width:120px; vertical-align: middle;' accesskey='o' value='" . findtekst('898|Opdatér', $sprog_id) . "' name='updateNote' onclick='javascript:docChange = false;'></span></td>";
}
print "<td width='7%' align='center' style='vertical-align: middle;'>
    <a href='javascript:void(0)' onclick='window.print(); return false;'>
    <img src='../ikoner/print.png' style='border: 0px solid; vertical-align: middle;' title='Print'></a></td>
    <td width='7%' align='center' style='vertical-align: middle;'><a href='https://saldi.dk/dok/ledgerGuide.pdf' target='_blank' id='questionmark'>?</a></td></tr>\n";
print "</tbody></table>"; # Tabel 1.2 <- bemærkningstekst
	#}
	
}
if ($udskriv)
	print "<tr><td style='width:100%;'>";
else
	print "<tr><td style='height:100%;width:100%;'>";

##########################
// Create the datagrid
if (($bogfort && $bogfort != '-') || $udskriv) {
   # echo "<center>";
    if (!$udskriv) {  // Close the form if it's open Searches don't work without this
        print "</form>";
    }
	print "<div style='width: 100%; height: calc(98vh - 34px - 18px);'>";
		create_datagrid("kass_$brugernavn", $grid_data);
	print "</div>";
	########
	 // Add preserved parameters 
    echo <<<SCRIPT
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('#datatable-wrapper-kass_$brugernavn form');
        if (form) {
            // Add kladde_id
            const kladdeInput = document.createElement('input');
            kladdeInput.type = 'hidden';
            kladdeInput.name = 'kladde_id';
            kladdeInput.value = '$kladde_id';
            form.appendChild(kladdeInput);
            
            // Add tjek
            const tjekInput = document.createElement('input');
            tjekInput.type = 'hidden';
            tjekInput.name = 'tjek';
            tjekInput.value = '$tjek';
            form.appendChild(tjekInput);
        }
    });
    </script>
SCRIPT;
	########
	
	
}else{
	if($bogfort != 'V' ){
		print "<div class='kassekladde-scroll-container'>";  
		print "<center><table cellpadding='0' cellspacing='0' border='0' align = 'center' class='formnavi dataTableForm'>";
		
		// print "<tbody>"; # Tabel 1.3 -> kladdelinjer
		// print "<tbody id='kassekladde-tbody'>"; # Tabel 1.3 -> kladdelinjer
		print "<thead class='kassekladde-thead'>"; # Tabel 1.3 -> kladdelinjer

		print "<tr>";
		if ($vis_bilag && !$fejl && !$udskriv)
			print "<td></td>";
		print "<td align = center><b><span title= '" . findtekst('1562|Skriv - (minus) for at slette en linje', $sprog_id) . "'><a href=../finans/kassekladde.php?kladde_id=$kladde_id&kksort=bilag,transdate&tjek=$kladde_id>" . findtekst('671|Bilag', $sprog_id) . "</a></b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1563|Angiv dato som ddmmyy (f.eks 241205)', $sprog_id) . "'><a href=../finans/kassekladde.php?kladde_id=$kladde_id&kksort=transdate,bilag&tjek=$kladde_id>" . findtekst('635|Dato', $sprog_id) . "</a></b></td>";
		print "<td align = center><b> " . findtekst('1068|Bilagstekst', $sprog_id) . "</b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1564|Angiv D for debitor, K for kreditor eller F for finanspostering', $sprog_id) . "'>D/K</b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1565|Skriv D eller K og klik på [Opslag] for opslag i hhv, debitor- eller kreditorkartotek', $sprog_id) . "'>" . ucfirst(findtekst('1000|Debet', $sprog_id)) . "</b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1564|Angiv D for debitor, K for kreditor eller F for finanspostering', $sprog_id) . "'>D/K</b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1565|Skriv D eller K og klik på [Opslag] for opslag i hhv, debitor- eller kreditorkartotek', $sprog_id) . "'>" . ucfirst(findtekst('1001|Debet', $sprog_id)) . "</b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1566|Angiv fakturanummer - klik på opslag for at slå op i åbne poster. Skriv et minus her for at undertrykke automatisk udligning', $sprog_id) . ".'>" . findtekst('828|Fakturanr.', $sprog_id) . "</b></td>";
		print "<td align = center><b> <span title= '" . findtekst('1543|Angiv beløb - klik på opslag for at slå op i åbne poster', $sprog_id) . "'><a href=../finans/kassekladde.php?kladde_id=$kladde_id&kksort=amount&tjek=$kladde_id>" . findtekst('934|Beløb', $sprog_id) . "</a></b></td>"; #20210720

		if ($vis_afd)
			print "<td align = left><b> <span title= '" . findtekst('1567|Angiv hvilken afdeling posteringen hører under', $sprog_id) . "'>".findtekst('2464|Afd.', $sprog_id)."</b></td>";
		if ($vis_ansat)
			print "<td align = left><b> <span title= '" . findtekst('1568|Angiv hvilken ansat posteringen hører under', $sprog_id) . "'>" . findtekst('589|Ansat', $sprog_id) . "</b></td>";
		if ($vis_projekt)
			print "<td align = left><b> <span title= '" . findtekst('1569|Angiv hvilket projekt posteringen hører under', $sprog_id) . "'>Proj.</b></td>";
		if ($vis_valuta)
			print "<td align = left><b> <span title= '" . findtekst('1570|Angiv valuta for posteringen', $sprog_id) . "'>" . findtekst('1069|Valuta', $sprog_id) . "</b></td>";
		if (db_fetch_array(db_select("select id from kassekladde where kladde_id = '$kladde_id' and (k_type = 'K' or d_type = 'D')", __FILE__ . " linje " . __LINE__))) {
			print "<td  align='center'><b> <span title= '" . findtekst('1571|Betalingsdato for debitor- eller kreditorfaktura', $sprog_id) . "'>" . findtekst('1070|Forfald', $sprog_id) . "</b></td>";
			if ($vis_bet_id)
				print "<td  align='center'><b> <span title= '" . findtekst('1572|Betalings-ID fra girokort - kun nummeret skal skrives', $sprog_id) . "'>" . findtekst('2534|Betalings-ID', $sprog_id) . "</b></td>";
		}
		print "<td align='center' width='30px'><b> <span title= '" . findtekst('1573|Afmærk her, hvis der ikke skal trækkes moms', $sprog_id) . "'>".findtekst('2589|u/m', $sprog_id)."</b></td>";
		print "<td align='center' width='60px'><b>Position</b></td>";
		if ($kontrolkonto) {
			print "<td align='center' width='30px'><b>".findtekst('1073|Saldo', $sprog_id)."<br>".findtekst('2595|Regnskab', $sprog_id)."</b></td>"; #<span title='".findtekst('1573|Afmærk her, hvis der ikke skal trækkes moms', $sprog_id)."'>
			$qtxt = "select id from kassekladde where saldo != 0 and kladde_id = '$kladde_id'";
			if (db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				print "<td style = 'width:20px'></td>";
				print "<td align='center' width='30px'><b>".findtekst('1073|Saldo', $sprog_id)."<br>Bank</b></td>"; #<span title='".findtekst('1573|Afmærk her, hvis der ikke skal trækkes moms', $sprog_id)."'>
			}
		}
		print "<th style='width:0.51%;'></th>\n"; 
		#print "<td align='right' width='30px'><b> <span title= 'Afm&aelig;rk her, hvis der ikke skal tr&aelig;kkes moms'>&nbsp;u/m</b></td>";
		print "</tr>\n";

		print "</thead>";
		print "<tbody id='kassekladde-tbody'>"; # Tabel 1.3 -> kladdelinjer
		print "<tr class='table-row'><td colspan='7' style='padding: 20px 0;'></td></tr>";


    }

	   
}
#####################################  Output  #################################


###################

$r = db_fetch_array(db_select("select * from grupper where ART = 'KASKL' and kode='1' and kodenr='$bruger_id'", __FILE__ . " linje " . __LINE__));

if ($r)
	$kksort = $r['box1'];
if ($r) $kontrolkonto = $r['box2'];
if ($kladde_id) {
	if ($kksort != 'transdate,bilag' && $kksort != 'amount')
		$kksort = 'bilag,transdate';
	$id = array();
	$bilag = array();
	$dato = array();
	$beskrivelse = array();
	$d_type = array();
	$debet = array();
	$k_type = array();
	$kredit = array();
	$faktura = array();
	$belob = array();
	$afd = array();
	$ansat = array();
	$ansat_id = array();
	$projekt = array();
	$valuta = array();
	$forfaldsdato = array();
	$betal_id = array();
	$momsfri = array();
	if ($popup)
		print "<meta http-equiv='refresh' content='3600;URL=../includes/luk.php?tabel=kladdeliste&id=$kladde_id'>";
	else
		print "<meta http-equiv='refresh' content='3600;URL=../finans/kladdeliste.php?tabel=kladdeliste&id=$kladde_id'>";

	print "<script>
	document.addEventListener('DOMContentLoaded', function() { 
		console.log('CONTENT LOAD');
		var element = document.body;
		var scrollpos = localStorage.getItem('kassekladde-$kladde_id');
		if (scrollpos && element) {
			element.scrollTo(0, parseInt(scrollpos, 10));
		}
	});

	function saveScrollPosition() {
		var element = document.body;
		if (element) {
			var scrollKey = 'kassekladde-$kladde_id';
			localStorage.setItem(scrollKey, element.scrollTop);
			console.log('Scroll position saved:', element.scrollTop);
		}
	}
	
	document.addEventListener('visibilitychange', function() {
		if (document.visibilityState === 'hidden') {
			saveScrollPosition();
		}
	});
	
	window.addEventListener('beforeunload', function() {
		saveScrollPosition();
	});
	
	</script>";

	$qtxt = "select * from tmpkassekl where kladde_id = $kladde_id order by lobenr";
	$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	if ($row = db_fetch_array($q)) {
		$qtxt = "select * from tmpkassekl where kladde_id = $kladde_id order by lobenr";
		$fejl = 1;
	} else {
		// $qtxt = "select * from kassekladde where kladde_id = $kladde_id order by $kksort, id";
if ($kksort == 'bilag,transdate') {
    $qtxt = "select * from kassekladde where kladde_id = $kladde_id order by bilag, transdate, pos, id";
} else {
    $qtxt = "select * from kassekladde where kladde_id = $kladde_id order by $kksort, pos, id";
}
	}
	#cho __line__." $qtxt<br>";
	$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	$bilagssum = 0;
	$x = 0;
	#cho __line__." $qtxt<br>";
	while ($row = db_fetch_array($q)) {
		$x++;
		$id[$x] = $row['id'];
		$bilag[$x] = $row['bilag'];
		$forfaldsdato[$x] = NULL;
		if ($fejl) {
			$transdate[$x] = usdate($row['transdate']);
			$dato[$x] = dkdato($transdate[$x]);
#			echo __line__." $row[transdate] | transdate[$x] $transdate[$x] | dato[$x] $dato[$x]<br>";
			if ($row['forfaldsdate']) {
				$forfaldsdate[$x] = usdate($row['forfaldsdate']);
				$forfaldsdato[$x] = $row['forfaldsdate'];
			}
			$amount[$x] = usdecimal($row['amount']);
		} else {
			$transdate[$x] = $row['transdate'];
			$dato[$x] = dkdato($row['transdate']);
			#cho __line__." transdate[$x] $transdate[$x] | dato[$x] $dato[$x]<br>";
			if ($row['forfaldsdate']) {
				$forfaldsdate[$x] = $row['forfaldsdate'];
				$forfaldsdato[$x] = dkdato($row['forfaldsdate']);
			}
			$amount[$x] = $row['amount'];
		}
		#		$beskrivelse[$x]=htmlentities($row['beskrivelse'],ENT_QUOTES,$charset);
		$beskrivelse[$x] = $row['beskrivelse'];
		while (strpos($beskrivelse[$x], "''"))
			$beskrivelse[$x] = str_replace("''", "'", $beskrivelse[$x]); #20130731
		$beskrivelse[$x] = htmlentities($beskrivelse[$x], ENT_QUOTES, $charset);
		$dokument[$x] = $row['dokument']; # ligger allerede med htmlentities i tabellen;
		$d_type[$x] = trim($row['d_type']);
		$debet[$x] = $row['debet'];
		$debettext[$x] = NULL;
		$k_type[$x] = $row['k_type'];
		if ($k_type[$x] == "K" || $d_type[$x] == "D")
			$vis_forfald = 1;
		$kredit[$x] = $row['kredit'];
		$kredittext[$x] = NULL;
		$faktura[$x] = htmlentities($row['faktura'], ENT_QUOTES, $charset);
		$saldo[$x] = $row['saldo'];
		if ($fejl) {
			#			$belob[$x]=$amount[$x];
#			$amount[$x]=usdecimal($amount[$x],2);
		} #else $belob[$x]=dkdecimal($amount[$x],2);
		$momsfri[$x] = $row['momsfri'];
		$afd[$x] = $row['afd'];
		if ($fejl)
			$ansat[$x] = $row['ansat'];
		else
			$ansat_id[$x] = $row['ansat'];
		if (!$fejl && $ansat_id[$x]) {
			$r2 = db_fetch_array(db_select("select navn, initialer from ansatte where id='$ansat_id[$x]'", __FILE__ . " linje " . __LINE__));
			$ansat[$x] = $r2['initialer'];
			$ansat_navn[$x] = $r2['navn'];
		} elseif (!$fejl)
			$ansat[$x] = '';
		($row['projekt']) ? $projekt[$x] = $row['projekt'] : $projekt[$x] = '';
		$valutakode[$x] = (int)$row['valuta'];
		if ($valutakode[$x]) {
			$qtxt = "select box1 from grupper where art='VK' and kodenr ='$valutakode[$x]'";
			$r2 = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
			$valuta[$x] = $r2['box1'];
		}
		if (!isset($valuta[$x]) || $valuta[$x] == $baseCurrency) $dkkamount[$x] = $amount[$x]; #20240419
		elseif ($valutakode[$x]) {
			list($dkkamount[$x], $diffkonto[$x], $valutakurs[$x]) = valutaopslag($amount[$x], $valutakode[$x], $transdate[$x]);
		} else $dkkamount[$x] = (float) $amount[$x];
		if (!$beskrivelse) $beskrivelse = '';
		if (($d_type[$x] == 'F') && ($debet[$x]) && (!$fejl)) {
			$query2 = db_select("select beskrivelse, moms from kontoplan where kontonr='$debet[$x]' and regnskabsaar='$regnaar'", __FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2)) {
				$debettext[$x] = $row2['beskrivelse'];
				if (trim($row2['moms']))
					$debettext[$x] = $debettext[$x] . "&nbsp;-&nbsp;" . trim($row2['moms']);
			} else
				$debettext[$x] = '';
		}
		if ((($d_type[$x] == 'D') || ($d_type[$x] == 'K')) && ($debet[$x]) && (!$fejl)) {
			$query2 = db_select("select firmanavn,betalingsbet,betalingsdage from adresser where kontonr='$debet[$x]' and art = '$d_type[$x]'", __FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2)) {
				$debettext[$x] = trim($row2['firmanavn']);
				$tmpffdato = forfaldsdag($transdate[$x], $row2['betalingsbet'], $row2['betalingsdage']);
			} else
				$debettext[$x] = '';
		}
		if (($k_type[$x] == 'F') && ($kredit[$x]) && (!$fejl)) {
			$query2 = db_select("select beskrivelse, moms from kontoplan where kontonr='$kredit[$x]' and regnskabsaar='$regnaar'", __FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2)) {
				$kredittext[$x] = trim($row2['beskrivelse']);
				if (trim($row2['moms']))
					$kredittext[$x] = $kredittext[$x] . "&nbsp;-&nbsp;" . trim($row2['moms']);
			} else
				$kredittext[$x] = '';
		}
		if ((($k_type[$x] == 'D') || ($k_type[$x] == 'K')) && ($kredit[$x]) && (!$fejl)) {
			$query2 = db_select("select firmanavn,betalingsbet,betalingsdage from adresser where kontonr='$kredit[$x]' and art = '$k_type[$x]'", __FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2))
				$kredittext[$x] = trim($row2['firmanavn']);
			else
				$kredittext[$x] = '';
			$tmpffdato = forfaldsdag($transdate[$x], $row2['betalingsbet'], $row2['betalingsdage']);
		}
		if (!isset($gl_transdate[$x]))
			$gl_transdate[$x] = NULL;
		if ((($d_type[$x] == 'D' && $debet[$x]) || ($k_type[$x] == 'K' && $kredit[$x])) && !$fejl && $gl_transdate[$x] && (!$forfaldsdato[$x] || $gl_transdate[$x] != $transdate[$x])) { #20140624
			$forfaldsdato[$x] = $tmpffdato;
		}
		$betal_id[$x] = $row['betal_id'];
		$pos[$x] = $row['pos'] ? $row['pos'] : 0;
	}
	if (!$fejl)
		db_modify("delete from tmpkassekl where kladde_id=$kladde_id", __FILE__ . " linje " . __LINE__);
}


for ($y = 1; $y <= $x; $y++){
	if (!$fejl)
		$antal_ex = $x;
}

if (($bogfort && $bogfort != '-') || $udskriv) {
	
	#now uses grid
} else { ################################ Kladden er ikke bogfort ########################################

	$debetsum = $kontrolmoms = $kontrolsaldo = $kreditsum = 0;
	include_once("../includes/stdFunc/fiscalYear.php");
	list($regnstart, $regnslut) = explode(":", fiscalYear($regnaar));

	if ($menu == 'T') {
		$de_fok = "";
	} else {
		$de_fok="onfocus=\"fokuser(this,'#000000','#EFEFEF');\" onblur=\"defokuser(this,'#000000','#FFFFFF');\"";
	}
	if ($kontrolkonto) {
		$control_next_date = '9999-12-31';
		$kontrolkonto = $kontrolkonto * 1;
		$qtxt = "select saldo,moms from kontoplan where kontonr='$kontrolkonto' and regnskabsaar='$regnaar'";
#		$qtxt = "select primo,moms from kontoplan where kontonr='$kontrolkonto' and regnskabsaar='$regnaar'";
		if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
			$kontrolsaldo = $r['saldo'];
#			$kontrolsaldo = $r['primo'];
			if ($r['moms']) {
				$r2 = db_fetch_array(db_select("select box2 from grupper where
						kode='" . substr($r['moms'], 0, 1) . "' and
						kodenr='" . substr($r['moms'], 1, 1) . "'", __FILE__ . " linje " . __LINE__));
				$kontrolmoms = $r['box2'] * 1;
			}
		}
/*
		$q = db_select("select transdate from transaktioner where kontonr='$kontrolkonto' order by transdate desc limit 1", __FILE__ . " linje " . __LINE__);
		if ($r = db_fetch_array($q)) {
			$control_bal_last = $r['transdate'];
		} else {
			$control_bal_last = "1970-01-01";
		}
*/
	}
	if (!isset($bilag[0]))      $bilag[0]      = 0;
	if (!isset($bilag[$x + 1])) $bilag[$x + 1] = 0;
	if (!isset($dato[0]))       $dato[0]       = NULL;
	if (!isset($dato[$x + 1]))  $dato[$x + 1]  = NULL;
	for ($y = 1; $y <= $x; $y++) {
		if (!isset($bilag[$y]))      $bilag[$y]      = 0;
		if (!isset($dato[$y]))       $dato[$y]       = NULL;
		if (!isset($kredit[$y]))     $kredit[$y]     = NULL;
		if (!isset($debet[$y]))      $debet[$y]      = NULL;
		if (!isset($kredittext[$y])) $kredittext[$y] = NULL;
		if (!isset($debettext[$y]))  $debettext[$y]  = NULL;
		$amount[$y] = (float) $amount[$y];
		# 20251217 OLD CODE - only cleared fields when there was no error, but rows with bilag="-" should always be cleared
		# if ((!$fejl) && ((($bilag[$y]) == "-") || (!$bilag[$y]) && (!$dato[$y]))) {
		# 20251217 NEW CODE - Clear fields for rows marked for deletion (bilag = "-") regardless of error state
		if ((($bilag[$y]) == "-") || ((!$fejl) && (!$bilag[$y]) && (!$dato[$y]))) {
			$bilag[$y] = $dato[$y] = $beskrivelse[$y] = $d_type[$y] = $debet[$y] = $k_type[$y] = $kredit[$y] = $faktura[$y] = '';
			$belob[$y] = $momsfri[$y] = '';
			$amount[$y] = ''; # 20251217 Also clear amount to prevent "0,00" from showing
			$afd[$y] = '';
			$projekt[$y] = '';
			$valuta[$y] = '';
			$forfaldsdato[$y] = '';
			$betal_id[$y] = '';
		}
		if ($fejl && !$dato[$y] && !$beskrivelse[$y] && !$debet[$y] && !$kredit[$y] && !$faktura[$y] && !$belob[$y])
			$bilag[$y] = '';
		if (!$fejl && $debet[$y] < 1)
			$debet[$y] = "";
		if (!$fejl && $kredit[$y] < 1)
			$kredit[$y] = "";
		if ($fejl)
#			$amount[$y] = usdecimal($amount[$y], 2); # phr 20070801
		if (!$debet[$y])
			$debet[$y] = "";
		if (!$kredit[$y])
			$kredit[$y] = "";
		#		if($valuta[$y]&&$valuta[$y]!=$baseCurrency) {
#		if ($r=db_fetch_array(db_select("select kodenr from grupper where art='VK' and box1='$valuta[$y]'",__FILE__ . " linje " . __LINE__))) {
#			if ($r=db_fetch_array(db_select("select kurs from valuta where gruppe='$r[kodenr]' and valdate < '$transdate[$y]' order by valdate desc",__FILE__ . " linje " . __LINE__))) {
#				$dk_amount=$amount[$y]*$r['kurs']/100;
#				} else $dk_amount=0;
#			} else $dk_amount=$amount[$y];
#		} else $dk_amount=$amount[$y];
		if ($momsfri[$y] || !$kontrolmoms)
			$tmp = 1;
		else
			$tmp = (100 + $kontrolmoms) / 100;

		if ($kontrolkonto) {

			if ($d_type[$y] == 'F' && $debet[$y] == $kontrolkonto) {
				$kontrolsaldo += $dkkamount[$y] / $tmp; # 20230302
			}
			if ($k_type[$y] == 'F' && $kredit[$y] == $kontrolkonto) {
				$kontrolsaldo -= $dkkamount[$y] / $tmp; # 20230302
			}
#			if ($debet[$y] === '' && $kredit[$y] === '')	$kontrolsaldo = ''; #outcommented 20240401
		}

		if ($id[$y] && $debet[$y] && is_numeric($debet[$y]) && $kredit[$y] && is_numeric($kredit[$y]))
			list($dub_bilag[$y], $dub_kladde_id[$y]) = explode(",", find_dublet($id[$y], $transdate[$y], $d_type[$y], $debet[$y], $k_type[$y], $kredit[$y], $amount[$y], $faktura[$y]));
		print "<tr>";
		if ($vis_bilag && !$fejl && isset($id[$y])) { #### use
			$qtxt = "select id,filename,filepath from documents where source = 'kassekladde' and source_id = '$id[$y]' order by id limit 1";  //20230630
			$docRow = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
			$hasDoc = ($dokument[$y] || $docRow) ? true : false;
			if ($hasDoc) {
				$clip = 'paper.png';
				$titletxt =  findtekst('1454|klik her for at åbne bilaget', $sprog_id);
				// Document is attached - show document viewer with list of attachments for this line
				// Just pass sourceId - documents.php will check for documents and show the viewer
				$href = "../includes/documents.php?source=kassekladde&sourceId=$id[$y]&kladde_id=$kladde_id&bilag=$bilag[$y]&fokus=bila$y";
			} else {
				$clip = 'clip.png';
				$titletxt =  findtekst('1455|klik her for at vedhæfte et bilag', $sprog_id);
				// No document attached - go to pool to choose one
				$href = "../includes/documents.php?source=kassekladde&sourceId=$id[$y]&kladde_id=$kladde_id&bilag=$bilag[$y]&fokus=bila$y&openPool=1";
			}
			// Drag-and-drop attributes for linking documents between lines
			$dragAttr = $hasDoc ? "draggable='true' ondragstart='clipDragStart(event, $id[$y], \"" . htmlspecialchars($bilag[$y]) . "\")'" : "";
$dropAttr = "";
			$dropClass = $hasDoc ? "clip-has-doc" : "clip-no-doc";
			
			print "<td class='clip-cell $dropClass' data-source-id='$id[$y]' data-bilag='" . htmlspecialchars($bilag[$y]) . "' $dropAttr title='$titletxt'><!-- ". __line__ ." -->	";
			$txt = 'Obs - Du har ikke gemt.\n Hvis du klikker OK mistes de sidste ændringer';
			print "<a href=\"javascript:confirmClose('$href','$txt')\" accesskey='L' $dragAttr>";
#			print "<a href='../includes/documents.php?source=kassekladde&&ny=ja&sourceId=$id[$y]&kladde_id=$kladde_id&bilag=$bilag[$y]&bilag_id=$id[$y]&fokus=bila$y'>";
			print "<img src='../ikoner/$clip' style='width:20px;height:20px;cursor:" . ($hasDoc ? "grab" : "pointer") . ";' class='clip-icon' data-source-id='$id[$y]' data-bilag='" . htmlspecialchars($bilag[$y]) . "'></a></td>\n";
		}
		if (!isset($dub_bilag[$y]))
			$dub_bilag[$y] = 0;
		if (!isset($dub_kladde_id[$y]))
			$dub_kladde_id[$y] = 0;
		if ($dub_bilag[$y] && $dub_kladde_id[$y]) {
			$title = "title='" . findtekst('1575|En tilsvarende postering er også ført på kladde', $sprog_id) . " $dub_kladde_id[$y] med bilagsnummer $dub_bilag[$y]'";
			$color = "color:#FF0000;";
		} else {
			$title = NULL;
			$color = NULL;
		}
		// get last bilagsnr from database but check if the row already has asigned bilagnr
		$qtxt = "select bilag from kassekladde WHERE kladde_id = '$kladde_id'";
		$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
		if (db_num_rows($q) == 0){
			$qtxt = "select MAX(bilag) as bilag from kassekladde where transdate>='$regnstart' and transdate<='$regnslut'";
			$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
			if ($row = db_fetch_array($q)) $last_bilag = $row['bilag'];
			if ($y == 1) {
				$bilag[$y] = $last_bilag;
			}
		}
		echo "<script>console.log('bilag[$y]: " . $bilag[$y] . "');</script>";
		print "<td><input class='inputbox' $title type='text' style='text-align:right;width:80px;$color' name='bila$y' $de_fok value =\"$bilag[$y]\" onchange='javascript:docChange = true;'></td>";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name='dato$y' $de_fok value =\"$dato[$y]\" onchange='javascript:docChange = true;'></td>";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:300px;' name='besk$y' $de_fok value =\"$beskrivelse[$y]\" onchange='javascript:docChange = true;'></td>";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='d_ty$y' $de_fok value =\"$d_type[$y]\" onchange='javascript:docChange = true;'></td>";
		if (($k_type[$y] == 'D' || $k_type[$y] == 'K') && $kredit[$y] && !$debet[$y]) {
			$libtxt = sidste_5($kredit[$y], $k_type[$y], 'D');
			print "<td>
			<span onclick=\"return overlib('" . $libtxt . "', WIDTH=800);\" onmouseout='return nd();'>
			<input class='inputbox' type='text' style='text-align:right;width:75px;' name='debe$y' $de_fok value =\"$debet[$y]\" onchange='javascript:docChange = true;'>
			</span></td>\n";
		} else
			print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='debe$y' $de_fok value =\"$debet[$y]\" title='$debettext[$y]' onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='k_ty$y' $de_fok value =\"$k_type[$y]\" onchange='javascript:docChange = true;'></td>\n";
		if (($d_type[$y] == 'D' || $d_type[$y] == 'K') && $debet[$y] && !$kredit[$y]) {
			$libtxt = sidste_5($debet[$y], $d_type[$y], 'K');
			print "<td>
			<span onclick=\"return overlib('" . $libtxt . "', WIDTH=800);\" onmouseout='return nd();'>
			<input class='inputbox' type='text' style='text-align:right;width:75px;' name='kred$y' $de_fok value =\"$kredit[$y]\" onchange='javascript:docChange = true;'>
			</span></td>\n";
		} else
			print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='kred$y' $de_fok value =\"$kredit[$y]\" title= '$kredittext[$y]' onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='fakt$y' $de_fok value =\"$faktura[$y]\" onchange='javascript:docChange = true;'></td>\n";
		if (!isset($valuta[$y])) $valuta[$y] = $baseCurrency;
		if ($valuta[$y] == $baseCurrency) $title = "";
		else 	$title = "$baseCurrency: " . dkdecimal($dkkamount[$y], 2);
		print "<td title='$title'><input class='inputbox' type='text' style='text-align:right;width:100px;' name='belo$y' 
		$de_fok value ='" . dkdecimal($amount[$y], 2) . "' onchange='javascript:docChange = true;'></td>\n";
		if ($vis_afd) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='afd_$y' 
			$de_fok value =\"$afd[$y]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_ansat) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='meda$y' 
			$de_fok value =\"$ansat[$y]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_projekt) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='proj$y' 
			$de_fok value =\"$projekt[$y]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_valuta)
			print "<td><input class='inputbox' type='text' style='text-align:left;width:40px;' name='valu$y' $de_fok value =\"$valuta[$y]\" onchange='javascript:docChange = true;'></td>\n";
		if ($k_type[$y] == 'K' || $d_type[$y] == 'D') {
			print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name='forf$y' $de_fok value =\"$forfaldsdato[$y]\" onchange='javascript:docChange = true;'></td>\n";
			if ($vis_bet_id)
				print "<td><input class='inputbox' type='text' style='text-align:left;width:100px;' name='b_id$y' $de_fok value =\"$betal_id[$y]\" onchange='javascript:docChange = true;'></td>\n";
		} elseif ($vis_forfald) {
			print "<td><input class='inputbox' style='text-align:left;width:75px;' readonly='readonly'></td>\n";
			if ($vis_bet_id)
				print "<td><input class='inputbox' style='text-align:left;width:100px;' readonly='readonly'></td>\n";
		}
		if ($momsfri[$y] == 'on') {
			print "<td align='center'><input class='inputbox' type=checkbox name=moms$y checked onchange='javascript:docChange = true;' ></td>\n";

		} else {
			print "<td align='center'><input class='inputbox' type=checkbox name=moms$y onchange='javascript:docChange = true;'></td>\n";
		}

		#######
		print "<td class='drag-handle' style='cursor:move;'>&#x2630; " . (isset($pos[$y]) ? $pos[$y] : '') . "</td>";

		// Add Plus and Delete buttons
		print "<td style='text-align:center; white-space:nowrap;'>";

		// Plus button - always enabled
		print "<td style='text-align:center; white-space:nowrap;'>";

		$plusTitle = "Duplicate this line";  
		print "<button type='button' class='duplicate-line-btn' data-row='$y' data-id='$id[$y]' title='$plusTitle'>+</button>";

		// Delete button - disabled if document attached
		$qtxt = "SELECT id FROM documents WHERE source = 'kassekladde' AND source_id = '$id[$y]'";
		$hasDoc = ($dokument[$y] || db_fetch_array(db_select($qtxt, __FILE__ . " line " . __LINE__)));

		if ($hasDoc) {
			$deleteTitle = "Remove attached document first";  
			$deleteDisabled = "disabled";
		} else {
			$deleteTitle = "Delete this line";  
			$deleteDisabled = "";
		}

		print "<button type='button' class='delete-line-btn' data-row='$y' data-id='$id[$y]' title='$deleteTitle' $deleteDisabled>x</button>";

		print "</td>\n";

		print "</tr>\n";

		######

		if ($control_bal_fetched) {
			$titletxt = findtekst("Kontrolsaldo er nu beregnet fra ", $sprog_id); # "The control balance is calculated from "
			$titletxt .= $control_record_date;
			$titletxt .= findtekst(", fordi der blev bogført på kontrolkontoen denne dato!", $sprog_id); # " because there was transactions on the control account this date!"
			print "<td style='text-align:right;font-weight:bold' title='" . $titletxt . "'>" . dkdecimal($kontrolsaldo, 2) . "</td>\n";
			$control_bal_fetched = FALSE;
		} elseif ($kontrolkonto && $kontrolsaldo) {
			print "<td align=right>" . dkdecimal($kontrolsaldo, 2) . "</td>\n";
		}
		if ($kontrolkonto && abs((float)$saldo[$y]) > 0) {
			$saldoDiff = afrund($saldo[$y], 2) - afrund($kontrolsaldo, 2);
			($saldoDiff) ? $color = "style='color:red'" : $color = "style='color:black'";
			print "<td>&nbsp;</td><td align='right'><div $color>" . dkdecimal($saldo[$y]) . "</div></td>\n";
			if ($saldoDiff)
				print "<td>&nbsp;</td><td align='right'><div $color>(" . dkdecimal($saldoDiff) . ")</div></td>\n";
		}
		print "<input type=hidden name='id[$y]' value='$id[$y]'>";
		print "<input type=hidden name='dkka$y' value='$dkkamount[$y]'>";
		print "<input type=hidden name='transdate[$y]' value='$transdate[$y]'>";
		print "</tr>\n";
		if ($kksort == "bilag,transdate") {
			if ($bilag[$y] != $bilag[$y - 1]) {
				$debetsum = 0;
				$kreditsum = 0;
				$amount[$x + 1] = 0;
			}
			if ((($debet[$y]) || ($kredit[$y])) && ($amount[$y] > 0)) {
				if (($debet[$y]) || ($debet[$y] > 0))
					$debetsum = $debetsum + $dkkamount[$y];
				if (($kredit[$y]) || ($kredit[$y] > 0))
					$kreditsum = $kreditsum + $dkkamount[$y];
				if ((!$bilag[$x + 1]) || ($bilag[$x + 1] < $bilag[$y]))
					$bilag[$x + 1] = $bilag[$y];
				if (!$dato[$x + 1])
					$dato[$x + 1] = $dato[$y];
				$amount[$x + 1] = $debetsum - $kreditsum;
			}
		}
	}
	$aa = $x + 1;
	//if (!isset($amount[$x+1])) $amount[$x+1]=0;
	if (!array_key_exists($x + 1, $amount))
		$amount[$x + 1] = 0;
	if (abs($amount[$x + 1]) > 0.01) {
		// 20251218: Voucher NOT in balance - create auto-balance line with SAME bilag number
		$beskrivelse[$x + 1] = $beskrivelse[$x];
		$bilag[$x + 1] = $bilag[$x];
		//$dato[$x+1]=$dato[$x];
		isset($dato[$x]) && $dato[$x + 1] = $dato[$x];
		//$valuta[$x+1]=$valuta[$x]; #20121110 Rettet fra $valuta[$x+1]=$baseCurrency
		isset($valuta[$x]) && $valuta[$x + 1] = $valuta[$x];
	} else {
		// 20251218: Voucher IS in balance - clear the auto-balance line, prepare next bilag
		$amount[$x + 1] = '';
		$beskrivelse[$x + 1] = '';
		$bilag[$x + 1] = '';
		$dato[$x + 1] = '';
	} #end if(abs($amount[$x + 1]) > 0.01)

	if ($x > 20) {
		$y = $x + 5;
	} else {
		$y = 24;
	}
	$x++;
	if (!$amount[$x])    $amount[$x] = 0;
	if ($amount[$x] < 0) $amount[$x] = $amount[$x] * -1;
	if ($amount[$x])     $belob = dkdecimal($amount[$x], 2);
	else $belob = "";
	if (!isset($amount[$x - 1])) $amount[$x - 1] = 0;
	// 20251218 Modified: Only clear bilag/dato when voucher is balanced (amount[$x] near zero)
	// Previously checked $amount[$x - 1] which was wrong - should check $amount[$x] (the imbalance)
	if (abs($amount[$x]) < 0.01) {
		$bilag[$x] = "";
		$dato[$x] = "";
		$belob = "";
	}
	if ($fokus && (strstr($fokus, "belo") || strstr($fokus, "afd")) && strstr($submit, 'save')) {
		$tmp = substr($fokus, 4) + 1;
		if (!$debet[$tmp] && !$kredit[$tmp])
			$fokus = nextfokus($fokus);
	}
	if (!isset($dato[$y]))         $dato[$y]        = NULL;
	if (!isset($beskrivelse[$y]))  $beskrivelse[$y] = NULL;
	if (!isset($debet[$y]))        $debet[$y]       = NULL;
	if (!isset($kredit[$y]))       $kredit[$y]      = NULL;
	if (!isset($faktura[$y]))      $faktura[$y]     = NULL;
	if (!isset($valuta[$y]))       $valuta[$y]       = NULL;
	if (((($bilag[$x] == "-") || (!$dato[$y] && !$beskrivelse[$y] 
		&& !$debet[$y] && !$kredit[$y] && !$faktura[$y] && !$amount[$x])) && ($x == 1)) || (!$kladde_id)) {
		$bilag[$x] = 1;
		$qtxt = "select MAX(bilag) as bilag from kassekladde where transdate>='$regnstart' and transdate<='$regnslut'";
		$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
		if ($row = db_fetch_array($q)) $bilag[$x] = $row['bilag'] + 1;
	}
	if (!isset($debet[$x - 1]))       $debet[$x - 1] = NULL;
	if (!isset($kredit[$x - 1]))      $kredit[$x - 1] = NULL;
	if (($bilag[$x]) && (!$dato[$x])) $dato[$x] = dkdato(date("Y-m-d"));
	if ($x < 3000 && (($debet[$x - 1]) || ($kredit[$x - 1]) || $x == 1)) {
		if (!isset($id[$x]))          $id[$x]          = NULL;
		if (!isset($dato[$x]))        $dato[$x]        = NULL;
		if (!isset($beskrivelse[$x])) $beskrivelse[$x] = NULL;
		if (!isset($debet[$x]))       $debet[$x]       = NULL;
		if (!isset($kredit[$x]))      $kredit[$x]      = NULL;
		if (!isset($faktura[$x]))     $faktura[$x]     = NULL;
		if (!isset($d_type[$x]))      $d_type[$x]      = NULL;
		if (!isset($k_type[$x]))      $k_type[$x]      = NULL;
		if (!isset($afd[$x]))         $afd[$x]         = NULL;
		if (!isset($momsfri[$x]))     $momsfri[$x]     = NULL;
		if (!isset($projekt[$x]))     $projekt[$x]     = NULL;
		if (!isset($valuta[$x]))      $valuta[$x]      = NULL;
		if (!isset($ansat[$x]))       $ansat[$x]       = NULL;
		print "<tr>";

		if ($vis_bilag && !$fejl) { #20140425
			#if ($kladde_id && $intern_bilag) print "<td title='".findtekst('1455|klik her for at vedhæfte et bilag', $sprog_id)."'><a href='../includes/bilag.php?kilde=kassekladde&bilag_id=$id[$x]&bilag=$bilag[$x]&ny=ja&kilde_id=$kladde_id&fokus=bila$x'><img  style='border: 0px solid' src='../ikoner/clip.png'></a></td>\n";
			if ($kladde_id && $intern_bilag) {
				$id[$y]        = (int)if_isset($id[$y],0);
				$dokument[$y] = if_isset($dokument[$y],NULL);
				$qtxt = "select id from documents where source = 'kassekladde' and source_id = '$id[$y]'";  //20230630
				if ($dokument[$y] || db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					$clip = 'paper.png';
					$titletxt =  findtekst('1454|klik her for at åbne bilaget', $sprog_id);
				} else {
					$clip = 'clip.png';
					$titletxt =  findtekst('1455|klik her for at vedhæfte et bilag', $sprog_id);
				}
				$txt = 'Obs - Du har ikke gemt.\n Hvis du klikker OK mistes de sidste ændringer';
				print "<td title='$titletxt'>";
				print "<a href=\"javascript:confirmClose('../includes/documents.php?source=kassekladde";
				print "&ny=ja&sourceId=". if_isset($id[$x],0) ."&kladde_id=$kladde_id&bilag=$bilag[$x]";
				print "&bilag_id=". if_isset($id[$x],0) ."&fokus=bila$y','$txt')\" accesskey='L'>";
#				print "<a href='../includes/documents.php?source=kassekladde&&ny=ja&sourceId=" . if_isset($id[$y],0); 
#				print "&kladde_id=$kladde_id&bilag=$bilag[$x]&bilag_id=" . if_isset($id[$y],0) ."&fokus=bila$y' onclick='this.form.submit()'>";
				print "<img src='../ikoner/$clip' style='width:20px;height:20px;'></a></td>\n";


				// print "</tr>";
			} else {
				print "<td></td>\n";
			}
		}
		// get last bilagsnr from database but check if the row already has asigned bilagnr
		
		// 20251218 NEW CODE - Use $bilag[$x] if already set (for auto-balance with same bilag), otherwise calculate next bilag
		if (isset($bilag[$x]) && $bilag[$x]) {
			// Auto-balance line: keep the same bilag number as previous line (set earlier in code around line 1949)
			$next = $bilag[$x];
		} elseif (db_num_rows(db_select("select bilag from kassekladde WHERE kladde_id = '$kladde_id'", __FILE__ . " linje " . __LINE__)) == 0 || !$kladde_id){
			$qtxt = "select MAX(bilag) as bilag from kassekladde where transdate>='$regnstart' and transdate<='$regnslut'";
			$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
			if ($row = db_fetch_array($q)) $last_bilag = $row['bilag'];
			if ($x == 1) {
				$next = $last_bilag;
			} else {
				$next = $bilag[$x-1] + 1;
			}
		} else {
			$next = $bilag[$x-1] + 1;
		}
		if($dato[$x] == ''){
			$dato[$x] = dkdato(date("Y-m-d"));
		}
		
		print "<td><input class='inputbox' type='text' style='text-align:right;width:80px;'
		name='bila$x' $de_fok value =\"$next\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' 
		name='dato$x' $de_fok value =\"$dato[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:300px;' 
		name='besk$x' $de_fok value =\"$beskrivelse[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' 
		name='d_ty$x' $de_fok value =\"$d_type[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' 
		name='debe$x' $de_fok value =\"$debet[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' 
		name='k_ty$x' $de_fok value =\"$k_type[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' 
		name='kred$x' $de_fok value=\"$kredit[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' 
		name='fakt$x' $de_fok value=\"$faktura[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:100px;' 
		name='belo$x' $de_fok value=\"$belob\" onchange='javascript:docChange = true;'></td>\n";
		if ($vis_afd) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
			name='afd_$x' $de_fok value=\"$afd[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_ansat) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
			name='meda$x' $de_fok value =\"$ansat[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_projekt) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
			name='proj$x' $de_fok value =\"$projekt[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_valuta) {
			print "<td><input class='inputbox' type='text' style='text-align:left;width:40px;' 
			name='valu$x' $de_fok value =\"$valuta[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if (!isset($k_type[$y])) $k_type[$y] = NULL;
		if (!isset($d_type[$y])) $d_type[$y] = NULL;
		if ($k_type[$y] == 'K' || $d_type[$y] == 'D') {
			print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' 
			name='forf$x' $de_fok value =\"$forfaldsdato[$x]\" onchange='javascript:docChange = true;'></td>\n";
			print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' 
			name='b_id$x' $de_fok value =\"$betal_id[$x]\" onchange='javascript:docChange = true;'></td>\n";
		} elseif ($vis_forfald) {
			print "<td><input  class='inputbox' style='text-align:left;width:75px;' readonly='readonly'></td>\n";
			if ($vis_bet_id)
				print "<td><input  class='inputbox' style='text-align:left;width:100px;' readonly='readonly'></td>\n";
		}
		if ($momsfri[$x] == 'on') {
			print "<td align='center'><input class='inputbox' type='checkbox' name='moms$x' checked onchange='javascript:docChange = true;'></td>\n";
		} else {
			print "<td align='center'><input class='inputbox' type='checkbox' name='moms$x' onchange='javascript:docChange = true;'></td>\n";
		}
	}
	#cho __line__." X $x<br>";	
	if ($x != 1 || $bilag[$x])
		$bilagsnr = $bilag[$x];
	if ($x < 3000) {
		if ($x > 6) {
			$y = $x + 5;
		} else {
			$y = 10;
		}
		if ($fejl)
			$y = $x;
	} else
		$y = $x - 1;
	#cho __line__." Y $y<br>";   	

	$x++;
	if ($x == 1) {
		$bilag[1] = '';
		$dato[1] = '';
		$beskrivelse[1] = '';
		$d_type[1] = '';
		$debet[1] = '';
		$k_type[1] = '';
		$kredit[1] = '';
		$faktura[1] = '';
		$belob[1] = '';
		$momsfri[1] = '';
		$afd[1] = '';
	}
	for ($z = $x; $z <= $y; $z++) {
		print "<tr>";
		
		if ($vis_bilag && !$fejl)
			print "<td><br></td>\n";

		print "<td><input class='inputbox' type='text' style='text-align:right;width:80px;' name='bila$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name='dato$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:300px;' name='besk$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='d_ty$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='debe$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='k_ty$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='kred$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='fakt$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:100px;' name='belo$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_afd)
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='afd_$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_ansat)
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='meda$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_projekt)
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='proj$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_valuta)
			print "<td><input class='inputbox' type='text' style='text-align:left;width:40px;' name='valu$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		#		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name=forf$z $de_fok onchange='javascript:docChange = true;'></td>\n";
#		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name=b_id$z $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_forfald) {
			print "<td><input  class='inputbox' style='text-align:left;width:75px;' readonly='readonly'></td>\n";
			if ($vis_bet_id)
				print "<td><input  class='inputbox' style='text-align:left;width:100px;' readonly='readonly'></td>\n";
		}
		print "<td align='center'><input class='inputbox' type='checkbox' name='moms$z' onchange='javascript:docChange = true;'></td>\n";
		
		print "</tr>\n";
	}
	#	if (count($bilag)<10) print "<tr><td align='center' colspan='8'>".findtekst('598|-', $sprog_id)."</td></tr>";
	print "<input type='hidden' name='fokus' id='fokus'>";
	print "<input type=hidden name=kladde_id value=$kladde_id>";
	$tidspkt = microtime();
	print "<input type=hidden name=tidspkt value='$tidspkt'>";
	print "<input type=hidden name=bilagsnr value='$bilagsnr'>";
	print "<input type=hidden name=antal_ex value='$antal_ex'>";
	print "<input type=hidden name=antal_ny value='$y'>";
} #end if $bogfort...else

($udskriv) ? $div = '' : $div = '</div>';
?>
	<script	src="../javascript/jquery.formnavigation.js"></script>
	<script>
	$(document).ready(function () {
		$('.formnavi').formNavigation();
	});
	</script>
	<?php

	print "</tbody></table></center></div>";   # Tabel 1.3 <- Kladdelinjer
	print "</td></tr>\n";
	print "<tr class='kassekladde-footer'><td align='center'>";
	if ($menu == 'T') {
		print "<table width='900px' border='0' cellspacing='0' cellpadding='1'><tbody><tr>"; # Tabel 1.4 -> Knapper
	} else {
	print "<table id='buttonTable' style='margin: 0 auto; width:800px;' border='0' cellspacing='0' cellpadding='1'><tbody>
       <tr>";
 # Tabel 1.4 -> Knapper
	}
	if (!$udskriv) {
		if ($bogfort == 'V') {
			#		print "<input type=hidden name=ny_kladdenote value='$kladdenote'>";
			
			print "<tr id='kopierButtonRow'><td colspan=9 align='center'><input type='submit' class='button gray medium' accesskey='k' value=\"" . findtekst('1598|Kopier til ny', $sprog_id) . "\" name='copy2new' onclick='javascript:docChange = false;' id='kopier-button'></td></tr>\n";

			print "</form>";

		} elseif ($bogfort == '!') {
			#		print "<input type=hidden name=ny_kladdenote value='$kladdenote'>";
			print "<tr><td colspan=9 align='center'><input type='submit' accesskey='b' value='" . findtekst('1597|Tilbagefør', $sprog_id) . "' name='revert' onclick='javascript:docChange = false;'></td></tr>\n";
			print "</form>";

		} elseif ($bogfort == 'S') {
			print "<tr><td colspan=9 align='center'><input type='submit' class='button rosy medium' accesskey='a' value='" . findtekst('1090|Annuller simulering', $sprog_id) . "' name='cancelSimulation' onclick='javascript:docChange = false;'></td></tr>\n";
			print "</form>";
		} else {
			print "<td align='center'><span title='" . findtekst('1544|Klik her for at gemme', $sprog_id) . "'><input type='submit' class='button green medium' style='width:120px;' accesskey='g' value='" . findtekst('3|Gem', $sprog_id) . "' name='save' onclick='javascript:docChange = false;'></span></td>\n";
			print "<td align='center'><span title='" . findtekst('1545|Opslag - din markørs placering angiver hvilken tabel, opslag foretages i', $sprog_id) . "'><input type='submit' class='button blue medium' style='width:120px;' accesskey='o' value='" . findtekst('644|Opslag', $sprog_id) . "' name='lookup' onclick='javascript:docChange = false;'></span></td>";
			if ($kladde_id && !$fejl) {
				print "<td align='center'><span title='" . findtekst('1546|Simulering af bogføring viser bevægelser i kontoplanen', $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='s' value='" . findtekst('1064|Simulér', $sprog_id) . "' name='simulate' onclick='javascript:docChange = false;'></span></td>";
				print "<td align='center'><span title='" . findtekst('1547|Bogfør - der foretages først en simulering, som du skal bekræfte', $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='b' value='" . findtekst('1065|Bogfør', $sprog_id) . "' name='doPost' onclick='javascript:docChange = false;'></span></td>";
				$qtxt = "select box5 from grupper where art = 'DIV' and kodenr = '3'";
				if (!$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					$qtxt = "select id from ordrer where status=3";
					if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
						print "<td align='center'><span title='" . findtekst('1548|Henter afsluttede ordrer fra ordreliste', $sprog_id) . "'><input type='submit' style='width:120px;float:left' accesskey='h' value='" . findtekst('1078|Hent', $sprog_id) . "' name='upload' onclick='javascript:docChange = false;'></span></td>";
					}
				}
				$qtxt = "select * from grupper where art = 'DIV' and kodenr = '2' and box6='on'";
				if (db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					$confirm1 = findtekst('1576|Importer data fra DocuBizz?', $sprog_id);
					print "<td align='center'><input type='submit' style='width:120px;float:left' accesskey='d' value='DocuBizz' name='submit' onclick='javascript:docChange = false;' onclick=\"return confirm('$confirm1')\"></td>"; #20210720
				}
				print "<td align='center'><span title='" . findtekst('1549|Importerer bankposteringer eller andre data fra .csv-fil (kommasepareret fil)', $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='i' value='" . findtekst('1356|Importér', $sprog_id) . "' name='import' onclick='javascript:docChange = false;'></span></td>";
				print "<td align='center'><span title='" . findtekst('1550|Finder åbne poster, som modsvarer beløb og fakturanummer', $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='u' value='" . findtekst('1066|Udlign', $sprog_id) . "' name='offset' onclick='javascript:docChange = false;'></span></td>";
			}
		}
		print "</form>";
	}
	print "</tbody></table></td></tr>\n"; # Tabel 1.4 <- Knapper 
#	if ($udskriv) print "<tr><td width=\"100%\" height=\"100%\">zz</td></tr>";
	print "</tbody></table>"; # Tabel 1 <- 
	if ($udskriv) {
		print "</div>"; # Close print-view div
		print "<script>window.onload = function() { window.print(); };</script>";
	}
	#############################################################################################################################
	function kontroller($id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $kladde_id, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $lobenr) {
		global $baseCurrency,$bilagscount,$bilagsrenum;
		global $connection;
		global $debitornr;
		global $fejl;
		global $find;
		global $fokus;
		global $opslag_id;
		global $prebilag;
		global $regnaar;
		global $sletrest, $sprog_id;
		global $restlig;
		global $submit;
		global $x;
		global $aarstart;
		global $aarslut;

		$lukket = NULL;
		if (!$debitornr) $debitornr = array();

		if ($kladde_id) {
			$qtxt = "select bogfort from kladdeliste where id = $kladde_id";
			$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
			if ($r['bogfort'] != '-') {
				$alerttxt = findtekst('1584|Kladden er allerede bogført - kladden lukkes', $sprog_id); //Kladden er allerede bogført - kladden lukkes
				print "<BODY onLoad=\"javascript:alert('$alerttxt')\">";
				print "<meta http-equiv=\"refresh\" content=\"0;URL=../includes/luk.php\">";
				exit;
			}
		}

		if (!$aarstart) {
			$query = db_select("select box1, box2, box3, box4 from grupper where art='RA' and kodenr='$regnaar'", __FILE__ . " linje " . __LINE__);
			if ($row = db_fetch_array($query)) {
				$md1 = trim($row['box1']);
				$year1 = trim($row['box2']);
				$md2 = trim($row['box3']);
				$year2 = trim($row['box4']);
				if (strlen($md1) < 2 || strlen($md2) < 2) {
					if (strlen($md1) < 2)
						$md1 = '0' . $md1;
					if (strlen($md2) < 2)
						$md2 = '0' . $md2;
					db_modify("update grupper set box1='$md1',box3='$md2' where art='RA' and kodenr='$regnaar'", __FILE__ . " linje " . __LINE__);
				}
				$aarstart = $year1 . $md1;
				$aarslut = $year2 . $md2;
			}
		}
		#	(!$bilag) {$bilag=$prebilag;} PHR 02.10.06
#	if ($bilag=="-"){$bilag="";} PHR 02.10.06
#	if ($bilag=='-*') $sletrest=1;
#	if ($sletrest) $bilag='-';
		if ($bilag && $bilag != '0' && substr($bilag, -1) != 'r' && $bilag != '-')
			$bilag = (int) $bilag; 	//20160909 undtaget * til bilagsrenum
		$debet = trim($debet);
		$kredit = trim($kredit);
		if (($bilag != "-") && (($bilag) || ($beskrivelse) || ($kredit) || ($debet) || ($faktura) || ($belob))) {
			if ((!$bilag) && ($bilag != '0'))
				$bilag = $prebilag;
			if (!$bilag)
				$bilag = '0';
			if ((strstr($d_type, "d")) || (strstr($d_type, "D")))
				$d_type = "D";
			elseif ((strstr($d_type, "k")) || (strstr($d_type, "K")))
				$d_type = "K";
			else {
				$d_type = "F";
			}

			if ((strstr($k_type, "d")) || (strstr($k_type, "D")))
				$k_type = "D";
			elseif ((strstr($k_type, "k")) || (strstr($k_type, "K")))
				$k_type = "K";
			else
				$k_type = "F";
			if (!$debet)
				$debet = 0;
			if (!$kredit)
				$kredit = 0;
			if (!$lukket) {
				$lukket = array();
				$y = 0;
				$accountNumbers = array();
				$query = db_select("select kontonr,lukket from kontoplan where kontotype != 'H' and kontotype != 'Z' and regnskabsaar=$regnaar", __FILE__ . " linje " . __LINE__);
				while ($row = db_fetch_array($query)) {
					$y++;
					$accountNumbers[$y] = trim($row['kontonr']);
					if ($row['lukket']) {
						$lukket[$y] = $accountNumbers[$y];
					}
				}
			}
			#cho __line__." $submit $debet[$x] $fokus $x<br>";
	
			if (($d_type == "D") || ($k_type == "D") || ($d_type == "K") || ($k_type == "K")) {
				$z = 0;
				$y = 0;
				$query = db_select("select kontonr, art from adresser", __FILE__ . " linje " . __LINE__);
				while ($row = db_fetch_array($query)) {
					if (strstr($row['art'], "D")) {
						$z++;
						$debitornr[$z] = trim($row['kontonr']);
					}
					if (strstr($row['art'], "K")) {
						$y++;
						$kreditornr[$y] = trim($row['kontonr']);
					}
				}

			}
			#cho __line__." $submit $debet[$x] $fokus $x<br>";
			if ($d_type == "F" && strlen($debet) == 1 && !is_numeric($debet) && $debet != '0') {
				$debet = strtoupper($debet);
				$query = db_select("select kontonr from kontoplan where genvej='$debet' and regnskabsaar='$regnaar'", __FILE__ . " linje " . __LINE__);
				if ($row = db_fetch_array($query))
					$debet = $row["kontonr"];
				else {
					$txt1 = findtekst('1585|er ikke defineret som genvejstast (Bilag nr', $sprog_id); // er ikke defineret som genvejstast (Bilag nr
					$txt2 = findtekst('1586| Kladden en IKKE gemt!', $sprog_id); // ) Kladden en IKKE gemt!
					$alerttekst = addslashes($debet . " " . $txt1 . " " . $bilag . $txt2); # 20230306 added spaces
					alert($alerttekst);
					$fejl = 1;
				}
			}
			#cho __line__." $submit $debet[$x] $fokus $x<br>";
			if (($d_type == "F" && strlen($debet) > 1 && !is_numeric($debet))) {
				$i = 0;
				$d = $debet;
				$ld = strtolower($debet);
				$ud = strtoupper($debet);
				$qtxt = "select beskrivelse,kontonr from kontoplan where (kontotype = 'D' or kontotype = 'S') and ";
				$qtxt .= "regnskabsaar='$regnaar' and lukket != 'on' order by beskrivelse";
				$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
				while ($r = db_fetch_array($q)) {
					$t = $r['beskrivelse'];
					$lt = strtolower($t);
					$ut = strtoupper($t);
					if (strstr($t, $d) || strstr($lt, $ld) || strstr($ut, $ud)) {
						$findarray[$i] = $r['kontonr'];
						$i++;
					}
				}
				if ($i == 1) {
					$debet = $findarray[0];
				} elseif ($i > 1) {
					include('kassekladde_includes/financeLookup.php');
					financeLookup($findarray, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $lobenr);
				}
			} elseif (($k_type == "F") && (strlen($kredit) > 1) && (!is_numeric($kredit))) {
				$i = 0;
				$k = $kredit;
				$lk = strtolower($kredit);
				$uk = strtoupper($kredit);
				$qtxt = "select beskrivelse,kontonr from kontoplan where (kontotype = 'D' or kontotype = 'S') and ";
				$qtxt .= "regnskabsaar='$regnaar' and lukket != 'on' order by beskrivelse";
				$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
				while ($r = db_fetch_array($q)) {
					$t = $r['beskrivelse'];
					$lt = strtolower($t);
					$ut = strtoupper($t);
					if (strstr($t, $k) || strstr($lt, $lk) || strstr($ut, $uk)) {
						$findarray[$i] = $r['kontonr'];
						$i++;
					}
				}
				if ($i == 1) $kredit = $findarray[0]; //20240523
				elseif ($i > 1) {
					include('kassekladde_includes/financeLookup.php');
					financeLookup($findarray, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $lobenr);
				}
			}
			if (!$fejl && $k_type == "F" && strlen($kredit) == 1 && !is_numeric($kredit) && $kredit != '0') {
				$qtxt = "select kontonr from kontoplan where genvej='" . strtoupper($kredit) . "' and regnskabsaar='$regnaar'";
				$query = db_select($qtxt, __FILE__ . " linje " . __LINE__);
				if ($row = db_fetch_array($query))
					$kredit = $row['kontonr'];
				else {
					$alert1 = findtekst('1585|er ikke defineret som genvejstast (Bilag nr', $sprog_id); // er ikke defineret som genvejstast (Bilag nr
					$alert2 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id); // ) Kladden en IKKE gemt!

					$alerttekst = addslashes($kredit . " " . $txt1 . " " . $bilag . $txt2); # 20230306 added spaces
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if ((!$fejl) && ($d_type == "F") && ($debet > 0)) {
				$alerttekst = '';
				if (!in_array($debet, $accountNumbers)) {
					$alerttxt1 = findtekst('1589|Der er ingen finanskonti hvor', $sprog_id); // Der er ingen finanskonti hvor
					$alerttxt2 = findtekst('1590|indgår (Bilag nr', $sprog_id); // indgår (Bilag nr
					$alerttxt3 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id); // ) Kladden en IKKE gemt!
					$alerttxt4 = findtekst('1591|Debetkonto', $sprog_id); // Debetkonto
					$alerttxt5 = findtekst('1592|er låst og må ikke anvendes (Bilag nr', $sprog_id); // er låst og må ikke anvendes (Bilag nr


					$alerttekst = addslashes($alerttxt1 . " '" . $debet . "' " . $alerttxt2 . " " . $bilag . $alerttxt3); # 20230306 added ' and spaces
				} elseif (in_array($debet, $lukket))
					$alerttekst = addslashes($alerttxt4 . " " . $debet . " " . $alerttxt5 . " " . $bilag . $alerttxt3); # 20230306 added spaces
				if ($alerttekst) {
					alert("$alerttekst");
					$fejl = 1;
				}
			}
			if ((!$fejl) && ($k_type == "F") && ($kredit > 0)) {
				$alerttekst = '';
				$alert1 = findtekst('1593|Kreditkonto', $sprog_id); // Kreditkonto
				$alert2 = findtekst('1594|eksisterer ikke', $sprog_id); // eksisterer ikke
				$alert3 = findtekst('1588|( Bilag nr', $sprog_id); // ( Bilag nr
				$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id); // ) Kladden en IKKE gemt!


				if (!in_array($kredit, $accountNumbers)) {
					$alerttekst = addslashes($alert1 . " '" . $kredit . "' " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				} elseif (in_array($kredit, $lukket))
					$alerttekst = addslashes($alert1 . " " . $kredit . " " . $alerttxt4 . " " . $bilag . $alert4);
				if ($alerttekst) {
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if ((!$fejl) && ($d_type == "D") && ($debet) && (!in_array($debet, $debitornr))) {
				$alerttekst = '';
				$alert1 = findtekst('604|Debitor', $sprog_id);
				$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
				$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
				$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);

				$svar = find_kontonr($fokus, 'D', $debet, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $x);
				if ($svar == $debet)
					$alerttekst = addslashes($alert1 . " " . $debet . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$debet = $svar;
				if ($alerttekst) {
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if ((!$fejl) && ($k_type == "D") && ($kredit) && (!in_array($kredit, $debitornr))) {
				$alerttekst = '';
				$alert1 = findtekst('604|Debitor', $sprog_id);
				$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
				$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
				$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);

				$svar = find_kontonr($fokus, 'D', $kredit, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $x);
				if ($svar == $kredit)
					$alerttekst = addslashes($alert1 . " " . $kredit . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$kredit = $svar;
				if ($alerttekst) {
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if ((!$fejl) && ($d_type == "K") && ($debet) && (!in_array($debet, $kreditornr))) {
				$alerttekst = '';
				$alert1 = findtekst('1169|Kreditor', $sprog_id);
				$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
				$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
				$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);
				$svar = find_kontonr($fokus, 'K', $debet, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $x);
				if ($svar == $debet)
					$alerttekst = addslashes($alert1 . " " . $debet . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$debet = $svar;
				if ($alerttekst) {
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if ((!$fejl) && ($k_type == "K") && ($kredit) && (!in_array($kredit, $kreditornr))) {
				$alerttekst = '';
				$alert1 = findtekst('1169|Kreditor', $sprog_id);
				$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
				$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
				$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);
				$svar = find_kontonr($fokus, 'K', $kredit, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $x);
				if ($svar == $kredit)
					$alerttekst = addslashes($alert1 . " " . $kredit . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$kredit = $svar;
				if ($alerttekst) {
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if ($d_type == "K" && strtoupper($debet) == "K")
				$debet = 0;
			if ($d_type == "D" && strtoupper($debet) == "D")
				$debet = 0;
			if ($k_type == "K" && strtoupper($kredit) == "K")
				$kredit = 0;
			if ($k_type == "D" && strtoupper($kredit) == "D")
				$kredit = 0;
			$transdate = usdate($dato);
			#cho __line__." $transdate<br>";
			list($year, $month, $day) = explode('-', $transdate);
			$ym = $year . $month;

			if (!function_exists('checkOpenFiscalYear')) include_once('../includes/stdFunc/checkOpenFiscalYear.php');
			// DEBUG 20251216 - Show all fiscal years directly
			$debug_q = db_select("select kodenr, box1, box2, box3, box4, box5 from grupper where art = 'RA' order by kodenr", __FILE__ . " linje " . __LINE__);
			$all_years = '';
			while ($debug_r = db_fetch_array($debug_q)) {
				$all_years .= "yr{$debug_r['kodenr']}:{$debug_r['box2']}{$debug_r['box1']}-{$debug_r['box4']}{$debug_r['box3']}(box5={$debug_r['box5']}); ";
			}
			print "<script>console.log('DEBUG ALL fiscal years: $all_years');</script>";
			// END DEBUG
			$debug_result = checkOpenFiscalYear($transdate);
			print "<script>console.log('DEBUG fiscal year check: regnaar=$regnaar, transdate=$transdate, ym=$ym, aarstart=$aarstart, aarslut=$aarslut, result=" . ($debug_result ? 'PASS' : 'FAIL') . "');</script>";
			if (!$debug_result) {


#			if (!$fejl && $dato && ($ym < $aarstart || $ym > $aarslut)) {
				$alert1 = findtekst('635|Dato', $sprog_id);
				$alert2 = findtekst('1595|udenfor regnskabsår', $sprog_id);
				$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
				$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);
				#'Dato ('.$dato.') udenfor regnskabs&aring;r (Bilag nr '.$bilag.') Kladden er IKKE gemt!';
				$alerttekst = $alert1 . " (" . $dato . ") " . $alert2 . " " . $alert3 . " " . $bilag .")";
				alert($alerttekst);
				$fejl = 1;
				#			$transdate=date("Y-m-d");
			}
			if (!isset($afd) || !$afd)
				$afd = 0;
			if (!$fejl && $afd) {
				$qtxt = "select id from grupper where art='AFD' and kodenr='$afd'";
				if (!$row = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					$alert1 = findtekst('274|Afdeling', $sprog_id);
					$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
					$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
					$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);
					$alerttekst = addslashes($alert1 . " " . $afd . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
					alert($alerttekst);
					$fejl = 1;
				}
			}
			#		$projekt=$projekt*1;
			if (!$fejl && $projekt) {
				if (!$row = db_fetch_array(db_select("select id from grupper where art='PRJ' and kodenr='$projekt'", __FILE__ . " linje " . __LINE__))) {
					$alert1 = findtekst('553|Projekt', $sprog_id);
					$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
					$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
					$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);

					$alerttekst = addslashes($alert1 . " " . $projekt . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
					alert($alerttekst);
					$fejl = 1;
				}
			}
			if (!$valuta)
				$valuta = $baseCurrency;
			if ($id && !$fejl && $valuta != $baseCurrency) {
				if (!$row = db_fetch_array(db_select("select kodenr from grupper where art='VK' and box1='$valuta'", __FILE__ . " linje " . __LINE__))) {
					$alert1 = findtekst('1069|Valuta', $sprog_id); #20210720
					$alert2 = findtekst('1594|eksisterer ikke', $sprog_id);
					$alert3 = findtekst('1588|( Bilag nr', $sprog_id);
					$alert4 = findtekst('1586|) Kladden en IKKE gemt!', $sprog_id);

					$alerttekst = addslashes($alert1 . " " . $valuta . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
					alert($alerttekst);
					$fejl = 1;
				} else
					$valutakode = $row['kodenr'];
				$valdate = usdate($dato);
				$qtxt = "select kurs from valuta where gruppe='$valutakode' and valdate <= '$valdate' order by valdate desc limit 1";
				if ($id && !$fejl && $row = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					db_modify("update kassekladde set valutakurs = '$row[kurs]' where id = '$id'", __FILE__ . " linje " . __LINE__);
				}
			}
			if ($lobenr) {
				if (substr($bilag, -1) == 'r') { #20160909.  Er der tastet * som en del af bilagsnummerfeltet?
					$bilagscount = str_replace('r', '', $bilag); #20160909 fjern * fra bilagsnummeret
					$bilagsrenum = true; #20160909 ja, der skal renummereres bilag
				}
				if ($bilagsrenum == true) { #20160909 denne bliver loopet igennem for hvert eneste efterfølgende bilag - vi overskriver bilagsunmmeret
					$qtxt = "update tmpkassekl set bilag = '$bilagscount', transdate = '$dato', beskrivelse = '$beskrivelse', d_type = '$d_type', debet = '$debet', k_type = '$k_type', kredit = '$kredit', faktura = '$faktura', amount = '$belob', momsfri = '$momsfri', afd= '$afd', projekt= '$projekt', valuta= '$valuta',forfaldsdate='$forfaldsdato',betal_id='$betal_id' where lobenr = '$lobenr' and kladde_id='$kladde_id'";
					$bilagscount++; #20160909 og her øger vi bilagsnummeret med 1 inden loop
				} else {
					$qtxt = "update tmpkassekl set bilag = '$bilag', transdate = '$dato', beskrivelse = '$beskrivelse', d_type = '$d_type', debet = '$debet', k_type = '$k_type', kredit = '$kredit', faktura = '$faktura', amount = '$belob', momsfri = '$momsfri', afd= '$afd', projekt= '$projekt', valuta= '$valuta',forfaldsdate='$forfaldsdato',betal_id='$betal_id' where lobenr = '$lobenr' and kladde_id='$kladde_id'";
				}

				db_modify($qtxt, __FILE__ . " linje " . __LINE__);
			}
		} elseif ($id && $bilag === "-") {
			$qtxt = "select id from documents where source = 'kassekladde' and source_id = '$id'";
			if(db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				alert('Fjern vedhæftet bilag før du sletter linjen');
			} else {
				$qtxt = "delete from kassekladde where id = $id";
				db_modify($qtxt, __FILE__ . " linje " . __LINE__);
			}
		}
		$prebilag = $bilag;
	} # endfunc kontroller
######################################################################################################################################
	function opdater($kladde_id)
	{
		global $baseCurrency,$egen_kto_id;

		$forfaldsdate = NULL;
		$valutakode = '0';
		$qtxt = "select * from tmpkassekl where kladde_id = $kladde_id order by lobenr";
		$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
		while ($r = db_fetch_array($q)) {
			if (($r['bilag'] != "-") && ($r['transdate'] || $r['debet'] || $r['kredit'])) {
				if ($r['transdate'])
					$transdate = usdate($r['transdate']);
				#			else $transdate=NULL; # <- 2009.05.12
#			else $transdate=date("Y-m-d"); # <- 2009.05.14
				if ($r['forfaldsdate'])
					$forfaldsdate = usdate($r['forfaldsdate']);
				else
					$forfaldsdate = NULL; # <- 2009.05.12
				$amount = usdecimal($r['amount'], 2)*1;
				$momsfri = trim($r['momsfri']);
				$debet = (int) $r['debet'];
				$kredit = (int) $r['kredit'];
				(!$kredit) ? $kredit = 0 : $kredit *= 1;
				$d_type = trim($r['d_type']);
				$k_type = trim($r['k_type']);
				$afd = trim($r['afd']);
				(!$afd) ? $afd = 0 : $afd *= 1;
				$ansat = strtolower($r['ansat']);
				$faktura = db_escape_string(if_isset($r['faktura'], ''));
				if ($egen_kto_id && $ansat) {
					$r2 = db_fetch_array(db_select("select id from ansatte where lower(initialer) = '$ansat' and konto_id = '$egen_kto_id'", __FILE__ . " linje " . __LINE__));
					$ansat_id = $r2['id'] * 1;
				} else
					$ansat_id = 0;
				$projekt = $r['projekt'];
				$valuta = $r['valuta'];
				if ($valuta != $baseCurrency) {
					$valuta = strtoupper($valuta);
					# 20120806 Indsat "art = 'VK' and " herunder.
					$qtxt = "select kodenr from grupper where art = 'VK' and box1 = '$valuta'";
					($r2 = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) ? $valutakode = $r2['kodenr'] : $valutakode = 0;
				} else
					$valutakode = 0; #Valutakode 0 er altid $baseCurrency
				$betal_id = $r['betal_id'];
				$beskrivelse = db_escape_string(if_isset($r['beskrivelse'], ''));
				if ($amount < 0) { # Hvis beloebet er negativt, byttes om paa debet og kredit.
					$tmp = $kredit;
					$kredit = $debet;
					$debet = $tmp;
					$tmp = $k_type;
					$k_type = $d_type;
					$d_type = $tmp;
					$amount = $amount * -1;
				}
				if ($r['id'] && ($r['bilag'] || $r['bilag'] == '0')) {
					if (!$transdate && isset($_GET['dato']))
						$transdate = usdate($_GET['dato']);
					if (!$transdate)
						$transdate = date("Y-m-d");
					$qtxt = "update kassekladde set bilag = '$r[bilag]', transdate = '$transdate', beskrivelse = '$beskrivelse', ";
					$qtxt .= "d_type = '$d_type', debet = '$debet', k_type = '$k_type', kredit = '$kredit', faktura = '$faktura', ";
					$qtxt .= "amount = '$amount', momsfri = '$momsfri', afd= '$afd', projekt= '$projekt', ansat= '$ansat_id', ";
					$qtxt .= "valuta= '$valutakode' where id = '$r[id]'";
					db_modify($qtxt, __FILE__ . " linje " . __LINE__);
					if ($forfaldsdate) {
						$qtxt = "update kassekladde set forfaldsdate='$forfaldsdate', betal_id='$betal_id' where id = '$r[id]'";
					} else
						$qtxt = "update kassekladde set forfaldsdate=NULL, betal_id='' where id = '$r[id]'";
					db_modify($qtxt, __FILE__ . " linje " . __LINE__);
				} elseif (
					($r['transdate'] || $transdate)
					&& (($transdate && $transdate != date("Y-m-d")) || $r['beskrivelse'] || $debet | $kredit || $r['faktura'])
				) {
					#				$beskrivelse=db_escape_string(if_isset($r['beskrivelse'], ''));
					$qtxt = NULL;
					if ($forfaldsdate) {
						$next_pos_query = db_select("SELECT COALESCE(MAX(pos), 0) + 1 as next_pos FROM kassekladde WHERE kladde_id = '$kladde_id' AND bilag = '$r[bilag]' AND transdate = '$transdate'", __FILE__ . " linje " . __LINE__);
$next_pos_row = db_fetch_array($next_pos_query);
$next_pos = $next_pos_row['next_pos'];
						// $qtxt = "insert into kassekladde (bilag, transdate, beskrivelse, d_type, debet, k_type, kredit, ";
						// $qtxt .= "faktura, amount, momsfri, afd, projekt, ansat, valuta, kladde_id,forfaldsdate,betal_id)";
						// $qtxt .= "values ";
						// $qtxt .= "('$r[bilag]', '$transdate', '$beskrivelse', '$d_type', '$debet', '$k_type', '$kredit', ";
						// $qtxt .= "'$r[faktura]', '$amount', '$momsfri', '$afd', '$projekt', '$ansat_id', '$valutakode', ";
						// $qtxt .= "'$kladde_id','$forfaldsdate','$betal_id')";
						$qtxt = "insert into kassekladde (bilag, transdate, beskrivelse, d_type, debet, k_type, kredit, ";
$qtxt .= "faktura, amount, momsfri, afd, projekt, ansat, valuta, kladde_id,forfaldsdate,betal_id, pos)"; // Added pos
$qtxt .= "values ";
$qtxt .= "('$r[bilag]', '$transdate', '$beskrivelse', '$d_type', '$debet', '$k_type', '$kredit', ";
$qtxt .= "'$r[faktura]', '$amount', '$momsfri', '$afd', '$projekt', '$ansat_id', '$valutakode', ";
$qtxt .= "'$kladde_id','$forfaldsdate','$betal_id', '$next_pos')"; // Added $next_pos
					} elseif (($r['bilag'] || $r['bilag'] == '0') && ($beskrivelse || $debet || $kredit || $amount)) {
						$next_pos_query = db_select("SELECT COALESCE(MAX(pos), 0) + 1 as next_pos FROM kassekladde WHERE kladde_id = '$kladde_id' AND bilag = '$r[bilag]' AND transdate = '$transdate'", __FILE__ . " linje " . __LINE__);
$next_pos_row = db_fetch_array($next_pos_query);
$next_pos = $next_pos_row['next_pos'];
						// $qtxt = "insert into kassekladde (bilag, transdate, beskrivelse, d_type, debet, k_type, kredit, ";
						// $qtxt .= "faktura, amount, momsfri, afd, projekt, ansat, valuta, kladde_id)";
						// $qtxt .= " values ";
						// $qtxt .= "('$r[bilag]', '$transdate', '$beskrivelse', '$d_type', '$debet', '$k_type', '$kredit', ";
						// $qtxt .= "'$r[faktura]', '$amount', '$momsfri', '$afd', '$projekt', '$ansat_id', '$valutakode', '$kladde_id')";

						$qtxt = "insert into kassekladde (bilag, transdate, beskrivelse, d_type, debet, k_type, kredit, ";
$qtxt .= "faktura, amount, momsfri, afd, projekt, ansat, valuta, kladde_id, pos)"; // Added pos
$qtxt .= " values ";
$qtxt .= "('$r[bilag]', '$transdate', '$beskrivelse', '$d_type', '$debet', '$k_type', '$kredit', ";
$qtxt .= "'$r[faktura]', '$amount', '$momsfri', '$afd', '$projekt', '$ansat_id', '$valutakode', '$kladde_id', '$next_pos')"; // Added $next_pos
					}
					if ($qtxt) {
						db_modify($qtxt, __FILE__ . " linje " . __LINE__);
					}
				}
			}
		}
	}
	######################################################################################################################################
	function tilbagefor($kladde_id) {
		global $regnaar;
		global $connection;

		$query = db_select("select kladdenote from kladdeliste where id = '$kladde_id' and bogfort='!'", __FILE__ . " linje " . __LINE__);
		if ($row = db_fetch_array($query)) {
			db_modify("delete from openpost where kladde_id = '$kladde_id'", __FILE__ . " linje " . __LINE__);
			db_modify("delete from transaktioner where kladde_id = '$kladde_id'", __FILE__ . " linje " . __LINE__);
			db_modify("update kladdeliste set bogfort = '-' where id = '$kladde_id'", __FILE__ . " linje " . __LINE__);
		}
	}
	######################################################################################################################################
######################################################################################################################################
	function nextfokus($fokus)
	{
		global $id;
		global $amount;
		if ($fokus) {
			$f_id = substr($fokus, 4, (strlen($fokus) - 4));
			if (strstr($fokus, "bila")) {
				$fokus = "dato" . $f_id;
			} elseif (strstr($fokus, "dato")) {
				$fokus = "besk" . $f_id;
			} elseif (strstr($fokus, "besk")) {
				$fokus = "d_ty" . $f_id;
			} elseif (strstr($fokus, "d_ty")) {
				$fokus = "debe" . $f_id;
			} elseif (strstr($fokus, "debe")) {
				$fokus = "k_ty" . $f_id;
			} elseif (strstr($fokus, "k_ty")) {
				$fokus = "kred" . $f_id;
			} elseif (strstr($fokus, "kred")) {
				$fokus = "fakt" . $f_id;
			} elseif (strstr($fokus, "fakt")) {
				$fokus = "belo" . $f_id;
			} elseif (strstr($fokus, "belo") || strstr($fokus, "afd")) {
				$f_id++;
				$fokus = "bila" . $f_id;
			}
		} #else $fokus="bila".$x;
# 	if ($amount[$x-1]>0) {$fokus="bila".$x;}
	
		return $fokus;
	}
	/*
								  ##########################################################################################################
								  function regnskabsaar($regnaar) {
									  global $sprog_id; #20210720
									  if ($row = db_fetch_array(db_select("select box1, box2, box3, box4 from grupper where art='RA' and kodenr='$regnaar'",__FILE__ . " linje " . __LINE__))){
										  $start=trim($row['box2'])."-".trim($row['box1'])."-01";
										  $slut=usdate("31-".trim($row['box3'])."-".trim($row['box4']))	; #usdate bruges for at sikre korrekt dato.
									  } else {
										  #$alerttekst='Regnskabs&aring;r ikke oprettet!';
										  $alerttekst=findtekst('1596|Regnskabsår', $sprog_id);
										  alert($alerttekst);
										  exit;
									  }
									  return $start.":".$slut;
								  }
								  */
	######################################################################################################################################
	function indsaet_linjer($kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $afd, $ansat, $projekt, $valuta, $forfaldsdato, $betal_id, $momsfri, $ansat_id) {
		global $baseCurrency,$fejl,$fokus;

		$date = usdate($dato);
		$amount = usdecimal($belob, 2);
		if ($forfaldsdato)
			$forfaldsdate = usdate($forfaldsdato);
		else
			$forfaldsdate = NULL;
		#	$bilag = str_replace('+',':',$bilag); #jeg ved ikke hvorfor, men den vil ikke splitte med "+"
#	list ($bilag,$antal) = explode (':',$bilag);
		if ($ansat) {
			$r = db_fetch_array(db_select("select id from adresser where art = 'S'", __FILE__ . " linje " . __LINE__));
			$tmp = $r['id'] * 1;
			$r = db_fetch_array(db_select("select id from ansatte where initialer = '$ansat' and konto_id = '$tmp'", __FILE__ . " linje " . __LINE__));
			$ansat_id = $r['id'];
		}
		$ansat_id = $ansat_id * 1;
		if ($valuta && $valuta != $baseCurrency) {
			$r = db_fetch_array(db_select("select kodenr from grupper where box1 = '$valuta' and art = 'VK'", __FILE__ . " linje " . __LINE__));
			if ($r['kodenr'])
				$valutakode = $r['kodenr'] * 1;
			else {
				$fejl = 1;
				print "<BODY onLoad=\"javascript:alert('Valuta $valuta eksisterer ikke (Bilag $bilag)')\">";
			}
		} else
			$valutakode = 0;
		if (!$fejl) {
			if (!$forfaldsdate)
				$forfaldsdate = $date;
			$qtxt = "insert into kassekladde ";
			$qtxt .= "(bilag,kladde_id,transdate,beskrivelse,d_type,debet,k_type,kredit,";
			$qtxt .= "faktura,amount,afd,ansat,projekt,valuta,forfaldsdate,betal_id,momsfri) values ";
			$qtxt .= "('$bilag','$kladde_id','$date','" . db_escape_string(if_isset($beskrivelse, '')) . "','$d_type','$debet','$k_type','$kredit',";
			$qtxt .= "'$faktura','$amount','$afd','$ansat_id','$projekt','$valutakode','$forfaldsdate','$betal_id','$momsfri')";
			db_modify($qtxt, __FILE__ . " linje " . __LINE__);
		}
		if (!$fokus)
			$fokus = "ny_kladdenote";
	}
	######################################################################################################################################
	function ompost($ompost)
	{
		global $sprog_id;

		$ompost_til = isset($_GET['ompost_til']) ? $_GET['ompost_til'] : Null;
		$kladde_id = isset($_GET['kladde_id']) ? $_GET['kladde_id'] : Null;
		$x = 0;
		if (!$ompost_til) {
			$x = 0;
			print "<table border=\"1\"><tbody>";
			print "<tr><td colspan=3>" . findtekst('158|Klik på kladde_id for den kassekladde som posteringen skal tilbageføres til.', $sprog_id) . "</td></tr>";
			print "<tr><td>".findtekst('1087|Kladde', $sprog_id)."-ID</td><td>".findtekst('914|Beskrivelse', $sprog_id)."</td><td>".findtekst('958|Oprettet af', $sprog_id)."</td></tr>";
			print "<tr><td><a href=kassekladde.php?kladde_id=$kladde_id>" . findtekst('159|Fortryd', $sprog_id) . "</a></td><td>" . findtekst('160|<- Klik her for at fortryde.', $sprog_id) . "</td><td><br></td></tr>";
			$q = db_select("select * from kladdeliste where bogfort='-'", __FILE__ . " linje " . __LINE__);
			while ($r = db_fetch_array($q)) {
				$x++;
				print "<tr><td><a href=kassekladde.php?kladde_id=$kladde_id&ompost=$ompost&ompost_til=$r[id]>$r[id]</a></td><td>$r[kladdenote]</td><td>$r[oprettet_af]</td></tr>";
			}
			if ($x == 0) {
				print "<body onLoad=\"javascript:alert('".findtekst('2597|Der skal først oprettes en kassekladde som posteringen kan tilbageføres til', $sprog_id)."')\">";
				print "<meta http-equiv=\"refresh\" content=\"0;URL=kassekladde.php?kladde_id=$kladde_id\">";
			}
			print "<tbody></table>";
			exit;
		} else {
			$r = db_fetch_array(db_select("select * from kassekladde where id = '$ompost'", __FILE__ . " linje " . __LINE__));
			$afd = $r['afd'] * 1;
			$ansat = $r['ansat'] * 1;
			$projekt = $r['projekt'];
			$valutakode = $r['valutakode'] * 1;
			#20140718
			db_modify("insert into kassekladde (bilag,kladde_id,transdate,beskrivelse,d_type,debet,k_type,kredit,faktura,amount,momsfri,afd,ansat,projekt,valuta) values ('$r[bilag]','$ompost_til','$r[transdate]','" . db_escape_string(if_isset($r['beskrivelse'], '')) . "','$r[k_type]','$r[kredit]','$r[d_type]','$r[debet]','$r[faktura]','$r[amount]','$r[momsfri]','$afd','$ansat','$projekt','$valutakode')", __FILE__ . " linje " . __LINE__);
			print "<body onLoad=\"javascript:alert('".findtekst('2596|Posteringen er tilbageført på kladde', $sprog_id)." $ompost_til')\">";
		}
	} # endfunc ompost
##########################################################################################################
	// Handle move up/down

function valutaopslag($amount, $valuta, $transdate) {

		$qtxt = "select * from valuta where gruppe = '$valuta' and valdate <= '$transdate' order by valdate desc";
		$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
		if ($r['kurs']) {
			$kurs = $r['kurs'];
			$amount = round($amount * $kurs / 100 + 0.0001, 2); # decimal rettet fra 3 til 2 20090617 grundet fejl i saldi_58_20090617-2224
		} else {
			$qtxt = "select box1 from grupper where art = 'VK' and kodenr = '$valuta'";
			$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
			$tmp = dkdato($transdate);
			$fejltext = "---";
			print "<BODY onLoad=\"javascript:alert('Ups - ingen valutakurs for $r[box1] den $tmp')\">";
		}
		$qtxt = "select box3 from grupper where art = 'VK' and kodenr = '$valuta'";
		$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
		$diffkonto = $r['box3'];

		return array($amount, $diffkonto, $kurs); # 3'die parameter tilfojet 2009.02.10
	}
	##########################################################################################################
	function find_kontonr($fokus, $art, $kontonr, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id)
	{

		$tmp = db_escape_string(strtolower(if_isset($kontonr, '')));
		$specChar = "À,Á,Â,Ã,Ä,Å,Æ,Ç,È,É,Ê,Ë,Ì,Í,Î,Ï,Ð,Ñ,Ò,Ó,Ô,Õ,Ö,Ø,Ù,Ú,Û,Ü,Ý,Þ,"; #20190503
		$specChar .= "ß,à,á,â,ã,ä,å,æ,ç,è,é,ê,ë,ì,í,î,ï,ð,ñ,ò,ó,ô,õ,ö,ø,ù,ú,û,ü,ý,þ,ÿ";
		$chkstr = explode(',', $specChar);
		for ($x = 0; $x < count($chkstr); $x++) {
			$tmp = str_replace($chkstr[$x], '%', $tmp);
		}
		$x = 0;
		$qtxt = "select kontonr from adresser where art = '$art' and lower(firmanavn) like '%$tmp%' and lukket != 'on'";
		$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
		while ($r = db_fetch_array($q)) {
			$x++;
			$nr = $r['kontonr'];
		}
		if ($x == 1)
			return ($nr);
		elseif ($x > 1) {
			if ($art == 'D') {
				include('kassekladde_includes/debitorLookup.php');
				debitorLookup($tmp, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id);
			} else {
				include('kassekladde_includes/creditorLookup.php');
				creditorLookup($tmp, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id);
			}
		} else
			return ($kontonr);
	}
	##########################################################################################################
	function sidste_5($kontonr, $art, $dk)
	{
		global $kladde_id;
		global $charset;
		global $sprog_id;


		if ($dk == "D")
			$txt = "select bilag,transdate,beskrivelse,debet as kontonr from kassekladde where k_type = '$art' and kredit = '$kontonr' and kladde_id != '$kladde_id' order by transdate desc";
		else
			$txt = "select bilag,transdate,beskrivelse,kredit as kontonr from kassekladde where d_type = '$art' and debet = '$kontonr' and kladde_id != '$kladde_id' order by transdate desc";
		$retur = "<table border=1><tbody>";
		if ($art == 'K')
			$retur .= "<tr><td colspan=4>Sidste 5 posteringer for kreditor: $kontonr</td></tr>";
		else
			$retur .= "<tr><td colspan=4>Sidste 5 posteringer for debitor: $kontonr</td></tr>";
		$retur .= "<tr><td>bilag</td><td>dato</td><td>tekst</td><td>kontonr</td></tr>";
		$x = 0;
		if (is_numeric($kontonr)) {
			$q = db_select($txt, __FILE__ . " linje " . __LINE__);
			while ($x < 5 && ($r = db_fetch_array($q))) {
				if ($r['kontonr']) {
					$x++;
					// 20130221 htmlentities på beskrivelse:
					$retur .= "<tr><td align=right>" . $r['bilag'] . "</td><td>" . dkdato($r['transdate']) . "</td><td>" . htmlentities($r['beskrivelse'], ENT_QUOTES, "$charset") . "</td><td>" . $r['kontonr'] . "</td></tr>";
				}
			}
			$retur .= "</tbody></table>";
		}
		if ($x)
			return ($retur);
		else
			return (NULL);
	} # endfunc sidste_5
##########################################################################################################
function find_dublet($id, $transdate, $d_type, $debet, $k_type, $kredit, $amount, $faktura) {
	if ($id) {
		$id = (int)$id;
		$qtxt = "select bilag,kladde_id from kassekladde where transdate='$transdate' and d_type='$d_type' ";
		$qtxt.= "and debet='$debet' and k_type='$k_type' and kredit='$kredit' and amount = '$amount' ";
		$qtxt.= "and faktura = '$faktura' and id!='$id' limit 1";
		if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
			return ($r['bilag'] . "," . $r['kladde_id']);
		} else return ("0,0");
	}
}

	$x--;
	if (!$fokus && $x == 1)
		$fokus = "dato$x";
	if (!$fokus && $x > 1) {
		$x--;
		$fokus = "besk$x";
	}
	print "</tbody></table>";
	print "<script language=\"javascript\">";
	print "document.kassekladde.$fokus.focus()";
	print "</script>";
	// if ($menu == 'T') {
	// 	include_once '../includes/topmenu/footer.php';
	// } else {
	// 	include_once '../includes/oldDesign/footer.php';
	// }

	#######################
	// --- Sticky Pagination Footer ---

if ($page_display) {
	
	?>
     <style>
		 html, body {
			overflow-y: hidden !important;
		}
		/* .datatable, #datatable-wrapper {
			height: 100vh !important;
		}  */
		 #datatable-wrapper {
			height: 100vh !important;
		} 

		.dropdown {
			display: none;
		}
	
	</style>
	<?php
}


if($page_display){ #20251213
		
?>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // PHP-injected variables
    const tjek = <?php echo isset($tjek) ? json_encode($tjek) : '""'; ?>;
    const kladde_id = <?php echo isset($kladde_id) ? json_encode($kladde_id) : '""'; ?>;

    // All action buttons
    const buttonRows = [
        { rowId: 'kopierButtonRow', buttonId: 'kopier-button', name: 'copy2new' },
        { rowId: '', buttonId: 'revert-button', name: 'revert' },
        { rowId: '', buttonId: 'cancelSimulation-button', name: 'cancelSimulation' },
        { rowId: '', buttonId: 'save-button', name: 'save' },
        { rowId: '', buttonId: 'lookup-button', name: 'lookup' },
        { rowId: '', buttonId: 'simulate-button', name: 'simulate' },
        { rowId: '', buttonId: 'doPost-button', name: 'doPost' },
        { rowId: '', buttonId: 'upload-button', name: 'upload' },
        { rowId: '', buttonId: 'submitDocuBizz-button', name: 'submit' },
        { rowId: '', buttonId: 'import-button', name: 'import' },
        { rowId: '', buttonId: 'offset-button', name: 'offset' }
    ];

    const actionButtonsCenter = document.querySelector('.fixedFooter .action-buttons-center');

    buttonRows.forEach(({ rowId, buttonId, name }) => {
        const button = document.getElementById(buttonId);
        const buttonRow = rowId ? document.getElementById(rowId) : null;

        if (button && actionButtonsCenter) {
            // Hide the original row (if it exists)
            if (buttonRow) buttonRow.style.display = 'none';

            // Clone the button
            const clonedButton = button.cloneNode(true);
            clonedButton.name = name;
            actionButtonsCenter.appendChild(clonedButton);

            // Attach click listener
            clonedButton.addEventListener('click', function(event) {
                const form = document.getElementById('kassekladde');
                if (!form) return;

                // Add the button action itself as hidden
                const hiddenButtonInput = document.createElement('input');
                hiddenButtonInput.type = 'hidden';
                hiddenButtonInput.name = clonedButton.name;
                hiddenButtonInput.value = clonedButton.value || '';
                form.appendChild(hiddenButtonInput);

                // Add PHP variables tjek and kladde_id as hidden fields
                if (tjek) {
                    const tjekInput = document.createElement('input');
                    tjekInput.type = 'hidden';
                    tjekInput.name = 'tjek';
                    tjekInput.value = tjek;
                    form.appendChild(tjekInput);
                }

                if (kladde_id) {
                    const kladdeInput = document.createElement('input');
                    kladdeInput.type = 'hidden';
                    kladdeInput.name = 'kladde_id';
                    kladdeInput.value = kladde_id;
                    form.appendChild(kladdeInput);
                }

                // Submit the form
                form.submit();
            });
        }
    });
});
</script>

<?php
}



?>
<style>
	
/*scrollable container for the editable form */
.kassekladde-scroll-container {
    height: calc(100vh - 98px);
    overflow-y: auto;
    border: 1px solid #ddd;
    margin-bottom: 10px;
}

/* Sticky header inside the scroll container */
.kassekladde-scroll-container thead.kassekladde-thead {
    position: sticky;
    top: 0;
    z-index: 10;
	background-color: #ebebeb !important;
}
.datatable thead tr, .datatable thead th{
	background-color: #ebebeb !important;
}

/* Sticky footer outside the scroll container */
.kassekladde-footer {
    position: sticky;
    bottom: 0;
    background-color: #f1f1f1;
    z-index: 10;
    padding: 10px 0;
    border-top: 2px solid #ccc;
    margin-top: 10px;
}

/* Ensure proper table display */
.formnavi.dataTableForm{
    border-collapse: collapse;
    margin-bottom: 0;
}
.datatable thead, .datatable tfoot, .datatable tfoot tr, .datatable tfoot td{
	background-color: #ebebeb !important;
}

/* Make sure thead stays visible */
.formnavi.dataTableForm thead {
    position: sticky;
    top: 0;
}
 html, body {
			overflow-y: hidden !important;
		}


.duplicate-line-btn,
.delete-line-btn {
    border: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 12px;          /* adjust for the smaller circle */
    line-height: 18px;        /* centers the symbol vertically */
    text-align: center;
    cursor: pointer;
    padding: 0;
    margin-left: 5px;
}

/* Plus button styling */
.duplicate-line-btn {
    background-color: #4CAF50;
    color: white;
}

/* Delete button styling */
.delete-line-btn {
    background-color: #f44336;
    color: white;
}

/* Disabled delete button */
.delete-line-btn:disabled {
    background-color: #ccc;
    color: white;
    cursor: not-allowed;
}

</style>

<script>
window.addEventListener('DOMContentLoaded', function() {

    // -------------------------------
    // Kopier button logic 
    // -------------------------------
    const footerBox = document.getElementById('footer-box');
    const kopierButton = document.getElementById('kopier-button');

   if (kopierButton && footerBox) {
        const kopierRow = document.getElementById('kopierButtonRow');
        if (kopierRow) kopierRow.remove();
        
        // Create a NEW form for the kopier button
        const kopierForm = document.createElement('form');
        kopierForm.method = 'post';
        kopierForm.action = '../finans/kassekladde.php';
        kopierForm.style.cssText = 'margin: 0; padding: 0; display: inline;';
        
        // Clone all necessary hidden inputs from the original form
        const originalForm = document.getElementById('kassekladde');
        if (originalForm) {
            // Get kladde_id, tidspkt, and other hidden fields
            const kladdeIdInput = originalForm.querySelector('input[name="kladde_id"]');
            const tidspktInput = originalForm.querySelector('input[name="tidspkt"]');
            const kksortInput = document.querySelector('input[name="kksort"]') || 
                               document.createElement('input');
            
            // Clone or create these inputs for the new form
            if (kladdeIdInput) {
                const clone = kladdeIdInput.cloneNode(true);
                kopierForm.appendChild(clone);
            }
            
            if (tidspktInput) {
                const clone = tidspktInput.cloneNode(true);
                kopierForm.appendChild(clone);
            }
            
            // Add kksort if not already in form
            kksortInput.type = 'hidden';
            kksortInput.name = 'kksort';
            kksortInput.value = '<?php echo $kksort; ?>';
            kopierForm.appendChild(kksortInput);
        }
        
        // Clone the button and add it to the new form
        const clonedButton = kopierButton.cloneNode(true);
        clonedButton.name = 'copy2new';
       
        
        // Remove any existing onclick handlers and add this
        clonedButton.onclick = null;
        clonedButton.addEventListener('click', function(e) {
            // Submit our specific form
            kopierForm.submit();
            return false;
        });
        
        kopierForm.appendChild(clonedButton);
        
        // Style and position the form container
        kopierForm.style.cssText = `
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            padding: 0;
            margin: 0;
            background: transparent;
            border: none;
        `;
        
        // Ensure footer box has proper positioning
        footerBox.style.position = 'relative';
        footerBox.style.display = 'flex';
        footerBox.style.justifyContent = 'flex-end';
        footerBox.style.alignItems = 'center';
        
        // Add the new form to footer
        footerBox.appendChild(kopierForm);
    } else {
        console.log('Footer box or kopier button not found');
    }

    // -------------------------------
    // Select auto-submit using dynamic wrapper
    // -------------------------------

    // Find wrapper dynamically
    const wrapper = document.querySelector('[id^="datatable-wrapper-kassekladde_"]');
    if (!wrapper) {
        console.log('Wrapper not found');
        return;
    }

    // Get the form inside wrapper
    const form = wrapper.querySelector('form') || wrapper.closest('form');
    if (!form) {
        console.log('Form not found inside wrapper');
        return;
    }

    // Find all selects inside wrapper
    const selects = wrapper.querySelectorAll('select');
    if (!selects.length) {
        console.log('No selects found inside wrapper');
        return;
    }

    selects.forEach(select => {
        select.addEventListener('change', function() {
            
            let brugernavn = select.name.split('_').pop().replace(']', '');
            const params = new URLSearchParams(window.location.search);
            params.set(select.name, select.value);
            params.set('brugernavn', brugernavn);

            const newUrl = window.location.pathname + '?' + params.toString();
            
            window.location.href = newUrl;
        });
    });

  

});

// Duplicate line functionality

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('duplicate-line-btn') || e.target.closest('.duplicate-line-btn')) {
        const button = e.target.classList.contains('duplicate-line-btn') ? e.target : e.target.closest('.duplicate-line-btn');
        const sourceId = button.getAttribute('data-id');
        const kladdeId = document.querySelector('[name="kladde_id"]').value;
        
        if (!sourceId) {
            alert('No source_id found for this line');
            return;
        }
        
        console.log('Duplicating line with source_id:', sourceId, 'kladde_id:', kladdeId);
        
        // Create FormData to send via AJAX
        const formData = new FormData();
        formData.append('action', 'duplicate_line');
        formData.append('kladde_id', kladdeId);
        formData.append('source_id', sourceId);
        
        // Show loading indicator
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '⏳';
        
        // Send AJAX request to kassekladde.php itself
        fetch('kassekladde.php', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            return response.text();
        })
        .then(text => {
            // Try to parse as JSON
            try {
                const data = JSON.parse(text);
                if (data.success) {
                    // Reload the page to show the duplicated line
                    window.location.reload();
                } else {
                    alert('Fejl: ' + (data.message || 'Ukendt fejl'));
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
            } catch (e) {
                
                if (text.includes('<html') || text.includes('<!DOCTYPE')) {
					 window.location.reload();
                } else if (text.includes('Fatal error') || text.includes('Warning') || text.includes('Notice')) {
                    alert('PHP error detected: ' + text.substring(0, 200));
                } else {
                    alert('Invalid response from server: ' + text.substring(0, 200));
                }
                
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('Network error: ' + error.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
    }
});
// Delete line functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-line-btn') && !e.target.disabled) {
        const row = e.target.getAttribute('data-row');
        const bilagField = document.querySelector(`[name="bila${row}"]`);
        
        if (confirm('Are you sure you want to delete this line?')) {
            // Set bilag to '-' to mark for deletion
            bilagField.value = '-';
            
            // Submit the form
            document.getElementById('kassekladde').submit();
        }
    }
});


</script>




<?php


	########################

	$steps = array();
	$steps[] = array(
		"selector" => "#clip",
		"content" => findtekst('2600|Her kan du tilføje bilag til kladden', $sprog_id).".",
	);
	$steps[] = array(
		"selector" => "#undo",
		"content" => findtekst('2601|"Klik her for at tilbageføre denne postering som en ompostering i en åben kassekladde', $sprog_id).".",
	);
	$steps[] = array(
		"selector" => "#questionmark",
		"content" => findtekst('2602|Klik her for yderligere hjælp', $sprog_id).".",
	);
	$steps[] = array(
		"selector" => "[name^=debe], [name^=kred]",
		"content" => findtekst('2603|Du kan slå op i Debet/Kredit-felterne: Hvis D/K-feltet er tomt eller indeholder \'F\', søger systemet i kontoplanen. Hvis feltet viser \'D\' (debitor) eller \'K\' (kreditor), søges der i henholdsvis kunder eller leverandører.', $sprog_id) ."<br>".
					 findtekst('2604|Du kan også selv skrive \'D\' eller \'K\' for at vælge, hvor der skal søges. Når du begynder at skrive et navn eller kontonummer, vises der kun relevante forslag.', $sprog_id),
	);
	$steps[] = array(
		"selector" => "[name^=fakt]",
		"content" => findtekst('2605|Her kan du tilføje et fakturanummer til bilaget. Du kan også slå op i ikke-udlignede fakturaer ved at klikke på knappen \'Opslag\' i bunden, mens feltet er markeret', $sprog_id),
	);
	$steps[] = array(
		"selector" => "[name=bila1]",
		"content" => findtekst('2606|Du kan slette linjen ved at skrive \'-\' i feltet i stedet for et tal og trykke Enter', $sprog_id).".",
	);

	
	include(__DIR__ . "/../includes/tutorial.php");
	create_tutorial("kasseklad", $steps);


include("kassekladde_includes/drag-handle-ajax-call.php");
include("kassekladde_includes/unsavedWarning.php");


###############dropdown date select
print "<script>
document.addEventListener('DOMContentLoaded', function() {
  const brugernavn = " . json_encode($brugernavn) . ";
  
  const kassekladdeInput = document.querySelector(
    \"input[name='search[kass_\" + brugernavn + \"][transdate]']\"
  );
   const forfaldsdateInput = document.querySelector(
    \"input[name='search[kass_\" + brugernavn + \"][forfaldsdate]']\"
  );

    // Function to initialize a single datepicker
    function initDatepicker(input) {
        if (!input) return;
        
        // Get existing value if any
        var existingValue = input.value.trim();
        var startDate = moment(); // Default to today
        
        // Parse existing value if it exists
        if (existingValue !== '') {
            var parsed = moment(existingValue, 'DD-MM-YYYY', true);
            if (parsed.isValid()) {
                startDate = parsed;
            }
        }
        
        // Initialize daterangepicker
        $(input).daterangepicker({
            singleDatePicker: true,
            showDropdowns: true,
            autoUpdateInput: false,
            autoApply: false,
            startDate: startDate,
            minYear: 1900,
            maxYear: parseInt(moment().format('YYYY'), 10) + 10,
            locale: {
                format: 'DD-MM-YYYY',
                cancelLabel: '".findtekst('2117|Ryd', $sprog_id)."',
                applyLabel: '".findtekst('913|Søg', $sprog_id)."',
                daysOfWeek: ['Sø', 'Ma', 'Ti', 'On', 'To', 'Fr', 'Lø'],
                monthNames: ['Januar', 'Februar', 'Marts', 'April', 'Maj', 'Juni', 
                             'Juli', 'August', 'September', 'Oktober', 'November', 'December'],
                firstDay: 1
            }
        });
        
        // Set initial value if exists
        if (existingValue !== '') {
            $(input).val(existingValue);
        }
        
        // Show date in field immediately when date is selected from calendar
        $(input).on('show.daterangepicker', function(ev, picker) {
            // Update field when date changes in the picker
            picker.container.find('.calendar-table').off('click.updateField').on('click.updateField', 'td.available', function() {
                setTimeout(function() {
                    var selectedDate = picker.startDate.format('DD-MM-YYYY');
                    $(input).val(selectedDate);
                }, 10);
            });
        });
        
        // When user clicks \"Søg\" (Apply/Search) button - submit the form
        $(input).on('apply.daterangepicker', function(ev, picker) {
            var selectedDate = picker.startDate.format('DD-MM-YYYY');
            $(this).val(selectedDate);
            
            // Submit the form
            var form = $(this).closest('form');
            if (form.length > 0) {
                form.submit();
            }
        });
        
        // When user clicks \"Ryd\" (Clear/Cancel) button
        $(input).on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
            
            // Submit form to clear the filter
            var form = $(this).closest('form');
            if (form.length > 0) {
                form.submit();
            }
        });
    }
    
   
    initDatepicker(kassekladdeInput);
	initDatepicker(forfaldsdateInput);
   
   
});
</script>";



// Add clip drag-and-drop JavaScript for linking documents between lines
print "
<style>
/* Clip drag and drop styles */
.clip-cell {
	/* transition: all 0.2s ease; Removed to prevent drag flicker */
}
.clip-cell.drag-over {
	background-color: #d4edda !important;
	box-shadow: inset 0 0 8px rgba(40, 167, 69, 0.5);
	/* transform: scale(1.1); Removed to prevent drag flicker */
}
.clip-cell.drag-over-invalid {
	background-color: #f8d7da !important;
}
.clip-icon[draggable='true'] {
	cursor: grab !important;
}
.clip-icon[draggable='true']:active {
	cursor: grabbing !important;
}
.clip-icon.dragging {
	opacity: 0.5;
}
</style>

<script>
// Clip drag and drop for linking documents between kassekladde lines
let clipDragSourceId = null;
let clipDragSourceBilag = null;

function clipDragStart(event, sourceId, sourceBilag) {
	console.log('clipDragStart called - sourceId:', sourceId, 'sourceBilag:', sourceBilag);
	clipDragSourceId = sourceId;
	clipDragSourceBilag = sourceBilag;
	
	// Use JSON in text/plain for reliability across platforms
	const dragData = JSON.stringify({
		sourceId: sourceId,
		sourceBilag: sourceBilag
	});
	console.log('clipDragStart - setting dragData:', dragData);
	event.dataTransfer.setData('text/plain', dragData);
	
	// Keep text/bilag just in case, but text/plain JSON is primary
	event.dataTransfer.setData('text/bilag', sourceBilag);
	event.dataTransfer.effectAllowed = 'link';
	console.log('clipDragStart - dataTransfer set. text/plain:', event.dataTransfer.getData('text/plain'), 'text/bilag:', event.dataTransfer.getData('text/bilag'));
	
	// Add visual feedback
	event.target.classList.add('dragging');
	console.log('clipDragStart - added dragging class to:', event.target);
	
	// Add drag image
	const dragImage = event.target.cloneNode(true);
	dragImage.style.width = '30px';
	dragImage.style.height = '30px';
	document.body.appendChild(dragImage);
	event.dataTransfer.setDragImage(dragImage, 15, 15);
	setTimeout(() => dragImage.remove(), 0);
}

function clipDragOver(event) {
	event.preventDefault();
	event.dataTransfer.dropEffect = 'link';
	
	// Find the clip cell
	const cell = event.target.closest('.clip-cell');
	if (cell) {
		const targetId = cell.dataset.sourceId;
		const targetBilag = cell.dataset.bilag;
		console.log('clipDragOver - targetId:', targetId, 'targetBilag:', targetBilag, 'sourceId:', clipDragSourceId);
		// Don't allow dropping on itself
		if (targetId == clipDragSourceId) {
			cell.classList.add('drag-over-invalid');
			cell.classList.remove('drag-over');
		} else {
			cell.classList.add('drag-over');
			cell.classList.remove('drag-over-invalid');
		}
	}
}

function clipDragLeave(event) {
	const cell = event.target.closest('.clip-cell');
	if (cell) {
		// Prevent firing when moving to a child element
		if (event.relatedTarget && cell.contains(event.relatedTarget)) {
			return;
		}
		console.log('clipDragLeave - leaving cell:', cell.dataset.sourceId);
		cell.classList.remove('drag-over', 'drag-over-invalid');
	}
}

function clipDrop(event, targetSourceId, targetBilag) {
	console.log('clipDrop called - targetSourceId:', targetSourceId, 'targetBilag:', targetBilag);
	event.preventDefault();
	
	const cell = event.target.closest('.clip-cell');
	if (cell) {
		cell.classList.remove('drag-over', 'drag-over-invalid');
	}
	
	let sourceId = null;
	let sourceBilag = null;
	
	// Try parsing JSON from text/plain
	try {
		const rawData = event.dataTransfer.getData('text/plain');
		console.log('clipDrop - rawData from text/plain:', rawData);
		
		if (rawData && rawData.startsWith('{')) {
			const data = JSON.parse(rawData);
			console.log('clipDrop - parsed JSON:', data);
			sourceId = data.sourceId;
			sourceBilag = data.sourceBilag;
		} else {
			// Fallback for simple ID if needed
			console.log('clipDrop - rawData is not JSON, treating as ID');
			sourceId = rawData;
		}
	} catch (e) {
		console.error('Drag drop parse error', e);
		sourceId = event.dataTransfer.getData('text/plain');
	}

	// Fallback to globals or text/bilag
	if (!sourceBilag) {
		console.log('clipDrop - sourceBilag missing, checking text/bilag');
		sourceBilag = event.dataTransfer.getData('text/bilag');
	}
	if (!sourceId) { 
		console.log('clipDrop - sourceId missing, using global fallback:', clipDragSourceId);
		sourceId = clipDragSourceId;
	}
	if (!sourceBilag) {
		console.log('clipDrop - sourceBilag missing, using global fallback:', clipDragSourceBilag);
		sourceBilag = clipDragSourceBilag;
	}
	
	console.log('clipDrop FINAL - sourceId:', sourceId, 'sourceBilag:', sourceBilag);
	
	// Don't link to itself
	if (sourceId == targetSourceId) {
		console.log('clipDrop - cannot link to itself, returning');
		return;
	}
	
	// Confirm the action - show bilag numbers instead of line IDs
	console.log('clipDrop - showing confirm dialog for bilag', sourceBilag, 'to', targetBilag);
	if (!confirm('Link bilag fra bilag ' + sourceBilag + ' til bilag ' + targetBilag + '?')) {
		console.log('clipDrop - user cancelled');
		return;
	}
	
	console.log('clipDrop - user confirmed, calling linkDocumentsBetweenLines');
	// Make AJAX call to link documents
	linkDocumentsBetweenLines(sourceId, targetSourceId);
}

function linkDocumentsBetweenLines(fromSourceId, toSourceId) {
console.log('Linking:', fromSourceId, 'to', toSourceId);
	const formData = new FormData();
	formData.append('action', 'linkDocuments');
	formData.append('fromSourceId', fromSourceId);
	formData.append('toSourceId', toSourceId);
	formData.append('source', 'kassekladde');
	
	fetch('../includes/docsIncludes/linkDocumentsApi.php', {
		method: 'POST',
		body: formData
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			alert('Bilag linket succesfuldt! (' + data.count + ' dokument(er))');
			// Refresh the page to show updated document links
			location.reload();
		} else {
			alert('Fejl: ' + (data.message || 'Kunne ikke linke bilag'));
		}
	})
	.catch(error => {
		console.error('Error linking documents:', error);
		alert('Fejl ved linking af bilag: ' + error.message);
	});
}

// Add dragend handler to clean up
document.addEventListener('dragend', function(event) {
	if (event.target.classList) {
		event.target.classList.remove('dragging');
	}
	// Remove all drag-over classes
	document.querySelectorAll('.clip-cell').forEach(cell => {
		cell.classList.remove('drag-over', 'drag-over-invalid');
	});
	
	// Delay cleanup to ensure drop handler has time to read the values
	setTimeout(() => {
		clipDragSourceId = null;
		clipDragSourceBilag = null;
	}, 100);
});

// Setup drag and drop event listeners programmatically (works better in Chrome than inline handlers)
document.addEventListener('DOMContentLoaded', function() {
	// Use event delegation for better performance with dynamic content
	document.addEventListener('dragover', function(e) {
		const cell = e.target.closest('.clip-cell');
		if (cell) {
			e.preventDefault(); // MUST be here for drop to work in Chrome
			e.stopPropagation();
			clipDragOver(e);
		}
	});
	
	document.addEventListener('drop', function(e) {
		console.log('DROP EVENT CAPTURED at document level - target:', e.target);
		const cell = e.target.closest('.clip-cell');
		console.log('DROP - closest clip-cell:', cell);
		if (cell) {
			const targetId = cell.dataset.sourceId;
			const targetBilag = cell.dataset.bilag;
			console.log('DROP - calling clipDrop with targetId:', targetId, 'targetBilag:', targetBilag);
			clipDrop(e, targetId, targetBilag);
		} else {
			console.log('DROP - no clip-cell found, preventing default anyway');
			e.preventDefault();
		}
	});
	
	document.addEventListener('dragleave', function(e) {
		const cell = e.target.closest('.clip-cell');
		if (cell) {
			clipDragLeave(e);
		}
	});
	
	// Initialize account autocomplete after page is fully loaded
	if (typeof window.initAccountAutocomplete === 'function') {
		console.log('Calling initAccountAutocomplete from kassekladde.php');
		window.initAccountAutocomplete();
	}
	
	// Initialize datepicker on all date fields
	$('input[name^=\"dato\"]').datepickerDa();
	// Initialize datepicker on Due Date fields
	$('input[name^=\"forf\"]').datepickerDa();
});
</script>
";

	?>





